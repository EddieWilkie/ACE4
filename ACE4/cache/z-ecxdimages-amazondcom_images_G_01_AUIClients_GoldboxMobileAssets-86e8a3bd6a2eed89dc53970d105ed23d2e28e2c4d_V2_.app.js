(function(n,k,m){n.execute(function(){typeof JSON!=="object"&&(JSON={});(function(){function i(a){return a<10?"0"+a:a}function f(d){a.lastIndex=0;return a.test(d)?'"'+d.replace(a,function(a){var d=g[a];return typeof d==="string"?d:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+d+'"'}function c(a,b){var g,i,k,s,n=d,m,q=b[a];q&&typeof q==="object"&&typeof q.toJSON==="function"&&(q=q.toJSON(a));typeof h==="function"&&(q=h.call(b,a,q));switch(typeof q){case "string":return f(q);case "number":return isFinite(q)?String(q):"null";case "boolean":case "null":return String(q);case "object":if(!q)return"null";d+=e;m=[];if(Object.prototype.toString.apply(q)==="[object Array]"){s=q.length;for(g=0;g<s;g+=1)m[g]=c(g,q)||"null";k=m.length===0?"[]":d?"[\n"+d+m.join(",\n"+d)+"\n"+n+"]":"["+m.join(",")+"]";d=n;return k}if(h&&typeof h==="object"){s=h.length;for(g=0;g<s;g+=1)typeof h[g]==="string"&&(i=h[g],(k=c(i,q))&&m.push(f(i)+(d?": ":":")+k))}else for(i in q)Object.prototype.hasOwnProperty.call(q,i)&&(k=c(i,q))&&m.push(f(i)+(d?": ":":")+k);k=m.length===0?"{}":d?"{\n"+d+m.join(",\n"+d)+"\n"+n+"}":"{"+m.join(",")+"}";d=n;return k}}if(typeof Date.prototype.toJSON!=="function")Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+i(this.getUTCMonth()+1)+"-"+i(this.getUTCDate())+"T"+i(this.getUTCHours())+":"+i(this.getUTCMinutes())+":"+i(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()};var b,a,d,e,g,h;if(typeof JSON.stringify!=="function")a=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,g={"":"\\b","\t":"\\t","\n":"\\n","":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},JSON.stringify=function(a,b,g){var f;e=d="";if(typeof g==="number")for(f=0;f<g;f+=1)e+=" ";else typeof g==="string"&&(e=g);if((h=b)&&typeof b!=="function"&&(typeof b!=="object"||typeof b.length!=="number"))throw Error("JSON.stringify");return c("",{"":a})};if(typeof JSON.parse!=="function")b=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,JSON.parse=function(a,d){function c(a,b){var e,g,h=a[b];if(h&&typeof h==="object")for(e in h)Object.prototype.hasOwnProperty.call(h,e)&&(g=c(h,e),g!==m?h[e]=g:delete h[e]);return d.call(a,b,h)}var e,a=String(a);b.lastIndex=0;b.test(a)&&(a=a.replace(b,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)}));if(/^[\],:{}\s]*$/.test(a.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return e=eval("("+a+")"),typeof d==="function"?c({"":e},""):e;throw new SyntaxError("JSON.parse");}})();(function(){var i=this,f=i._,c={},b=Array.prototype,a=Object.prototype,d=b.push,e=b.slice,g=b.concat,h=a.toString,l=a.hasOwnProperty,p=b.forEach,v=b.map,k=b.reduce,o=b.reduceRight,s=b.filter,m=b.every,n=b.some,q=b.indexOf,D=b.lastIndexOf,a=Array.isArray,I=Object.keys,F=Function.prototype.bind,j=function(a){if(a instanceof j)return a;if(!(this instanceof j))return new j(a);this._wrapped=a};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports)exports=module.exports=j;exports._=j}else i._=j;j.VERSION="1.5.2";var t=j.each=j.forEach=function(a,d,b){if(a!=null)if(p&&a.forEach===p)a.forEach(d,b);else if(a.length===+a.length)for(var e=0,g=a.length;e<g;e++){if(d.call(b,a[e],e,a)===c)break}else for(var h=j.keys(a),e=0,g=h.length;e<g;e++)if(d.call(b,a[h[e]],h[e],a)===c)break};j.map=j.collect=function(a,d,b){var c=[];if(a==null)return c;if(v&&a.map===v)return a.map(d,b);t(a,function(a,e,g){c.push(d.call(b,a,e,g))});return c};j.reduce=j.foldl=j.inject=function(a,d,b,c){var e=arguments.length>2;a==null&&(a=[]);if(k&&a.reduce===k)return c&&(d=j.bind(d,c)),e?a.reduce(d,b):a.reduce(d);t(a,function(a,g,h){e?b=d.call(c,b,a,g,h):(b=a,e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return b};j.reduceRight=j.foldr=function(a,d,b,c){var e=arguments.length>2;a==null&&(a=[]);if(o&&a.reduceRight===o)return c&&(d=j.bind(d,c)),e?a.reduceRight(d,b):a.reduceRight(d);var g=a.length;if(g!==+g)var h=j.keys(a),g=h.length;t(a,function(l,f,p){f=h?h[--g]:--g;e?b=d.call(c,b,a[f],f,p):(b=a[f],e=!0)});if(!e)throw new TypeError("Reduce of empty array with no initial value");return b};j.find=j.detect=function(a,d,b){var c;z(a,function(a,e,g){if(d.call(b,a,e,g))return c=a,!0});return c};j.filter=j.select=function(a,d,b){var c=[];if(a==null)return c;if(s&&a.filter===s)return a.filter(d,b);t(a,function(a,e,g){d.call(b,a,e,g)&&c.push(a)});return c};j.reject=function(a,d,b){return j.filter(a,function(a,c,e){return!d.call(b,a,c,e)},b)};j.every=j.all=function(a,d,b){d||(d=j.identity);var e=!0;if(a==null)return e;if(m&&a.every===m)return a.every(d,b);t(a,function(a,g,h){if(!(e=e&&d.call(b,a,g,h)))return c});return!!e};var z=j.some=j.any=function(a,d,b){d||(d=j.identity);var e=!1;if(a==null)return e;if(n&&a.some===n)return a.some(d,b);t(a,function(a,g,h){if(e||(e=d.call(b,a,g,h)))return c});return!!e};j.contains=j.include=function(a,d){return a==null?!1:q&&a.indexOf===q?a.indexOf(d)!=-1:z(a,function(a){return a===d})};j.invoke=function(a,d){var b=e.call(arguments,2),c=j.isFunction(d);return j.map(a,function(a){return(c?d:a[d]).apply(a,b)})};j.pluck=function(a,d){return j.map(a,function(a){return a[d]})};j.where=function(a,d,b){return j.isEmpty(d)?b?void 0:[]:j[b?"find":"filter"](a,function(a){for(var b in d)if(d[b]!==a[b])return!1;return!0})};j.findWhere=function(a,d){return j.where(a,d,!0)};j.max=function(a,d,b){if(!d&&j.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.max.apply(Math,a);if(!d&&j.isEmpty(a))return-Infinity;var c={computed:-Infinity,value:-Infinity};t(a,function(a,e,g){e=d?d.call(b,a,e,g):a;e>c.computed&&(c={value:a,computed:e})});return c.value};j.min=function(a,d,b){if(!d&&j.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.min.apply(Math,a);if(!d&&j.isEmpty(a))return Infinity;var c={computed:Infinity,value:Infinity};t(a,function(a,e,g){e=d?d.call(b,a,e,g):a;e<c.computed&&(c={value:a,computed:e})});return c.value};j.shuffle=function(a){var d,b=0,c=[];t(a,function(a){d=j.random(b++);c[b-1]=c[d];c[d]=a});return c};j.sample=function(a,d,b){return arguments.length<2||b?a[j.random(a.length-1)]:j.shuffle(a).slice(0,Math.max(0,d))};var E=function(a){return j.isFunction(a)?a:function(d){return d[a]}};j.sortBy=function(a,d,b){var c=E(d);return j.pluck(j.map(a,function(a,d,e){return{value:a,index:d,criteria:c.call(b,a,d,e)}}).sort(function(a,d){var b=a.criteria,c=d.criteria;if(b!==c){if(b>c||b===void 0)return 1;if(b<c||c===void 0)return-1}return a.index-d.index}),"value")};var G=function(a){return function(d,b,c){var e={},g=b==null?j.identity:E(b);t(d,function(b,h){var l=g.call(c,b,h,d);a(e,l,b)});return e}};j.groupBy=G(function(a,d,b){(j.has(a,d)?a[d]:a[d]=[]).push(b)});j.indexBy=G(function(a,d,b){a[d]=b});j.countBy=G(function(a,d){j.has(a,d)?a[d]++:a[d]=1});j.sortedIndex=function(a,d,b,c){for(var b=b==null?j.identity:E(b),d=b.call(c,d),e=0,g=a.length;e<g;){var h=e+g>>>1;b.call(c,a[h])<d?e=h+1:g=h}return e};j.toArray=function(a){return!a?[]:j.isArray(a)?e.call(a):a.length===+a.length?j.map(a,j.identity):j.values(a)};j.size=function(a){return a==null?0:a.length===+a.length?a.length:j.keys(a).length};j.first=j.head=j.take=function(a,d,b){return a==null?void 0:d==null||b?a[0]:e.call(a,0,d)};j.initial=function(a,d,b){return e.call(a,0,a.length-(d==null||b?1:d))};j.last=function(a,d,b){return a==null?void 0:d==null||b?a[a.length-1]:e.call(a,Math.max(a.length-d,0))};j.rest=j.tail=j.drop=function(a,d,b){return e.call(a,d==null||b?1:d)};j.compact=function(a){return j.filter(a,j.identity)};var H=function(a,b,c){if(b&&j.every(a,j.isArray))return g.apply(c,a);t(a,function(a){j.isArray(a)||j.isArguments(a)?b?d.apply(c,a):H(a,b,c):c.push(a)});return c};j.flatten=function(a,d){return H(a,d,[])};j.without=function(a){return j.difference(a,e.call(arguments,1))};j.uniq=j.unique=function(a,d,b,c){j.isFunction(d)&&(c=b,b=d,d=!1);var b=b?j.map(a,b,c):a,e=[],g=[];t(b,function(b,c){if(d?!c||g[g.length-1]!==b:!j.contains(g,b))g.push(b),e.push(a[c])});return e};j.union=function(){return j.uniq(j.flatten(arguments,!0))};j.intersection=function(a){var d=e.call(arguments,1);return j.filter(j.uniq(a),function(a){return j.every(d,function(d){return j.indexOf(d,a)>=0})})};j.difference=function(a){var d=g.apply(b,e.call(arguments,1));return j.filter(a,function(a){return!j.contains(d,a)})};j.zip=function(){for(var a=j.max(j.pluck(arguments,"length").concat(0)),d=Array(a),b=0;b<a;b++)d[b]=j.pluck(arguments,""+b);return d};j.object=function(a,d){if(a==null)return{};for(var b={},c=0,e=a.length;c<e;c++)d?b[a[c]]=d[c]:b[a[c][0]]=a[c][1];return b};j.indexOf=function(a,d,b){if(a==null)return-1;var c=0,e=a.length;if(b)if(typeof b=="number")c=b<0?Math.max(0,e+b):b;else return c=j.sortedIndex(a,d),a[c]===d?c:-1;if(q&&a.indexOf===q)return a.indexOf(d,b);for(;c<e;c++)if(a[c]===d)return c;return-1};j.lastIndexOf=function(a,d,b){if(a==null)return-1;var c=b!=null;if(D&&a.lastIndexOf===D)return c?a.lastIndexOf(d,b):a.lastIndexOf(d);for(b=c?b:a.length;b--;)if(a[b]===d)return b;return-1};j.range=function(a,d,b){arguments.length<=1&&(d=a||0,a=0);for(var b=arguments[2]||1,c=Math.max(Math.ceil((d-a)/b),0),e=0,g=Array(c);e<c;)g[e++]=a,a+=b;return g};var w=function(){};j.bind=function(a,d){var b,c;if(F&&a.bind===F)return F.apply(a,e.call(arguments,1));if(!j.isFunction(a))throw new TypeError;b=e.call(arguments,2);return c=function(){if(!(this instanceof c))return a.apply(d,b.concat(e.call(arguments)));w.prototype=a.prototype;var g=new w;w.prototype=null;var h=a.apply(g,b.concat(e.call(arguments)));return Object(h)===h?h:g}};j.partial=function(a){var d=e.call(arguments,1);return function(){return a.apply(this,d.concat(e.call(arguments)))}};j.bindAll=function(a){var d=e.call(arguments,1);if(d.length===0)throw Error("bindAll must be passed function names");t(d,function(d){a[d]=j.bind(a[d],a)});return a};j.memoize=function(a,d){var b={};d||(d=j.identity);return function(){var c=d.apply(this,arguments);return j.has(b,c)?b[c]:b[c]=a.apply(this,arguments)}};j.delay=function(a,d){var b=e.call(arguments,2);return setTimeout(function(){return a.apply(null,b)},d)};j.defer=function(a){return j.delay.apply(j,[a,1].concat(e.call(arguments,1)))};j.throttle=function(a,d,b){var c,e,g,h=null,l=0;b||(b={});var f=function(){l=b.leading===!1?0:new Date;h=null;g=a.apply(c,e)};return function(){var p=new Date;!l&&b.leading===!1&&(l=p);var j=d-(p-l);c=this;e=arguments;j<=0?(clearTimeout(h),h=null,l=p,g=a.apply(c,e)):!h&&b.trailing!==!1&&(h=setTimeout(f,j));return g}};j.debounce=function(a,d,b){var c,e,g,h,l;return function(){g=this;e=arguments;h=new Date;var f=function(){var p=new Date-h;p<d?c=setTimeout(f,d-p):(c=null,b||(l=a.apply(g,e)))},p=b&&!c;c||(c=setTimeout(f,d));p&&(l=a.apply(g,e));return l}};j.once=function(a){var d=!1,b;return function(){if(d)return b;d=!0;b=a.apply(this,arguments);a=null;return b}};j.wrap=function(a,b){return function(){var c=[a];d.apply(c,arguments);return b.apply(this,c)}};j.compose=function(){var a=arguments;return function(){for(var d=arguments,b=a.length-1;b>=0;b--)d=[a[b].apply(this,d)];return d[0]}};j.after=function(a,d){return function(){if(--a<1)return d.apply(this,arguments)}};j.keys=I||function(a){if(a!==Object(a))throw new TypeError("Invalid object");var d=[],b;for(b in a)j.has(a,b)&&d.push(b);return d};j.values=function(a){for(var d=j.keys(a),b=d.length,c=Array(b),e=0;e<b;e++)c[e]=a[d[e]];return c};j.pairs=function(a){for(var d=j.keys(a),b=d.length,c=Array(b),e=0;e<b;e++)c[e]=[d[e],a[d[e]]];return c};j.invert=function(a){for(var d={},b=j.keys(a),c=0,e=b.length;c<e;c++)d[a[b[c]]]=b[c];return d};j.functions=j.methods=function(a){var d=[],b;for(b in a)j.isFunction(a[b])&&d.push(b);return d.sort()};j.extend=function(a){t(e.call(arguments,1),function(d){if(d)for(var b in d)a[b]=d[b]});return a};j.pick=function(a){var d={},c=g.apply(b,e.call(arguments,1));t(c,function(b){b in a&&(d[b]=a[b])});return d};j.omit=function(a){var d={},c=g.apply(b,e.call(arguments,1)),h;for(h in a)j.contains(c,h)||(d[h]=a[h]);return d};j.defaults=function(a){t(e.call(arguments,1),function(d){if(d)for(var b in d)a[b]===void 0&&(a[b]=d[b])});return a};j.clone=function(a){return!j.isObject(a)?a:j.isArray(a)?a.slice():j.extend({},a)};j.tap=function(a,d){d(a);return a};var x=function(a,d,b,c){if(a===d)return a!==0||1/a==1/d;if(a==null||d==null)return a===d;if(a instanceof j)a=a._wrapped;if(d instanceof j)d=d._wrapped;var e=h.call(a);if(e!=h.call(d))return!1;switch(e){case "[object String]":return a==String(d);case "[object Number]":return a!=+a?d!=+d:a==0?1/a==1/d:a==+d;case "[object Date]":case "[object Boolean]":return+a==+d;case "[object RegExp]":return a.source==d.source&&a.global==d.global&&a.multiline==d.multiline&&a.ignoreCase==d.ignoreCase}if(typeof a!="object"||typeof d!="object")return!1;for(var g=b.length;g--;)if(b[g]==a)return c[g]==d;var g=a.constructor,l=d.constructor;if(g!==l&&(!j.isFunction(g)||!(g instanceof g&&j.isFunction(l)&&l instanceof l)))return!1;b.push(a);c.push(d);g=0;l=!0;if(e=="[object Array]"){if(g=a.length,l=g==d.length)for(;g--;)if(!(l=x(a[g],d[g],b,c)))break}else{for(var f in a)if(j.has(a,f)&&(g++,!(l=j.has(d,f)&&x(a[f],d[f],b,c))))break;if(l){for(f in d)if(j.has(d,f)&&!g--)break;l=!g}}b.pop();c.pop();return l};j.isEqual=function(a,d){return x(a,d,[],[])};j.isEmpty=function(a){if(a==null)return!0;if(j.isArray(a)||j.isString(a))return a.length===0;for(var d in a)if(j.has(a,d))return!1;return!0};j.isElement=function(a){return!!(a&&a.nodeType===1)};j.isArray=a||function(a){return h.call(a)=="[object Array]"};j.isObject=function(a){return a===Object(a)};t("Arguments,Function,String,Number,Date,RegExp".split(","),function(a){j["is"+a]=function(d){return h.call(d)=="[object "+a+"]"}});if(!j.isArguments(arguments))j.isArguments=function(a){return!(!a||!j.has(a,"callee"))};if(typeof/./!=="function")j.isFunction=function(a){return typeof a==="function"};j.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))};j.isNaN=function(a){return j.isNumber(a)&&a!=+a};j.isBoolean=function(a){return a===!0||a===!1||h.call(a)=="[object Boolean]"};j.isNull=function(a){return a===null};j.isUndefined=function(a){return a===void 0};j.has=function(a,d){return l.call(a,d)};j.noConflict=function(){i._=f;return this};j.identity=function(a){return a};j.times=function(a,d,b){for(var c=Array(Math.max(0,a)),e=0;e<a;e++)c[e]=d.call(b,e);return c};j.random=function(a,d){d==null&&(d=a,a=0);return a+Math.floor(Math.random()*(d-a+1))};var B={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};B.unescape=j.invert(B.escape);var A={escape:RegExp("["+j.keys(B.escape).join("")+"]","g"),unescape:RegExp("("+j.keys(B.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(a){j[a]=function(d){return d==null?"":(""+d).replace(A[a],function(d){return B[a][d]})}});j.result=function(a,d){if(a!=null){var b=a[d];return j.isFunction(b)?b.call(a):b}};j.mixin=function(a){t(j.functions(a),function(b){var c=j[b]=a[b];j.prototype[b]=function(){var a=[this._wrapped];d.apply(a,arguments);a=c.apply(j,a);return this._chain?j(a).chain():a}})};var C=0;j.uniqueId=function(a){var d=++C+"";return a?a+d:d};j.templateSettings={evaluate:/<~([\s\S]+?)~>/g,interpolate:/{{([\s\S]+?)}}/g,escape:/~{{([\s\S]+?)}}/g};var J=/(.)^/,L={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t"},M=/\\|'|\r|\n|\t/g,K=["u2028","u2029"];j.template=function(a,d,b){var c,b=j.defaults({},b,j.templateSettings),e=RegExp([(b.escape||J).source,(b.interpolate||J).source,(b.evaluate||J).source].join("|")+"|$","g"),g=0,h="__p+='";a.replace(e,function(d,b,c,e,l){h+=a.slice(g,l).replace(M,function(a){return"\\"+L[a]}).replace(/\u2028/g,"\\"+K[0]).replace(/\u2029/g,"\\"+K[1]);b&&(h+="'+\n((__t=("+b+"))==null?'':_.escape(__t))+\n'");c&&(h+="'+\n((__t=("+c+"))==null?'':__t)+\n'");e&&(h+="';\n"+e+"\n__p+='");g=l+d.length;return d});h+="';\n";b.variable||(h="with(obj||{}){\n"+h+"}\n");h="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+h+"return __p;\n";try{c=new Function(b.variable||"obj","_",h)}catch(l){throw l.source=h,l;}if(d)return c(d,j);d=function(a){return c.call(this,a,j)};d.source="function("+(b.variable||"obj")+"){\n"+h+"}";return d};j.chain=function(a){return j(a).chain()};j.mixin(j);t("pop,push,reverse,shift,sort,splice,unshift".split(","),function(a){var d=b[a];j.prototype[a]=function(){var b=this._wrapped;d.apply(b,arguments);(a=="shift"||a=="splice")&&b.length===0&&delete b[0];return this._chain?j(b).chain():b}});t(["concat","join","slice"],function(a){var d=b[a];j.prototype[a]=function(){var a=d.apply(this._wrapped,arguments);return this._chain?j(a).chain():a}});j.extend(j.prototype,{chain:function(){this._chain=!0;return this},value:function(){return this._wrapped}})}).call(this);(function(){var i=this,f=i.Backbone,c=[].slice,b;b=typeof exports!=="undefined"?exports:i.Backbone={};b.VERSION="1.1.0";var a=i._;!a&&typeof require!=="undefined"&&(a=require("underscore"));b.$=i.jQuery||i.Zepto||i.ender||i.$;b.noConflict=function(){i.Backbone=f;return this};b.emulateHTTP=!1;b.emulateJSON=!1;var d=b.Events={on:function(a,d,b){if(!g(this,"on",a,[d,b])||!d)return this;this._events||(this._events={});(this._events[a]||(this._events[a]=[])).push({callback:d,context:b,ctx:b||this});return this},once:function(d,b,c){if(!g(this,"once",d,[b,c])||!b)return this;var e=this,h=a.once(function(){e.off(d,h);b.apply(this,arguments)});h._callback=b;return this.on(d,h,c)},off:function(d,b,c){var e,h,l,f,p,j,i,v;if(!this._events||!g(this,"off",d,[b,c]))return this;if(!d&&!b&&!c)return this._events={},this;f=d?[d]:a.keys(this._events);for(p=0,j=f.length;p<j;p++)if(d=f[p],l=this._events[d]){this._events[d]=e=[];if(b||c)for(i=0,v=l.length;i<v;i++)h=l[i],(b&&b!==h.callback&&b!==h.callback._callback||c&&c!==h.context)&&e.push(h);e.length||delete this._events[d]}return this},trigger:function(a){if(!this._events)return this;var d=c.call(arguments,1);if(!g(this,"trigger",a,d))return this;var b=this._events[a],e=this._events.all;b&&h(b,d);e&&h(e,arguments);return this},stopListening:function(d,b,c){var e=this._listeningTo;if(!e)return this;var g=!b&&!c;!c&&typeof b==="object"&&(c=this);d&&((e={})[d._listenId]=d);for(var h in e)d=e[h],d.off(b,c,this),(g||a.isEmpty(d._events))&&delete this._listeningTo[h];return this}},e=/\s+/,g=function(a,d,b,c){if(!b)return!0;if(typeof b==="object"){for(var g in b)a[d].apply(a,[g,b[g]].concat(c));return!1}if(e.test(b)){b=b.split(e);g=0;for(var h=b.length;g<h;g++)a[d].apply(a,[b[g]].concat(c));return!1}return!0},h=function(a,d){var b,c=-1,e=a.length,g=d[0],h=d[1],l=d[2];switch(d.length){case 0:for(;++c<e;)(b=a[c]).callback.call(b.ctx);break;case 1:for(;++c<e;)(b=a[c]).callback.call(b.ctx,g);break;case 2:for(;++c<e;)(b=a[c]).callback.call(b.ctx,g,h);break;case 3:for(;++c<e;)(b=a[c]).callback.call(b.ctx,g,h,l);break;default:for(;++c<e;)(b=a[c]).callback.apply(b.ctx,d)}};a.each({listenTo:"on",listenToOnce:"once"},function(b,c){d[c]=function(d,c,e){var g=this._listeningTo||(this._listeningTo={}),h=d._listenId||(d._listenId=a.uniqueId("l"));g[h]=d;!e&&typeof c==="object"&&(e=this);d[b](c,e,this);return this}});d.bind=d.on;d.unbind=d.off;a.extend(b,d);var l=b.Model=function(d,b){var c=d||{};b||(b={});this.cid=a.uniqueId("c");this.attributes={};if(b.collection)this.collection=b.collection;b.parse&&(c=this.parse(c,b)||{});c=a.defaults({},c,a.result(this,"defaults"));this.set(c,b);this.changed={};this.initialize.apply(this,arguments)};a.extend(l.prototype,d,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return a.clone(this.attributes)},sync:function(){return b.sync.apply(this,arguments)},get:function(a){return this.attributes[a]},escape:function(d){return a.escape(this.get(d))},has:function(a){return this.get(a)!=null},set:function(d,b,c){var e,g,h,l,f,p,j;if(d==null)return this;typeof d==="object"?(g=d,c=b):(g={})[d]=b;c||(c={});if(!this._validate(g,c))return!1;h=c.unset;l=c.silent;d=[];f=this._changing;this._changing=!0;if(!f)this._previousAttributes=a.clone(this.attributes),this.changed={};j=this.attributes;p=this._previousAttributes;if(this.idAttribute in g)this.id=g[this.idAttribute];for(e in g)b=g[e],a.isEqual(j[e],b)||d.push(e),a.isEqual(p[e],b)?delete this.changed[e]:this.changed[e]=b,h?delete j[e]:j[e]=b;if(!l){if(d.length)this._pending=!0;b=0;for(e=d.length;b<e;b++)this.trigger("change:"+d[b],this,j[d[b]],c)}if(f)return this;if(!l)for(;this._pending;)this._pending=!1,this.trigger("change",this,c);this._changing=this._pending=!1;return this},unset:function(d,b){return this.set(d,void 0,a.extend({},b,{unset:!0}))},clear:function(d){var b={},c;for(c in this.attributes)b[c]=void 0;return this.set(b,a.extend({},d,{unset:!0}))},hasChanged:function(d){return d==null?!a.isEmpty(this.changed):a.has(this.changed,d)},changedAttributes:function(d){if(!d)return this.hasChanged()?a.clone(this.changed):!1;var b,c=!1,e=this._changing?this._previousAttributes:this.attributes,g;for(g in d)if(!a.isEqual(e[g],b=d[g]))(c||(c={}))[g]=b;return c},previous:function(a){return a==null||!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return a.clone(this._previousAttributes)},fetch:function(d){d=d?a.clone(d):{};if(d.parse===void 0)d.parse=!0;var b=this,c=d.success;d.success=function(a){if(!b.set(b.parse(a,d),d))return!1;c&&c(b,a,d);b.trigger("sync",b,a,d)};A(this,d);return this.sync("read",this,d)},save:function(d,b,c){var e,g=this.attributes;d==null||typeof d==="object"?(e=d,c=b):(e={})[d]=b;c=a.extend({validate:!0},c);if(e&&!c.wait){if(!this.set(e,c))return!1}else if(!this._validate(e,c))return!1;if(e&&c.wait)this.attributes=a.extend({},g,e);if(c.parse===void 0)c.parse=!0;var h=this,l=c.success;c.success=function(d){h.attributes=g;var b=h.parse(d,c);c.wait&&(b=a.extend(e||{},b));if(a.isObject(b)&&!h.set(b,c))return!1;l&&l(h,d,c);h.trigger("sync",h,d,c)};A(this,c);d=this.isNew()?"create":c.patch?"patch":"update";if(d==="patch")c.attrs=e;d=this.sync(d,this,c);if(e&&c.wait)this.attributes=g;return d},destroy:function(d){var d=d?a.clone(d):{},b=this,c=d.success,e=function(){b.trigger("destroy",b,b.collection,d)};d.success=function(a){(d.wait||b.isNew())&&e();c&&c(b,a,d);b.isNew()||b.trigger("sync",b,a,d)};if(this.isNew())return d.success(),!1;A(this,d);var g=this.sync("delete",this,d);d.wait||e();return g},url:function(){var d=a.result(this,"urlRoot")||a.result(this.collection,"url")||B();return this.isNew()?d:d+(d.charAt(d.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(a){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(d){return this._validate({},a.extend(d||{},{validate:!0}))},_validate:function(d,b){if(!b.validate||!this.validate)return!0;var d=a.extend({},this.attributes,d),c=this.validationError=this.validate(d,b)||null;if(!c)return!0;this.trigger("invalid",this,c,a.extend(b,{validationError:c}));return!1}});a.each("keys,values,pairs,invert,pick,omit".split(","),function(d){l.prototype[d]=function(){var b=c.call(arguments);b.unshift(this.attributes);return a[d].apply(a,b)}});var p=b.Collection=function(d,b){b||(b={});if(b.model)this.model=b.model;if(b.comparator!==void 0)this.comparator=b.comparator;this._reset();this.initialize.apply(this,arguments);d&&this.reset(d,a.extend({silent:!0},b))},v={add:!0,remove:!0,merge:!0},r={add:!0,remove:!1};a.extend(p.prototype,d,{model:l,initialize:function(){},toJSON:function(a){return this.map(function(d){return d.toJSON(a)})},sync:function(){return b.sync.apply(this,arguments)},add:function(d,b){return this.set(d,a.extend({merge:!1},b,r))},remove:function(d,b){var c=!a.isArray(d),d=c?[d]:a.clone(d);b||(b={});var e,g,h,l;for(e=0,g=d.length;e<g;e++)if(l=d[e]=this.get(d[e])){delete this._byId[l.id];delete this._byId[l.cid];h=this.indexOf(l);this.models.splice(h,1);this.length--;if(!b.silent)b.index=h,l.trigger("remove",l,this,b);this._removeReference(l)}return c?d[0]:d},set:function(d,b){b=a.defaults({},b,v);b.parse&&(d=this.parse(d,b));var c=!a.isArray(d),d=c?d?[d]:[]:a.clone(d),e,g,h,f,p,j,i=b.at,k=this.model,r=this.comparator&&i==null&&b.sort!==!1,o=a.isString(this.comparator)?this.comparator:null,x=[],s=[],m={},n=b.add,B=b.merge,A=b.remove,q=!r&&n&&A?[]:!1;for(e=0,g=d.length;e<g;e++){p=d[e];h=p instanceof l?f=p:p[k.prototype.idAttribute];if(h=this.get(h))A&&(m[h.cid]=!0),B&&(p=p===f?f.attributes:p,b.parse&&(p=h.parse(p,b)),h.set(p,b),r&&!j&&h.hasChanged(o)&&(j=!0)),d[e]=h;else if(n){f=d[e]=this._prepareModel(p,b);if(!f)continue;x.push(f);f.on("all",this._onModelEvent,this);this._byId[f.cid]=f;f.id!=null&&(this._byId[f.id]=f)}q&&q.push(h||f)}if(A){for(e=0,g=this.length;e<g;++e)m[(f=this.models[e]).cid]||s.push(f);s.length&&this.remove(s,b)}if(x.length||q&&q.length)if(r&&(j=!0),this.length+=x.length,i!=null)for(e=0,g=x.length;e<g;e++)this.models.splice(i+e,0,x[e]);else{if(q)this.models.length=0;p=q||x;for(e=0,g=p.length;e<g;e++)this.models.push(p[e])}j&&this.sort({silent:!0});if(!b.silent){for(e=0,g=x.length;e<g;e++)(f=x[e]).trigger("add",f,this,b);(j||q&&q.length)&&this.trigger("sort",this,b)}return c?d[0]:d},reset:function(d,b){b||(b={});for(var c=0,e=this.models.length;c<e;c++)this._removeReference(this.models[c]);b.previousModels=this.models;this._reset();d=this.add(d,a.extend({silent:!0},b));b.silent||this.trigger("reset",this,b);return d},push:function(d,b){return this.add(d,a.extend({at:this.length},b))},pop:function(a){var d=this.at(this.length-1);this.remove(d,a);return d},unshift:function(d,b){return this.add(d,a.extend({at:0},b))},shift:function(a){var d=this.at(0);this.remove(d,a);return d},slice:function(){return c.apply(this.models,arguments)},get:function(a){return a==null?void 0:this._byId[a.id]||this._byId[a.cid]||this._byId[a]},at:function(a){return this.models[a]},where:function(d,b){return a.isEmpty(d)?b?void 0:[]:this[b?"find":"filter"](function(a){for(var b in d)if(d[b]!==a.get(b))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(d){if(!this.comparator)throw Error("Cannot sort a set without a comparator");d||(d={});a.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(a.bind(this.comparator,this));d.silent||this.trigger("sort",this,d);return this},pluck:function(d){return a.invoke(this.models,"get",d)},fetch:function(d){d=d?a.clone(d):{};if(d.parse===void 0)d.parse=!0;var b=d.success,c=this;d.success=function(a){c[d.reset?"reset":"set"](a,d);b&&b(c,a,d);c.trigger("sync",c,a,d)};A(this,d);return this.sync("read",this,d)},create:function(d,b){b=b?a.clone(b):{};if(!(d=this._prepareModel(d,b)))return!1;b.wait||this.add(d,b);var c=this,e=b.success;b.success=function(a,d,b){b.wait&&c.add(a,b);e&&e(a,d,b)};d.save(null,b);return d},parse:function(a){return a},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(d,b){if(d instanceof l){if(!d.collection)d.collection=this;return d}b=b?a.clone(b):{};b.collection=this;var c=new this.model(d,b);if(!c.validationError)return c;this.trigger("invalid",this,c.validationError,b);return!1},_removeReference:function(a){this===a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,d,b,c){(a==="add"||a==="remove")&&b!==this||(a==="destroy"&&this.remove(d,c),d&&a==="change:"+d.idAttribute&&(delete this._byId[d.previous(d.idAttribute)],d.id!=null&&(this._byId[d.id]=d)),this.trigger.apply(this,arguments))}});a.each("forEach,each,map,collect,reduce,foldl,inject,reduceRight,foldr,find,detect,filter,select,reject,every,all,some,any,include,contains,invoke,max,min,toArray,size,first,head,take,initial,rest,tail,drop,last,without,difference,indexOf,shuffle,lastIndexOf,isEmpty,chain".split(","),function(d){p.prototype[d]=function(){var b=c.call(arguments);b.unshift(this.models);return a[d].apply(a,b)}});a.each(["groupBy","countBy","sortBy"],function(d){p.prototype[d]=function(b,c){var e=a.isFunction(b)?b:function(a){return a.get(b)};return a[d](this.models,e,c)}});var o=b.View=function(d){this.cid=a.uniqueId("view");d||(d={});a.extend(this,a.pick(d,m));this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()},s=/^(\S+)\s*(.*)$/,m="model,collection,el,id,attributes,className,tagName,events".split(",");a.extend(o.prototype,d,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(a,d){this.$el&&this.undelegateEvents();this.$el=a instanceof b.$?a:b.$(a);this.el=this.$el[0];d!==!1&&this.delegateEvents();return this},delegateEvents:function(d){if(!d&&!(d=a.result(this,"events")))return this;this.undelegateEvents();for(var b in d){var c=d[b];a.isFunction(c)||(c=this[d[b]]);if(c){var e=b.match(s),g=e[1],e=e[2],c=a.bind(c,this);g+=".delegateEvents"+this.cid;if(e==="")this.$el.on(g,c);else this.$el.on(g,e,c)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_ensureElement:function(){if(this.el)this.setElement(a.result(this,"el"),!1);else{var d=a.extend({},a.result(this,"attributes"));if(this.id)d.id=a.result(this,"id");this.className&&(d["class"]=a.result(this,"className"));this.setElement(b.$("<"+a.result(this,"tagName")+">").attr(d),!1)}}});b.sync=function(d,c,e){var g=q[d];a.defaults(e||(e={}),{emulateHTTP:b.emulateHTTP,emulateJSON:b.emulateJSON});var h={type:g,dataType:"json"};if(!e.url)h.url=a.result(c,"url")||B();if(e.data==null&&c&&(d==="create"||d==="update"||d==="patch"))h.contentType="application/json",h.data=JSON.stringify(e.attrs||c.toJSON(e));if(e.emulateJSON)h.contentType="application/x-www-form-urlencoded",h.data=h.data?{model:h.data}:{};if(e.emulateHTTP&&(g==="PUT"||g==="DELETE"||g==="PATCH")){h.type="POST";if(e.emulateJSON)h.data._method=g;var l=e.beforeSend;e.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",g);if(l)return l.apply(this,arguments)}}if(h.type!=="GET"&&!e.emulateJSON)h.processData=!1;if(h.type==="PATCH"&&n)h.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")};d=e.xhr=b.ajax(a.extend(h,e));c.trigger("request",c,d,e);return d};var n=typeof k!=="undefined"&&!!k.ActiveXObject&&!(k.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent),q={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};b.ajax=function(){return b.$.ajax.apply(b.$,arguments)};var D=b.Router=function(a){a||(a={});if(a.routes)this.routes=a.routes;this._bindRoutes();this.initialize.apply(this,arguments)},I=/\((.*?)\)/g,F=/(\(\?)?:\w+/g,j=/\*\w+/g,t=/[\-{}\[\]+?.,\\\^$|#\s]/g;a.extend(D.prototype,d,{initialize:function(){},route:function(d,c,e){a.isRegExp(d)||(d=this._routeToRegExp(d));a.isFunction(c)&&(e=c,c="");e||(e=this[c]);var g=this;b.history.route(d,function(a){a=g._extractParameters(d,a);e&&e.apply(g,a);g.trigger.apply(g,["route:"+c].concat(a));g.trigger("route",c,a);b.history.trigger("route",g,c,a)});return this},navigate:function(a,d){b.history.navigate(a,d);return this},_bindRoutes:function(){if(this.routes){this.routes=a.result(this,"routes");for(var d,b=a.keys(this.routes);(d=b.pop())!=null;)this.route(d,this.routes[d])}},_routeToRegExp:function(a){a=a.replace(t,"\\$&").replace(I,"(?:$1)?").replace(F,function(a,d){return d?a:"([^/]+)"}).replace(j,"(.*?)");return RegExp("^"+a+"$")},_extractParameters:function(d,b){var c=d.exec(b).slice(1);return a.map(c,function(a){return a?decodeURIComponent(a):null})}});var z=b.History=function(){this.handlers=[];a.bindAll(this,"checkUrl");if(typeof k!=="undefined")this.location=k.location,this.history=k.history},E=/^[#\/]|\s+$/g,G=/^\/+|\/+$/g,H=/msie [\w.]+/,w=/\/$/,x=/[?#].*$/;z.started=!1;a.extend(z.prototype,d,{interval:50,getHash:function(a){return(a=(a||this).location.href.match(/#(.*)$/))?a[1]:""},getFragment:function(a,d){if(a==null)if(this._hasPushState||!this._wantsHashChange||d){var a=this.location.pathname,b=this.root.replace(w,"");a.indexOf(b)||(a=a.slice(b.length))}else a=this.getHash();return a.replace(E,"")},start:function(d){if(z.started)throw Error("Backbone.history has already been started");z.started=!0;this.options=a.extend({root:"/"},this.options,d);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==!1;this._wantsPushState=!!this.options.pushState;this._hasPushState=!(!this.options.pushState||!this.history||!this.history.pushState);var d=this.getFragment(),c=document.documentMode,c=H.exec(navigator.userAgent.toLowerCase())&&(!c||c<=7);this.root=("/"+this.root+"/").replace(G,"/");if(c&&this._wantsHashChange)this.iframe=b.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(d);if(this._hasPushState)b.$(k).on("popstate",this.checkUrl);else if(this._wantsHashChange&&"onhashchange"in k&&!c)b.$(k).on("hashchange",this.checkUrl);else if(this._wantsHashChange)this._checkUrlInterval=setInterval(this.checkUrl,this.interval);this.fragment=d;d=this.location;c=d.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState)if(!this._hasPushState&&!c)return this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0;else if(this._hasPushState&&c&&d.hash)this.fragment=this.getHash().replace(E,""),this.history.replaceState({},document.title,this.root+this.fragment+d.search);if(!this.options.silent)return this.loadUrl()},stop:function(){b.$(k).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);z.started=!1},route:function(a,d){this.handlers.unshift({route:a,callback:d})},checkUrl:function(){var a=this.getFragment();a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe)));if(a===this.fragment)return!1;this.iframe&&this.navigate(a);this.loadUrl()},loadUrl:function(d){d=this.fragment=this.getFragment(d);return a.any(this.handlers,function(a){if(a.route.test(d))return a.callback(d),!0})},navigate:function(a,d){if(!z.started)return!1;if(!d||d===!0)d={trigger:!!d};var b=this.root+(a=this.getFragment(a||"")),a=a.replace(x,"");if(this.fragment!==a){this.fragment=a;a===""&&b!=="/"&&(b=b.slice(0,-1));if(this._hasPushState)this.history[d.replace?"replaceState":"pushState"]({},document.title,b);else if(this._wantsHashChange)this._updateHash(this.location,a,d.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(d.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,d.replace));else return this.location.assign(b);if(d.trigger)return this.loadUrl(a)}},_updateHash:function(a,d,b){b?(b=a.href.replace(/(javascript:|#).*$/,""),a.replace(b+"#"+d)):a.hash="#"+d}});b.history=new z;l.extend=p.extend=D.extend=o.extend=z.extend=function(d,b){var c=this,e;e=d&&a.has(d,"constructor")?d.constructor:function(){return c.apply(this,arguments)};a.extend(e,c,b);var g=function(){this.constructor=e};g.prototype=c.prototype;e.prototype=new g;d&&a.extend(e.prototype,d);e.__super__=c.prototype;return e};var B=function(){throw Error('A "url" property or function must be specified');},A=function(a,d){var b=d.error;d.error=function(c){b&&b(a,c,d);a.trigger("error",a,c,d)}}}).call(this);if(k.P&&k.P.AUI_BUILD_DATE)k.gb=k.gb||{},k.gb.Backbone=Backbone.noConflict(),k.gb._=_.noConflict(),gb.execute=function(i){i(gb.Backbone,gb._)},n.when("A").execute(function(i){gb.Backbone.A=i;gb.Backbone.$=i.$;gb.$=i.$;n.register("GoldboxMobile3PAssets")});gb.execute(function(i,f){var c,b=i.Model.extend({StatusFilters:{AVAILABLE:"available",UPCOMING:"upcoming",MISSED:"missed",ACTIVE:"active"},Realms:{CA:"CA",CN:"CN",DE:"DE",ES:"ES",FR:"FR",IT:"IT",IN:"IN",JP:"JP",US:"US",UK:"UK",MX:"MX",BR:"BR"},CategoryFilters:{ALL:"all"},DealTypes:{DOTD:"DEAL_OF_THE_DAY",LD:"LIGHTNING_DEAL",BD:"BEST_DEAL",LOCAL:"LOCAL_DEAL",COUPON:"COUPON_DEAL",EVENT:"EVENT_DEAL"},DealStates:{LOADING:"LOADING",COMINGSOON:"COMINGSOON",AVAILABLE:"AVAILABLE",EXPIRED:"EXPIRED",SOLDOUT:"SOLDOUT",UPCOMING:"UPCOMING",WAITLIST:"WAITLIST",WAITLISTFULL:"WAITLISTFULL"},FilterStates:{ACTIVE:"ACTIVE",MISSED:"MISSED",UPCOMING:"UPCOMING"},DealStateToTemplateMap:{LOADING:"LOADING",AVAILABLE:"AVAILABLE",WAITLIST:"AVAILABLE",WAITLISTFULL:"AVAILABLE",EXPIRED:"EXPIRED",SOLDOUT:"SOLDOUT",UPCOMING:"UPCOMING",COMINGSOON:"COMINGSOON"},WatchedDealStateMap:{AVAILABLE:"AVAILABLE",WAITLIST:"AVAILABLE",WAITLISTFULL:"AVAILABLE",EXPIRED:"EXPIRED",SOLDOUT:"EXPIRED",UPCOMING:"UPCOMING",COMINGSOON:"UPCOMING",LOADING:"AVAILABLE"},WatchDealActions:{ADD:"ADD",REMOVE:"REMOVE"},WatchDealPopoverActions:{SHOW_WATCH_POPUP:"SHOW",HIDE_WATCH_POPUP:"HIDE",UPDATE_WATCH_POPUP:"UPDATE"},SembuActions:{GET_COOKIE:"getValue",SET_COOKIE:"setValue"},WatchDealViewKeys:{GOLDBOX_DOMAIN:"goldbox",DISMISS_WATCHPOPUP_KEY:"dismissed_watch_popup"},WatchDealConstants:{ANIMATE_DURATION:200},StateTemplates:{LOADING:"loading",AVAILABLE:"available",WAITLIST:"available",WAITLISTFULL:"available",COMINGSOON:"comingSoon",UPCOMING:"upcoming",SOLDOUT:"soldout",EXPIRED:"expired"},PurchaseStates:{ADD_TO_CART:"AddToCart",LEARN_MORE:"LearnMore",SEE_DEAL:"SeeDeal",JOIN_WAITLIST:"JoinWaitlist",WAITLIST_FULL:"WaitlistFull",CHOOSE_OPTIONS:"ChooseOptions",PENDINGATC:"PendingAddToCart",CLAIMED:"Claimed",INWAITLIST:"InWaitlist",INCART:"InCart"},DataTypes:{STRING:"string",BOOL:"bool"},CustomerStates:{NONE:"NONE",INCART:"INCART",CLAIMED:"CLAIMED",INWAITLIST:"INWAITLIST",PENDINGATC:"PENDINGATC",EXPIRED:"EXPIRED"},AppStoreLink:{iOS:"itms-apps://itunes.apple.com/us/app/pages/id297606951?mt=8&uo=4",android:"market://details?id=com.amazon.mShop.android.shopping"},ButtonActions:{ATC:"gbdeal-addtocart",JW:"gbdeal-joinwaitlist",SO:"gbdeal-seeoptions",WTD:"gbdeal-watchdeal"},priceKind:{LIST_PRICE:"LP",OUR_PRICE:"OP",PRINT_LIST_PRICE:"PLP",DIGITAL_LIST_PRICE:"DLP"},merchantName:{US:"Amazon.com",IT:"Amazon.it",ES:"Amazon.es",DE:"Amazon.de"},WidgetViewIDs:{A_POPOVER:"#a-popover-",CANCEL:"widgetRefineCancel",CART_ERROR:"cartError",CATEGORY_REFINE_CONTENT:"categoryRefineContent",CONTENT:"widgetContent",FILTER_BUTTON:"filterButton",FILTER_CONTENT:"filterContent",FILTERS:"widgetFilters",HERO_HEADER:"heroHeader",LAUNCH_CELL:"launchCell",LOADING:"widgetLoading",MINI_DP_MODAL:"mini_dp_modal_",NEXT_SHOVL_BUTTON:"nextShovlButton",PAGINATION_ROW:"paginationRow",PRIME:"prime_",PREV_SHOVL_BUTTON:"previousShovlButton",REFINE:"widgetRefine",REFINE_POPOVER_NAME:"refine",SCROLL:"widgetScroll",SHOVL_PAGINATION:"shovlPagination",SHOVL_STATE_HEADER:"shovlStateHeader",SORT_BUTTON:"sortButton"},WidgetViewSelectors:{NAV:"#a-page > nav",HEADER:"#heroHeader",DIVIDER:".dealDivider",REFINESTATE:".dealDivider + div",PAGINATION_ROW:".paginationRow",FILTER_BOX:".filterBox",TRIANGLE:".triangle",FILTERLINK:".filterLink",PADCENTER:".padCenter"},dealViewIDs:{TITLE:"dealTitle",DESC:"dealDescription",DESC_ABBR:"dealDescShort",DESC_REST:"dealDescRest",DUMMY_ELEMENT:"dummyElement",DEALCLOCK:"_dealClock",INCARTCLOCK:"_incartClock",PENDINGATCCLOCK:"_pendingATCClock",OPT_HEADER:"dealOptionsHeader",IMAGE:"dealImage",OPT_CONTENT:"dealOptionsContent",OPT_FOOTER:"dealOptionsFooter",SHARE:"dealShare",SHIP_SOLD:"shipSoldInfo"},WatchDealViewIDs:{WATCH_POPOVER:"watchDealPopover",WATCHING_IMAGE:"watchingImageDiv_",WATCH_BUTTON:"watchButton_",WATCH_BUTTON_TEXT:"watchButtonText_",MINI_DP_WATCH_BUTTON_MAPPING:{"GB-SUPPLE":"miniDPSuppleWatchButton"}},MobileClients:{AW:"aw",APP:"app",PC:"pc"},RedirectionLinks:{app:{ALL_DEALS:"/gp/mobile/deals/all-deals",BEST_DEAL:"/gp/mobile/deals/best-deals",DEAL_OF_THE_DAY:"/gp/mobile/deals/dotds",GATEWAY_PAGE:"/gp/mobile/deals",LIGHTNING_DEAL:"/gp/mobile/deals/lightning-deals"},aw:{ALL_DEALS:"/gp/aw/gb/alldeals",BEST_DEAL:"/gp/aw/gb/bd",DEAL_OF_THE_DAY:"/gp/aw/gb/dotds",GATEWAY_PAGE:"/gp/aw/gb",LIGHTNING_DEAL:"/gp/aw/gb/ld"},pc:{ALL_DEALS:"/gp/goldbox/all-deals"}},ReviewsPageURL:{app:"/gp/mobile/reviews/",aw:"/gp/mobile/reviews/",pc:"/gp/product-reviews/"},AJAXLinks:{CDS:"/gp/mobile/deals/ajax/impressionTrackerV2.html",ADD_TO_CART:"/gp/deal/ajax/addToCart.html",WATCH_DEAL:"/gp/deal/ajax/watchDealAction.html/ref=",GET_WATCHED:"/gp/deal/ajax/getWatchedDeals.html/ref=",GDM:"/xa/dealcontent/v2/GetDealMetadata",GD:"/xa/dealcontent/v2/GetDeals",GDS:"/xa/dealcontent/v2/GetDealStatus",CD:"/gp/deal/ajax/claimDeal.html",RD:"/gp/deal/ajax/redeemDeal.html",UPDATE_EMBU:"/gp/mobile/deals/ajax/modifySembuData.html"},MiscLinks:{CART_URL:"/gp/cart/view.html",CART_URL_AW:"/gp/aw/c",LOCAL_URL:"/local",PURCHASE_URL:"/gp/goldbox/purchase"},WidgetNames:{M_HERO:"GB-M-HERO",M_SUPPLE:"GB-M-SUPPLE",MG_HERO:"GB-M-GRID-HERO",ML_HERO:"GB-M-LIST-HERO",PC_SUPPLE:"GB-SUPPLE",PC_SHOVELER:"GB-SHOVELER",TAB_HERO:"GB-TAB-HERO",TAB_SUPPLE:"GB-TAB-SUPPLE"},ChangeoverID:{AddedToCart:"gb_in_cart_co",Waitlisted:"gb_waitlisted_co",Subnav:"gb_subnav_change_hover"},ClientOrientation:{LANDSCAPE:"landscape",PORTRAIT:"portrait"},MashNavButtons:{LEFT:"navButtonLeft",RIGHT:"navButtonRight"},BottomSheetActions:{StopWatching:{label:"gb_m_stop_watching_deal",actionName:"gbdeal-watchdeal"},ShareDeal:{label:"gb_share_deal",actionName:"gbdeal-mashshare"}},Direction:{UP:"up",DOWN:"down"},Constants:{MAX_TIMEOUT:2147483647,SECURE_IMAGES_URL_DEFAULT:"images-na.ssl-images-amazon.com",SECURE_IMAGES_URL_CN:"images-cn.ssl-images-amazon.com",MIN_DEAL_VIEW_WIDTH:200,MIN_TABLET_VIEW_WIDTH:200,MIN_PC_VIEW_WIDTH:250,SUPPLE_FILTER_COLUMN_WIDTH:235,MIN_NAV_WIDTH:1E3,PHONE_LANDSCAPE_COLUMN_COUNT:3,PHONE_PORTRAIT_COLUMN_COUNT:2,EGRESS_URL_UNSUPPORTED_REGEX:/\/dp\/|\/gp\/product\//,EXTRACT_ASIN_URL_REGEX:/(\/dp\/|\/gp\/product\/)([^\/]+)/,REDIRECT_URL_REGEX:/redirectURL=(.*)&/,MAX_SUPPLE_DEALS_TO_DISPLAY:2,GET_DEALS_MAX_JITTER:2,HI_RES_SCALING_FACTOR:2,AJAX_ENDPOINT:"/xa/dealcontent/v2/",PAGINATED_METADATA_VERSION:"V2.2",MAX_DISPLAYABLE_VALUES_IN_UNEXPANDED_FILTER:12,ALL:"ALL",X_DIRECTION:"xDirection",Y_DIRECTION:"yDirection"},DeviceNames:{IPHONE:"iPhone",IPAD:"iPad",WIN_PHONE:"winPhone",ANDROID_PHONE:"androidPhone",ANDROID_TAB:"androidTab"},Weblabs:{},ItemTypes:{NONE:"NONE",SINGLE:"SINGLE_ITEM",MULTI:"MULTI_ITEM",VARIATION:"VARIATION_ITEM"},DealAccessTypes:{PRIME_EARLY_ACCESS:"PRIME_EARLY_ACCESS",PRIME_ONLY_LD:"PRIME_ONLY_LD",PRIME_ONLY_DOTD:"PRIME_ONLY_DOTD"},PrimeSignUpURL:{PRIME_EARLY_ACCESS:"prime_signup_redirect",PRIME_ONLY_LD:"exclusive_access_prime_signup_redirect",PRIME_ONLY_DOTD:"exclusive_dotd_prime_signup_redirect"},Platforms:{TAB:"tablet",PC:"pc",PHONE:"phone"},ClientIDPrefix:"goldbox_mobile",SortOrders:{BY_SCORE:"BY_SCORE",BY_RELEVANCE:"BY_RELEVANCE",BY_BEST_SELLING:"BY_BEST_SELLING",BY_PRICE_ASCENDING:"BY_PRICE_ASCENDING",BY_PRICE_DESCENDING:"BY_PRICE_DESCENDING",BY_DISCOUNT_ASCENDING:"BY_DISCOUNT_ASCENDING",BY_DISCOUNT_DESCENDING:"BY_DISCOUNT_DESCENDING",BY_START_TIME:"BY_START_TIME"},SortOrdersToStringsMap:{BY_SCORE:"gb_sort_score",BY_RELEVANCE:"gb_sort_relevant",BY_BEST_SELLING:"gb_sort_bestselling",BY_PRICE_ASCENDING:"gb_sort_price_up",BY_PRICE_DESCENDING:"gb_sort_price_down",BY_DISCOUNT_ASCENDING:"gb_sort_discount_up",BY_DISCOUNT_DESCENDING:"gb_sort_discount_down",BY_START_TIME:"gb_sort_start_time"},RankingStrategies:{PERSONALIZED:"PERSONALIZED",CLAIMED_RATE:"CLAIMED_RATE"},PaginationDummyURLs:{PREV:"PREV",NEXT:"NEXT"},ViewPortPresence:{ABSENT:"absent",FULL:"full",FULL_HORIZONTAL_CONTENT:"horizontal",FULL_VERTICAL_CONTENT:"vertical",PARTIAL_TOP:"top",PARTIAL_BOTTOM:"bottom",PARTIAL_LEFT:"left",PARTIAL_RIGHT:"right",PARTIAL_TOP_LEFT:"top_left",PARTIAL_TOP_RIGHT:"top_right",PARTIAL_BOTTOM_LEFT:"bottom_left",PARTIAL_BOTTOM_RIGHT:"bottom_right"},WidgetHeaderIDs:{WidgetHeader:"widgetHeaderContent_"},FilterAttrToStrings:{ACTIVE:"gb_active",BEST_DEAL:"gb_best_deal",COUPON_DEAL:"gb_coupon_deal",DEAL_OF_THE_DAY:"gb_deal_of_the_day",DISCOUNT:"gb_discount_range",DISCOUNT_START:"gb_discount_range_start",DISCOUNT_END:"gb_discount_range_end",FREE_SHIPPING_ELIGIBLE_ONLY:"gb_free_shipping_eligible",GIFT_WRAPPABLE:"gb_gift_wrappable",GLOBAL_ELIGIBLE_ONLY:"gb_global_eligible",LIGHTNING_DEAL:"gb_lightning_deal",MISSED:"gb_missed",NEW_RELEASES:"gb_new_release",PRICE:"gb_price_range",PRICE_START:"gb_price_range_start",PRICE_END:"gb_price_range_end",PRIME:"gb_prime_eligible",PRIME_EARLY_ACCESS:"gb_prime_early_access",PRIME_ONLY_LD:"gb_prime_only_ld",PRIME_ONLY_DOTD:"gb_prime_only_dotd",PRIME_SUMMARY:"gb_prime_summary",REVIEW_RATING:"gb_x_stars_and_up",UPCOMING:"gb_upcoming",CASH_ON_DELIVERY:"gb-is-cod-allowed",FULLFILLED_BY_AMAZON:"gb-fullfilled-by-amazon"},DealStatesToFilterStates:{AVAILABLE:"ACTIVE",EXPIRED:"MISSED",UPCOMING:"UPCOMING",SOLDOUT:"MISSED",WAITLIST:"ACTIVE",WAITLISTFULL:"ACTIVE"},DCSQueryParams:{BRANDS:"brands",CATEGORIES:"enforcedCategories",DEAL_STATE:"dealStates",DEAL_TYPE:"dealTypes",DISCOUNT_RANGE:"discountRanges",FREE_SHIPPING_ELIGIBLE_ONLY:"freeShippingEligibleOnly",GLOBAL_ELIGIBLE_ONLY:"globalEligibleOnly",MAX_PERCENT_OFF:"maxPercentOff",MAX_PRICE:"maxPrice",MIN_PERCENT_OFF:"minPercentOff",MIN_PRICE:"minPrice",MIN_RATING:"minRating",PAGE:"page",PRICE_RANGE:"priceRanges",PRIME_ELIGIBLE_ONLY:"primeEligibleOnly",PRIME_ACCESS_TYPE:"primeAccessType",SORT_ORDER:"sortOrder"},BinNames:{BRANDS:"brands",CATEGORIES:"whitelist_categories",DISCOUNT:"discount_range",FREE_SHIPPING_ELIGIBLE_ONLY:"is_eligible_for_free_shipping",INCLUDED_DEAL_TARGETS:"included_deal_targets",GLOBAL_ELIGIBLE_ONLY:"is_global_eligible",PRIME_ELIGIBLE_ONLY:"is_prime",PRICE:"price_range"},BinCounts:{BRANDS:100,CATEGORIES:100,DISCOUNT:20,FREE_SHIPPING_ELIGIBLE_ONLY:2,INCLUDED_DEAL_TARGETS:1E3,GLOBAL_ELIGIBLE_ONLY:2,PRIME_ELIGIBLE_ONLY:2,PRICE:20},CustomerAppliedFilters:{PAGE:"p",CATEGORY:"c",STATUS:"s"},BrowserHistory:{STATE_KEY:"gb_hero_f_"},DefaultPollingIntervals:{LD:12E3},RoundedReviewStarsThresholds:{LOW:0.3,HIGH:0.7},CellSizeClasses:{SINGLE:"singleCell",DOUBLE:"doubleCell"},initialize:function(){var a=this;a.legacyPurchaseState={Available:a.CustomerStates.NONE,InCart:a.CustomerStates.INCART,WaitInLine:a.CustomerStates.INWAITLIST,PendingAddToCart:a.CustomerStates.PENDINGATC,Claimed:a.CustomerStates.CLAIMED,Expired:a.CustomerStates.EXPIRED};a.BinningParams={BRANDS:{key:"brands",dcsKey:this.DCSQueryParams.BRANDS},CATEGORIES:{key:"whitelist_categories",dcsKey:this.DCSQueryParams.CATEGORIES},DEAL_STATE:{key:"deal_state",dcsKey:this.DCSQueryParams.DEAL_STATE},DEAL_TYPE:{key:"deal_type",dcsKey:this.DCSQueryParams.DEAL_TYPE},DISCOUNT:{key:"discount_range",dcsKey:[this.DCSQueryParams.MIN_PERCENT_OFF,this.DCSQueryParams.MAX_PERCENT_OFF]},FREE_SHIPPING_ELIGIBLE_ONLY:{key:"is_eligible_for_free_shipping",dcsKey:this.DCSQueryParams.FREE_SHIPPING_ELIGIBLE_ONLY},PRICE:{key:"price_range",dcsKey:[this.DCSQueryParams.MIN_PRICE,this.DCSQueryParams.MAX_PRICE]},REVIEW_RATING:{key:"reviews",dcsKey:this.DCSQueryParams.MIN_RATING},GLOBAL_ELIGIBLE_ONLY:{key:"is_global_eligible",dcsKey:this.DCSQueryParams.GLOBAL_ELIGIBLE_ONLY},PAGE:{key:"page",dcsKey:this.DCSQueryParams.PAGE},PRIME_ELIGIBLE_ONLY:{key:"is_prime",dcsKey:this.DCSQueryParams.PRIME_ELIGIBLE_ONLY},PRIME_ACCESS_TYPE:{key:"prime_access_type",dcsKey:this.DCSQueryParams.PRIME_ACCESS_TYPE},SORT_ORDER:{key:"sortOrder",dcsKey:this.DCSQueryParams.SORT_ORDER},CASH_ON_DELIVERY:{key:"isCODAllowed",dcsKey:null},FULLFILLED_BY_AMAZON:{key:"isFulfilledByAmazon",dcsKey:null},NEW_RELEASES:{key:"newReleases",dcsKey:null},GIFT_WRAPPABLE:{key:"giftWrappable",dcsKey:null}};a.excludeBinningParamsForEvents=[a.BinningParams.PRICE.key,a.BinningParams.DISCOUNT.key];a.BinningKeyToDCSQueryParamMap={};f.each(a.BinningParams,function(d){a.BinningKeyToDCSQueryParamMap[d.key]=d.dcsKey});a.SortOrderLists={Events:[a.SortOrders.BY_RELEVANCE,a.SortOrders.BY_BEST_SELLING,a.SortOrders.BY_PRICE_ASCENDING,a.SortOrders.BY_PRICE_DESCENDING],Deals:[a.SortOrders.BY_SCORE,a.SortOrders.BY_BEST_SELLING,a.SortOrders.BY_PRICE_ASCENDING,a.SortOrders.BY_PRICE_DESCENDING,a.SortOrders.BY_DISCOUNT_ASCENDING,a.SortOrders.BY_DISCOUNT_DESCENDING]};a.FilterAttrToBinName={};f.each(f.keys(a.BinningParams),function(d){var b=a.BinningParams[d].key;a.FilterAttrToBinName[b]=b===a.BinningParams.NEW_RELEASES.key||b===a.BinningParams.GIFT_WRAPPABLE.key?a.BinNames.INCLUDED_DEAL_TARGETS:a.BinNames[d]||null});a.BinNamesToCount=f.object(f.values(a.BinNames),f.values(a.BinCounts));a.FilterStatesToDealStates={};f.each(f.keys(a.DealStatesToFilterStates),function(d){var b=a.DealStatesToFilterStates[d];a.FilterStatesToDealStates[b]=a.FilterStatesToDealStates[b]?a.FilterStatesToDealStates[b].concat([d]):[d]})}});k.GBEnums={getInstance:function(){c||(c=new b);return c}}});gb.execute(function(i){k.GBBaseUtilities=i.Model.extend({locale:null,initialize:function(f){if(f.customerData)this.locale=f.customerData.realm},checkAndSetSSLImageUrl:function(f){if(f===null)return f;if(k.location.protocol==="https:"){var c=gb.enums.Constants.SECURE_IMAGES_URL_DEFAULT;if(this.locale==="CN")c=gb.enums.Constants.SECURE_IMAGES_URL_CN;var b=document.createElement("a");b.href=f;b.protocol="https:";b.hostname=c;f=b.href}return f}})});gb.execute(function(i,f){k.GBResourceManager=i.Model.extend({initialize:function(c){this.strings={};this.images={};this.features={};this.customerData={};this.categories=[];this.deviceInfo={};this.urls={};this.whitelistedCategoryList=[];this.whitelistedCategoryNames={};this.whitelistedCategoryNamesParsed={};c&&this.registerResources(c);n.register("goldboxResources")},registerResources:function(c){this.registerStrings(c.strings);this.registerImages(c.images);this.registerFeatures(c.weblabs);this.registerCustomerData(c.customerData);this.registerCategories(c.categories);this.registerDeviceInfo(c.deviceInfo);this.registerUrls(c.urls)},registerStrings:function(c){this.updateResourceStore(this.strings,c)},getString:function(c,b){var a=this.strings[c]||"";if(b)for(var d in b)b.hasOwnProperty(d)&&(a=a.replace(RegExp("\\${"+d+"}","g"),b[d]));return a},getCategoryName:function(c,b){return b?this.whitelistedCategoryNamesParsed[c]:this.whitelistedCategoryNames[c]||null},registerImages:function(c){f.each(c,function(b,a){c[a]=gb.baseUtils.checkAndSetSSLImageUrl(b)});this.updateResourceStore(this.images,c)},getImage:function(c){return this.images[c]},registerFeatures:function(c){this.updateResourceStore(this.features,c)},getFeature:function(c){return this.features[c]},registerCustomerData:function(c){this.updateResourceStore(this.customerData,c)},getCustomerData:function(c){return this.customerData[c]},registerCategories:f.once(function(c){var b=this;this.updateResourceStore(this.categories,c);f.each(this.categories,function(a){b.whitelistedCategoryList.push(a.nodeId);b.whitelistedCategoryNames[a.nodeId]=a.category;b.whitelistedCategoryNamesParsed[a.nodeId]=f.unescape(a.category)})}),getCategories:function(){return this.categories},registerDeviceInfo:function(c){this.updateResourceStore(this.deviceInfo,c);gb.clientName="pc";if(this.deviceInfo.isApp)gb.clientName="app";else if(this.deviceInfo.isPhone)gb.clientName="aw"},getDeviceInfo:function(){return this.deviceInfo},registerUrls:function(c){this.updateResourceStore(this.urls,c)},getUrl:function(c){return this.urls[c]},updateResourceStore:function(c,b){if(b&&c)for(var a in b)b.hasOwnProperty(a)&&(c[a]=b[a])}})});gb.execute(function(i,f){var c,b=i.Model.extend({digitalCategories:{US:"16261631,2350149011,154606011,163856011,979455011,1233514011,2402172011".split(",")},digitalGlProductGroup:"gl_digital_book_service,gl_digital_ebook_purchase,gl_digital_music_purchase,gl_digital_video_download,gl_downloadable_software,gl_ebooks,gl_digital_video_games,gl_mobile_apps,gl_digital_software".split(","),defaultImageScaling:"AA",detailPageUrlPrefix:{pc:"/dp/",web:"/gp/aw/d/",aw:"/gp/aw/d/",app:"/gp/aw/d/",tablet:"/gp/mobile/dp/"},requestObjSortBy:{includedBins:"name",dealGroups:"keys",excludedExtendedFilters:"keys",extendedFilters:"keys",exclusiveTargetValues:"name",inclusiveTargetValues:"name",dealTargets:"dealID"},stateToDealViewTemplates:{LOADING:[],AVAILABLE:"image,inwaitlist,waitlistfull,waitlistavailable,claimed,pendingatc,title,description,reviewStars,priceBlock,button,time,percentClaimed,percentClaimedBar,dealType,primeEarlyAccess,couponCount,checkingDealStatus,incart,merchant,dpLink,primeBadge,shipSold,primeOnlyAccess,percentOff,primeTime,selector,badge,dealAction,cartMessage,widgetErrorAlert".split(","),COMINGSOON:"image,title,description,reviewStars,merchant,primeBadge,shipSold,dealType".split(","),UPCOMING:"image,title,time,description,reviewStars,primeEarlyAccess,primeBadge,shipSold,dealType,primeOnlyAccess,primeTime,badge,dealAction,watchButton".split(","),SOLDOUT:"image,title,priceBlock,percentClaimed,percentClaimedBar,description,reviewStars,merchant,shipSold,dealType,time,percentOff,badge,dealAction,couponCount".split(","),EXPIRED:"image,title,priceBlock,percentClaimed,percentClaimedBar,description,reviewStars,merchant,shipSold,dealType,time,percentOff,badge,dealAction,couponCount".split(",")},price:{CA:{currency:"CAD",decimal:2,format:function(a){return("C$"+a).replace(",","")}},US:{currency:"USD",decimal:2,format:function(a){return"$"+a}},UK:{currency:"GBP",decimal:2,format:function(a){return"&pound;"+a}},DE:{currency:"EUR",decimal:2,format:function(a){return(a+" &euro;").replace(".",",")}},FR:{currency:"EUR",decimal:2,format:function(a){return(a+" &euro;").replace(".",",")}},JP:{currency:"JPY",decimal:0,format:function(a){return"&yen; "+a}},CN:{currency:"CNY",decimal:2,format:function(a){return"&yen;"+a}},IN:{currency:"INR",decimals:2,format:function(a){return"&#8377;"+a}},IT:{currency:"EUR",decimal:2,format:function(a){return(a+" &euro;").replace(".",",")}},ES:{currency:"EUR",decimal:2,format:function(a){return(a+" &euro;").replace(".",",")}},MX:{currency:"MXN",decimal:2,format:function(a){return"$"+a}},BR:{currency:"BRL",decimal:2,format:function(a){return("R$ "+a).replace(".",",")}}},ppuRealms:["UK","DE","FR","ES","IT"],initialize:function(){this.applyIEPolyfills()},applyIEPolyfills:function(){if(!(i.$&&i.$(".a-lt-ie9").length===0)){if(!String.prototype.trim)String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(a,d){var b=this.length>>>0,c=Number(d)||0,c=c<0?Math.ceil(c):Math.floor(c);for(c<0&&(c+=b);c<b;c++)if(c in this&&this[c]===a)return c;return-1}}},getAppStoreURL:function(){var a="";if(gb.resources.deviceInfo.isApp)if(gb.resources.deviceInfo.isIOS)a=gb.enums.AppStoreLink.iOS;else if(gb.resources.deviceInfo.isAndroid)a=gb.enums.AppStoreLink.android;return a},commifyNumber:function(a,d){for(var a=parseFloat(a),a=d!==m||d!==null?a.toFixed(d):a.toString(),b=a.split("."),c=b[0],h=c.length-3;h>0;h-=3)c=c.substr(0,h)+","+c.substr(h,c.length-h);return b.length===2?c+"."+b[1]:c},getFormattedPrice:function(a){var d=this.price[gb.resources.getCustomerData("realm")],b=document.createElement("span");i.$(b).html(d.format(this.commifyNumber(a,d.decimal)));return b.innerHTML},getPriceRange:function(a){return a.max.value>a.min.value?a.min.formattedValue+" - "+a.max.formattedValue:null},getSubnavPageElementFromDomID:function(a){return i.$("#"+i.$("#"+a).parent().parent().prop("id"))},getSubnavSlotID:function(a,d){return gb.subnavController.SubnavIDs.SubnavPage+a+"slot"+d},parseBool:function(a){return a===!0||a===1||a==="1"},getDealViewID:function(a,d){return a+"_dealView_"+d},getAdRowID:function(a,d){return a+"_adSlot_"+d},getPageID:function(a,d){return a+"_page_"+d},getFilterItemViewID:function(a,d){return"FilterItemView_"+a.join("-")+"_"+d},resizeImage:function(a,d,b){a=a||gb.resources.getImage("goldbox_upcoming");a.substring(a.lastIndexOf(".")+1).toLowerCase()in{jpg:!0,jpeg:!0,png:!0,gif:!0,tif:!0}||(a=gb.resources.getImage("goldbox_upcoming"));if(d===m||d===null)return a;if(b===m||b===null)b=this.defaultImageScaling;return a.replace(/\.((_.*_)\.)?(\w+)$/,".$2_"+b+d+"_.$3")},checkAndSetSSLImageUrl:function(a){if(a===null)return a;if(k.location.protocol==="https:"){var d=gb.enums.Constants.SECURE_IMAGES_URL_DEFAULT;if(gb.resources.getCustomerData("realm")==="CN")d=gb.enums.Constants.SECURE_IMAGES_URL_CN;var b=document.createElement("a");b.href=a;b.protocol="https:";b.hostname=d;a=b.href}return a},getViewTemplatesForState:function(a,d){a=gb.enums.DealStateToTemplateMap[a];return d===gb.enums.DealTypes.EVENT?a===gb.enums.DealStates.LOADING?this.stateToDealViewTemplates.LOADING:this.stateToDealViewTemplates.AVAILABLE:this.stateToDealViewTemplates[a]||[]},getStateTemplateName:function(a,d){return d===gb.enums.DealTypes.EVENT?a===gb.enums.DealStates.LOADING?gb.enums.StateTemplates.LOADING:gb.enums.StateTemplates.AVAILABLE:gb.enums.StateTemplates[a]},calculatePercentOff:function(a,d){if(a===null||a===m||d===null||d===m)return null;if(typeof a!=="number"||typeof d!=="number")return null;if(a===0)return null;var b=a-d;if(b<=0)return null;var c=0;gb.resources.getCustomerData("realm")==="CN"?(c=1,b=(1-b/a)*10):b=b/a*100;return Math.round(b*Math.pow(10,c))/Math.pow(10,c)},getDisplayablePercentOff:function(a){return!a||typeof a!=="number"?null:gb.resources.getCustomerData("realm")==="CN"?(100-a)/10:a},heroTimer:function(a,d,b,c){a={dealDate:a,viewElement:d,spanID:b,update:function(){var a=this,l=a.dealDate.getTime()-(new Date).getTime();l<0&&(l=0);var f=Math.floor(l/36E5%60),v=Math.floor(l/6E4%60),l=Math.floor(l/1E3%60);if(c)l<10&&(l="0"+l),v<10&&(v="0"+v),a.timeString=f!==0?f+":"+v+":"+l:v+":"+l;else{f<10&&(f="0"+f);v<10&&!a.noHours&&(v="0"+v);l<10&&(l="0"+l);var r=gb.resources.getString("gbd_hour_separator")+" ",o=gb.resources.getString("gbd_minute_separator")+" ",s=gb.resources.getString("gbd_seconds_separator")+" ";a.timeString=f+r+v+o+l+s}i.$(d).find("#"+b).html(a.timeString);a.timeout&&k.clearTimeout(a.timeout);a.timeout=k.setTimeout(function(){a.update()},500)}};a.update();return a},formatDate:function(a){var d=gb.resources.getString("gb_month_"+a.getMonth()),a=a.getDate();a<10&&(a="0"+a);return gb.resources.getString("gb_date_format",{month:d,day:a,date_suffix:gb.resources.getString("gb_date")})},formatTime:function(a,d){var b="";if(a>24)return b;var b=gb.resources.getCustomerData("realm"),c=a>=12?gb.resources.getString("gb_pm"):gb.resources.getString("gb_am"),h=f.contains([gb.enums.Realms.US,gb.enums.Realms.UK,gb.enums.Realms.IN,gb.enums.Realms.MX],b)?!1:!0;d<10&&(d="0"+d);if(h){if(a<10&&(b===gb.enums.Realms.DE||b===gb.enums.Realms.FR))a="0"+a;c=""}else a=a%12||12;return b=gb.resources.getString("gb_time",{hours:a,minutes:d,period:c})},ellipsify:function(a){var d=a.el,b=a.jQuery,c=a.wordsIntact,a=a.removeDots,h=d.clone().empty().css({display:"none",height:"auto"}).width(d.width());d.width(d.width());b(d).after(h);var l=b.trim(d.html());h.html(l);if(!(h.height()<=d.height())){h.empty();for(var f=0,i=0,k=l.length;f<l.length&&i<k;)f=Math.floor((i+k)/2),a?h.html(l.substr(0,f)):h.html(l.substr(0,f)+"..."),h.height()<=d.height()?i=f+1:k=f-1;l=l.substr(0,i-1);c&&(c=l.lastIndexOf(" "),l=l.substr(0,c));a||(l+="...");d.html(l)}b(h).remove()},setUrlParam:function(a,d,b){var c=a.indexOf("#"),h=c===-1?"":a.substr(c),a=c===-1?a:a.substr(0,c),c=RegExp("([?&])"+d+"=.*?(&|$)","i"),l=a.indexOf("?")!==-1?"&":"?",a=a.match(c)?a.replace(c,"$1"+d+"="+b+"$2"):a+l+d+"="+b;return a+h},clearUrlParam:function(a,d){var b=a.indexOf("#"),c=b===-1?"":a.substr(b),a=b===-1?a:a.substr(0,b),b=RegExp("([?&])"+d+"=.*?(&|$)","gi");a.match(b)&&(a=a.replace(b,"$1"),a=a.replace(/[?&]$/,""));return a+c},setUrlHash:function(a,d){var b=a.indexOf("#"),a=b===-1?a:a.substr(0,b);return d?a+"#"+d:a},setSafeTimeout:function(a,d){if(d>0&&d<gb.enums.Constants.MAX_TIMEOUT)return k.setTimeout(a,d)},getDetailPageURL:function(a,d){var b=this.detailPageUrlPrefix[d]+a;gb.resources.deviceInfo.isApp&&!gb.resources.deviceInfo.isIPhone&&(b=gb.utils.setUrlParam(b,"app-action","detail"),b=gb.utils.setUrlParam(b,"asin",a));return b},hasConflictingDpParams:function(a){var d=!1,a=a.split("?")[1]?"&"+a.split("?")[1]:null,b=["smid","m","me"];if(a)for(var c=0;c<b.length;c++)if(a.indexOf("&"+b[c]+"=")>=0){d=!0;break}return d},getReviewsPageURL:function(a){return gb.enums.ReviewsPageURL[gb.clientName]+a},getShovelerWidth:function(a){var d=gb.configManager.getDealViewConfig(a.widgetID),b=gb.configManager.getWidgetViewConfig(a.widgetID),c=parseInt(d.dealsLimit,10),h=parseInt(d.imageSize,10),d=parseInt(d.dealsMargin,10),l=parseInt(b.redirectDivWidth,10),f=parseInt(b.redirectDivLeftMargin,10),b=parseInt(b.redirectDivRightMargin,10),i=0,k=0,o=0;a.totalDealsToShowCount>c?(k=c-6,o=(h+d)*k+f+l+b,i=1):(k=a.totalDealsToShowCount,o=(h+d)*k);return{redirectDivWidth:l,showRedirectDiv:i,shovelerDealsToShow:k,shovelerWidth:o}},updateAddressBarUrl:function(a,d,b){k.history&&typeof history.pushState==="function"?(b=b||{},d?(f.isEmpty(k.history.state)&&k.history.replaceState({state:"initialLoad"},"",k.location.href),k.history.pushState(b,"",a)):(!k.history.state||!k.history.state.bottom_sheet_open)&&k.history.replaceState(b,"",a),gb.metrics.recordRefViaAjax(this.extractRefFromUrl(a))):k.location.href=a},getParamValueFromUrl:function(a,d){var d=d.replace(/[\[]/,"[").replace(/[\]]/,"]"),b=RegExp("[\\?&]"+d+"=([^&#]*)").exec(a);return b?k.decodeURIComponent(b[1].replace(/\+/g," ")):""},getHashOfAppliedFilters:function(a){for(var d={},a=a.split(","),b=0;b<a.length;b++){var c=a[b].split(":");d[c[0]]=c[1]}return d},_getFiltersAppliedUrl:function(a,d,b,c){return this.setUrlParam(k.location.href,gb.enums.BrowserHistory.STATE_KEY+a,gb.enums.CustomerAppliedFilters.PAGE+":"+d+","+gb.enums.CustomerAppliedFilters.CATEGORY+":"+b+","+gb.enums.CustomerAppliedFilters.STATUS+":"+c)},updateFiltersInAddressBar:function(a,d,b,c){this.updateAddressBarUrl(this._getFiltersAppliedUrl(a,d,b,c))},getWidgetLandingPageUrl:function(a){return this.getParamValueFromUrl(k.location.href,gb.enums.BrowserHistory.STATE_KEY+a)?this._getFiltersAppliedUrl(a,1,gb.enums.CategoryFilters.ALL,gb.enums.StatusFilters.AVAILABLE):k.location.href},getCustomerActionTemplateInfo:function(a,d){var b=a.dealState,c=a.detail.itemType,h=a.customerState,l=a.dealType,f={},i=!0,k=!0,o=!0,s=!1,m=gb.resources.deviceInfo;f.showWatchDealButton=!1;if(gb.controller.schedulingParams[d]&&gb.controller.schedulingParams[d].fetchWatchedDeals&&l===gb.enums.DealTypes.LD)f.showWatchDealButton=!0;if(a.dealType===gb.enums.DealTypes.LD&&c===gb.enums.ItemTypes.SINGLE){gb.clientName===gb.enums.MobileClients.PC?s=!0:(s=this.isTablet(gb.clientName)&&m.isAppVersionHigher&&(m.isIOS&&gb.resources.getFeature("waitlist_feature_tablet_IOS")||(m.isAndroid||m.isAndroidUserAgent)&&gb.resources.getFeature("waitlist_feature_tablet_Android")),l=m.isPhone&&((m.isAndroid||m.isAndroidUserAgent)&&gb.resources.getFeature("waitlist_feature_mobile_Android")||m.isIOS&&gb.resources.getFeature("waitlist_feature_mobile_IOS")),s=m.isFirePhone&&m.isAppVersionHigher&&gb.resources.getFeature("waitlist_feature_tablet_Android")||s||l);b===gb.enums.DealStates.AVAILABLE?(f.purchaseState=gb.enums.PurchaseStates.ADD_TO_CART,f.buttonText=gb.resources.getString("gb_add_to_cart")):(f.purchaseState=gb.enums.PurchaseStates.SEE_DEAL,f.buttonText=gb.resources.getString("gb_view_deal"));if(s){if(b===gb.enums.DealStates.WAITLIST)f.purchaseState=gb.enums.PurchaseStates.JOIN_WAITLIST,f.buttonText=gb.resources.getString("gbd_join_waitlist");else if(b===gb.enums.DealStates.WAITLISTFULL)f.purchaseState=gb.enums.PurchaseStates.WAITLIST_FULL,i=null;if(h===gb.enums.CustomerStates.INWAITLIST)f.purchaseState=gb.enums.PurchaseStates.INWAITLIST,f.buttonText=gb.resources.getString("gb_add_to_cart"),o=i=null}if(h===gb.enums.CustomerStates.INCART)f.purchaseState=gb.enums.PurchaseStates.INCART,k=o=i=null;else if(h===gb.enums.CustomerStates.CLAIMED)f.purchaseState=gb.enums.PurchaseStates.CLAIMED,k=o=i=null;else if(h===gb.enums.CustomerStates.PENDINGATC)f.purchaseState=gb.enums.PurchaseStates.PENDINGATC,f.buttonText=gb.resources.getString("gb_add_to_cart"),k=o=null}else if(c===gb.enums.ItemTypes.SINGLE)o=null,f.purchaseState=gb.enums.PurchaseStates.ADD_TO_CART,f.buttonText=gb.resources.getString("gb_add_to_cart");else{if(a.dealType===gb.enums.DealTypes.LD){if(o=!0,f.buttonText=gb.resources.getString("gb_see_options"),b=gb.resources.deviceInfo.isPhone,h=gb.utils.isTablet(gb.clientName),m=gb.clientName===gb.enums.MobileClients.APP,b||h&&m)f.buttonText=gb.resources.getString("gb_view_deal")}else o=null,f.buttonText=a.dealType===gb.enums.DealTypes.COUPON?gb.resources.getString("gb_clip_coupon"):gb.resources.getString("gb_view_deal");f.purchaseState=gb.enums.PurchaseStates.SEE_DEAL}f.showButton=i;f.showTime=k;f.showPercentClaimed=o;f.showWaitlistFeatures=s;if(c===gb.enums.ItemTypes.SINGLE&&a.isDigital)f.purchaseState=gb.enums.PurchaseStates.SEE_DEAL,f.buttonText=gb.resources.getString("gb_view_deal");if((this.isDealInEarlyAccessWindow(a)||a.detail.isPrimeOnly)&&!gb.resources.customerData.hasEarlyAccessBenefit)f.purchaseState=gb.enums.PurchaseStates.LEARN_MORE,f.buttonText=gb.resources.getString("gb_learn_more"),f.showButton=!0,f.showTime=!0,f.showPercentClaimed=a.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_ONLY_DOTD?!1:!0;f.primeSignUpUrl=this.getPrimeSignUpUrlForAccessType(a);this._setTemplateDataForMetroApp(f);return f},getVariationCustomerActionTemplateInfo:function(a,d){var b=a.deal,c=b.detail.itemType,h=b.dealState,h=d?d.status.itemState:h,l=d?d.status.customerState:b.customerState,f={},i=!0,k=!0,o=!0,s=!1;if(b.dealType===gb.enums.DealTypes.LD&&c===gb.enums.ItemTypes.VARIATION){if(gb.clientName===gb.enums.MobileClients.PC||gb.widgets[a.widgetView.widgetID].widgetName===gb.enums.WidgetNames.ML_HERO)s=!0;if(h===gb.enums.DealStates.AVAILABLE||h===gb.enums.DealStates.SOLDOUT)f.purchaseState=gb.enums.PurchaseStates.ADD_TO_CART,f.buttonText=gb.resources.getString("gb_add_to_cart");if(s){if(h===gb.enums.DealStates.WAITLIST)f.purchaseState=gb.enums.PurchaseStates.JOIN_WAITLIST,f.buttonText=gb.resources.getString("gbd_join_waitlist");else if(h===gb.enums.DealStates.WAITLISTFULL)f.purchaseState=gb.enums.PurchaseStates.WAITLIST_FULL,i=null;if(l===gb.enums.CustomerStates.INWAITLIST)f.purchaseState=gb.enums.PurchaseStates.INWAITLIST,f.buttonText=gb.resources.getString("gb_add_to_cart"),o=i=null}if(l===gb.enums.CustomerStates.INCART)f.purchaseState=gb.enums.PurchaseStates.INCART,k=o=i=null;else if(l===gb.enums.CustomerStates.CLAIMED)f.purchaseState=gb.enums.PurchaseStates.CLAIMED,k=o=i=null;else if(l===gb.enums.CustomerStates.PENDINGATC)f.purchaseState=gb.enums.PurchaseStates.PENDINGATC,f.buttonText=gb.resources.getString("gb_add_to_cart"),k=o=null}f.showButton=i;f.showTime=k;f.showPercentClaimed=o;f.showWaitlistFeatures=s;if((this.isDealInEarlyAccessWindow(b)||b.detail.isPrimeOnly)&&!gb.resources.customerData.hasEarlyAccessBenefit)f.purchaseState=gb.enums.PurchaseStates.LEARN_MORE,f.buttonText=gb.resources.getString("gb_learn_more"),f.showButton=!0,f.showTime=!0,f.showPercentClaimed=b.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_ONLY_DOTD?!1:!0;f.primeSignUpUrl=this.getPrimeSignUpUrlForAccessType(b);this._setTemplateDataForMetroApp(f);return f},getPrimeSignUpUrlForAccessType:function(a){return a.detail.primeAccessType&&!gb.resources.getCustomerData("isPrimeMember")&&(a=gb.enums.PrimeSignUpURL[a.detail.primeAccessType])?gb.resources.getUrl(a):null},isShowPercentageOffEnabled:function(){return gb.resources.getCustomerData("realm")===gb.enums.Realms.CN?!1:!0},isDealInEarlyAccessWindow:function(a){var d=!1;a.status.dates.end.getTime();(new Date).getTime();var b=a.status.dates.start.getTime()-(new Date).getTime();a.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS&&b<=0&&-b<a.detail.primeAccessDurationInMs&&(d=!0);return d},isPrimeSignupRedirectSurpported:function(){return gb.resources.deviceInfo.isIOS&&gb.clientName===gb.enums.MobileClients.APP?!1:!0},isPEADealForNonPrimeUser:function(a){return a.detail.isPrimeEarlyAccessDeal&&gb.utils.isDealInEarlyAccessWindow(a)&&!gb.resources.getCustomerData("isPrimeMember")?!0:!1},isPODealForNonPrimeUser:function(a){return a.detail.isPrimeOnly&&!gb.resources.getCustomerData("isPrimeMember")?!0:!1},isTablet:function(a){return a===gb.enums.MobileClients.APP&&!gb.resources.deviceInfo.isPhone||a===gb.enums.Platforms.TAB?!0:!1},isDOTDDeal:function(a){return a.dealType===gb.enums.DealTypes.DOTD||a.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_ONLY_DOTD},getDealsPerRow:function(a,d,b,c,h){a=this.getWindowWidth(a,{hasMargin:b});a=Math.floor(a/d);c?a-=a%2:h||(a===5?a=4:a>=6&&(a=6));return a},getWindowWidth:function(a,d){if(d)for(var b in d)d.hasOwnProperty(b)&&b==="hasMargin"&&d[b]&&(a*=0.9);return a},getWindowLocationOrigin:function(){if(!k.location.origin)k.location.origin=k.location.protocol+"//"+k.location.hostname+(k.location.port?":"+k.location.port:"");var a=k.location.origin;a||(a=k.location.protocol+"//"+k.location.hostname,k.location.port&&(a=k.location.origin+":"+k.location.port));return a},isUnsupportedEgressURL:function(a){var d=!1,b=gb.enums.Constants.EGRESS_URL_UNSUPPORTED_REGEX;if((a.itemType===gb.enums.ItemTypes.MULTI||a.type===gb.enums.DealTypes.BD&&a.itemType===gb.enums.ItemTypes.NONE)&&b.test(a.egressUrl))d=!0;return d},getAsinFromURL:function(a){var d=document.createElement("a");d.href=a;return(a=d.pathname.match(gb.enums.Constants.EXTRACT_ASIN_URL_REGEX))&&a.length>2?a[2]:""},getReviewStars:function(a){if(a===null||a===m||a<0||a>5)a=0;var d=Math.floor(a);a-=d;var b=!1;a>gb.enums.RoundedReviewStarsThresholds.HIGH?d+=1:a>=gb.enums.RoundedReviewStarsThresholds.LOW&&(b=!0);return{fullStars:d,hasHalfStar:b}},sendLogData:function(a,d){k.navigator&&navigator.sendBeacon?navigator.sendBeacon(a,d):i.$.ajax({url:a,data:d,async:!1})},getFilterViewIDs:function(a){var d=this,b={};f.each(a,function(a){var c=f.map(a.attr.split(","),i.$.trim);b[c.join("_")]=d.getFilterItemViewID(c,a.type)});return b},getExtendedArray:function(a,d,b,c){var h=[],h=c!==m?this.getExtendedArray(a,c):Array(a);b===m&&(b=0);Array.prototype.splice.apply(h,[b,d.length].concat(d));return h},getFilterAttributesList:function(a){return f.flatten(f.map(a,function(a){return f.map(a.attr.split(","),function(a){return a.trim()})}))},getIncludedBins:function(a){a=this.getFilterAttributesList(a);a=f.filter(f.map(a,function(a){return gb.enums.FilterAttrToBinName[a]}),function(a){if(a)return a});a=f.uniq(a);return f.map(a,function(a){return{name:a,count:gb.enums.BinNamesToCount[a]}})},getBoundingRect:function(a){if(!a)return!1;a=document.getElementById(a);if(!a)return!1;if(i.$(a).css("display")==="none")return!1;a=a.getBoundingClientRect();return!a?!1:a.top===0&&a.bottom===0&&a.left===0&&a.right===0?!1:a},filterDealsByViewport:function(a){var d={},b=this;f.each(gb.watcher.dealsInView,function(a,c){f.each(a,function(a,g){var h=b.getDealViewID(g,a);d[h]=c})});var c=gb.utils.getDealViewsInViewport(d,1);return f.intersection(a,c)},getDealViewsInViewport:function(a,d){var b=this,c=i.$(k).height(),h=i.$(k).width(),l=[];f.each(a,function(a,f){var i=b.getBoundingRect(f);i&&i.top>=-1*d*c&&i.top<=(1+d)*c&&i.bottom>=-1*d*c&&i.bottom<=(1+d)*c&&i.left>=-1*d*h&&i.left<=(1+d)*h&&i.right>=-1*d*h&&i.right<=(1+d)*h&&l.push(a)});return l},hasPricingDetails:function(a){var d=!1,a=a.pricingData.prices.dealPrice;a!==m&&a!==null&&(d=!0);return d},isElementInViewPort:function(a){a=this.getBoundingRect(a);if(a===!1)return gb.enums.ViewPortPresence.ABSENT;var d=a.top,b=a.bottom,c=a.left,h=a.right,l=i.$(k).height(),f=i.$(k).width(),a=d>=0&&d<=l,d=d<0,v=b>=0&&b<=l,b=b>l,l=c>=0&&c<=f,c=c<0,r=h>=0&&h<=f,h=h>f;if(a&&v&&l&&r)return gb.enums.ViewPortPresence.FULL;if(l&&r){if(d&&b)return gb.enums.ViewPortPresence.FULL_VERTICAL_CONTENT;if(a&&b)return gb.enums.ViewPortPresence.PARTIAL_TOP;if(d&&v)return gb.enums.ViewPortPresence.PARTIAL_BOTTOM}if(a&&v){if(c&&h)return gb.enums.ViewPortPresence.FULL_HORIZONTAL_CONTENT;if(l&&h)return gb.enums.ViewPortPresence.PARTIAL_LEFT;if(c&&r)return gb.enums.ViewPortPresence.PARTIAL_RIGHT}return a&&b&&l&&h?gb.enums.ViewPortPresence.PARTIAL_TOP_LEFT:a&&b&&c&&r?gb.enums.ViewPortPresence.PARTIAL_TOP_RIGHT:d&&v&&l&&h?gb.enums.ViewPortPresence.PARTIAL_BOTTOM_LEFT:d&&v&&c&&r?gb.enums.ViewPortPresence.PARTIAL_BOTTOM_RIGHT:gb.enums.ViewPortPresence.ABSENT},removeImage:function(a){a.find("img").remove()},isWidgetWithStatusFilter:function(a){var d=!0;f.contains([gb.enums.WidgetNames.M_HERO,gb.enums.WidgetNames.M_SUPPLE,gb.enums.WidgetNames.TAB_SUPPLE],a)&&(d=!1);return d},shouldShowMiniDetailPageModal:function(a){var d=!1,b=a.deal;if(gb.controller.schedulingParams[a.widgetView.widgetID].showShortCellView&&(b.dealState===gb.enums.DealStates.UPCOMING||b.detail.itemType===gb.enums.ItemTypes.SINGLE||b.detail.itemType===gb.enums.ItemTypes.VARIATION))d=!0;return d},isTouchDevice:function(){return"ontouchstart"in k||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0},invokeWatchDealStateTransitions:function(a){var d=gb.controller.dealDAOs[a];d.isDealWatched&&(f.each(gb.metadata.watchedDeals,function(b,c){if(c!==gb.enums.Constants.ALL){var h=f.indexOf(b,a),l=gb.enums.WatchedDealStateMap[d.dealState];h>-1&&l!==c?gb.metadata.watchedDeals[c].splice(h,1):h===-1&&l===c&&gb.metadata.watchedDeals[c].unshift(a)}}),gb.metadata.trigger("RefreshWatchedDealWidgets",f.keys(gb.widgets),d.dealID))},getWatchedDealStates:function(a){return a?f.map(a,function(a){return gb.enums.WatchedDealStateMap[a]}):f.uniq(f.values(gb.enums.WatchedDealStateMap))},getWatchedDealWidgetData:function(a){var d=this.getWatchedDealStates(a),b={},c=[],h=gb.enums.DealStates.AVAILABLE;f.each(gb.metadata.watchedDeals,function(a,p){f.indexOf(d,p)!==-1&&(b[h]=a,c=f.union(c,a))});return{selectedDealsCount:c.length,sortedDealIDs:c,dealsByState:b}},isDealActionable:function(a){if(!a)return!1;a=gb.controller.getDealDAO(a);return!a?!1:a.dealState!==gb.enums.DealStates.AVAILABLE&&a.dealState!==gb.enums.DealStates.WAITLIST?!1:a.detail.isPrimeOnly?gb.resources.customerData.isPrimeMember:a.detail.isPrimeEarlyAccessDeal&&this.isDealInEarlyAccessWindow(a)?gb.resources.customerData.hasEarlyAccessBenefit:!0},callAsyncAjax:function(a,d){k.navigator&&navigator.sendBeacon?navigator.sendBeacon(a,d):i.$.ajax({url:a,data:d,async:!1})},logRedirectPurchaseAttributes:function(a,d,b){if(a&&d&&(b||a.impressionAsin)){if(!b)b=a.impressionAsin;d="/gp/deal/ajax/logPurchaseAttributes.html?asin="+b+"&et="+d+"&ht=redirect";a.parentAsin&&(d+="&ca="+a.parentAsin);a.merchantID&&(d+="&mt="+a.merchantID);var c=this.price[gb.resources.getCustomerData("realm")].currency,h=null;if(a.itemType===gb.enums.ItemTypes.VARIATION)h=a.getAsinDAO(b).dealPrice;if(a.dealAsinsHash[b]&&a.dealAsinsHash[b].dealPrice)h=a.dealAsinsHash[b].dealPrice.price,c=a.dealAsinsHash[b].dealPrice.currency;h!==null&&c!==null&&(d+="&pr="+this.getCrypticPrice(h),d+="&cu="+c);i.$.ajax({url:d,async:!1})}},getCrypticPrice:function(a){return!f.isNumber(a)?null:a.toString().split("").map(function(a){return String.fromCharCode(a.charCodeAt(0)+17).replace("?","X")}).join("")},areNestedKeysPresent:function(a,d){if(!f.isObject(a)||!f.isString(d))return!1;for(var d=d.split("."),b=0;b<d.length;b++){if(!a||!a.hasOwnProperty(d[b]))return!1;a=a[d[b]]}return!0},showPPU:function(a){var d=gb.resources.getCustomerData("realm");if(!f.contains(this.ppuRealms,d))return!1;if(!a)return!1;a=gb.controller.getDealDAO(a);return!a?!1:a.pricingData.unitPrice&&a.pricingData.baseUnit?!0:!1},hasDigitalCategory:function(a){return f.intersection(a,gb.utils.digitalCategories[gb.resources.customerData.realm]).length?!0:!1},_setTemplateDataForMetroApp:function(a){var d=gb.resources.deviceInfo;if(d.isApp&&d.isMetro&&d.isWin)a.showButton=!1},removeNulls:function(a){if(f.isObject(a)){var d,b,c;a instanceof Array?(d=[],b=!0,c=0):(d={},b=!1);for(var h in a)if(a.hasOwnProperty(h)){var l=this.removeNulls(a[h]);l&&(d[b?c++:h]=l)}return f.isEmpty(d)?null:d}else if(a)return a;return null},sortRequestObj:function(a,d){if(f.isObject(d)&&!f.isEmpty(d))if(d instanceof Array)if(f.isObject(d[0])){var b=this.requestObjSortBy[a];b&&d.sort(function(a,d){return(a[b]>d[b])-(a[b]<d[b])})}else d.sort();else if(d instanceof Object){for(var c in d)d.hasOwnProperty(c)&&(d[c]=this.sortRequestObj(c,d[c]));if(this.requestObjSortBy[a]){var h={},l=Object.keys(d);l.sort();for(c=0;c<l.length;c++)h[l[c]]=d[l[c]];d=h}}return d},isOfferingRestrictionViolated:function(a){for(var d in a)if(a[d].category==="quantityRestriction")return!0;return!1},isDefinedAndNonNull:function(a){return a!==null&&a!==m?!0:!1},extractRefFromUrl:function(a){var d=a.indexOf("/ref=");if(d===-1)return"";a=a.substr(d+5);d=a.indexOf("?");d!==-1&&(a=a.substr(0,d));return a},getDeviceOrientation:function(a){a=gb.configManager.getWidgetViewConfig(a);a=parseInt(a.minLandscapeWidth,10);return i.$(k).width()>a&&i.$(k).width()>i.$(k).height()?gb.enums.ClientOrientation.LANDSCAPE:gb.enums.ClientOrientation.PORTRAIT},setDealViewHeightToOriginal:function(a,d){var b="#"+gb.utils.getDealViewID(a,d),b=gb.widgets[a].skinDomElement.find(b);b.height("auto");var c=b.find(".footerElm");c.length>0&&b.height(b.height()+c.height())},setDealViewHeightToDealRowHeight:function(a,d){var b="#"+gb.utils.getDealViewID(a,d),b=gb.widgets[a].skinDomElement.find(b),c=b.closest(".widgetContentRow");b.height(c.height())},getCSStransitionTime:function(a){var d=a+"ms ease-in-out";a===0&&(d="");return{"-webkit-transition":d,"-moz-transition":d,"-o-transition":d,transition:d}},getCSStransformDistance:function(a,d){var b;if(d===gb.enums.Constants.X_DIRECTION)b="translate3d("+a+"px,0px,0px)";else if(d===gb.enums.Constants.Y_DIRECTION)b="translate3d(0px,"+a+"px,0px)";else return{};return{"-webkit-transform":b,"-moz-transform":b,"-o-transform":b,transform:b}},convertToRequesterDomainUrl:function(a){return a===m||a===null?null:a.replace(/^https?:\/\/[a-z0-9\.\-]*\.amazon.com\//i,k.location.protocol+"//"+k.location.host+"/")},getDealsInternalUrl:function(a){var d;gb.resources.urls.deals_internal_website&&(d=gb.resources.urls.deals_internal_website+a);return d},getPriceTextForBasisKind:function(a){var d=gb.resources.getString("gb-price");if(a){var b=!1,c=gb.resources.getCustomerData("realm");[gb.enums.Realms.BR].indexOf(c)>=0&&(b=!0);a===gb.enums.priceKind.LIST_PRICE?d=gb.resources.getString("gb-list"):a===gb.enums.priceKind.PRINT_LIST_PRICE&&b?d=gb.resources.getString("fiona_list_price_35050"):a===gb.enums.priceKind.DIGITAL_LIST_PRICE&&b&&(d=gb.resources.getString("fiona_digital_price_42515"))}return d}});k.GBUtilities={getInstance:function(){c||(c=new b);return c}}});gb.execute(function(i,f){k.GBMetrics=i.Model.extend({widgetMetricsParams:{},widgetRefTags:{"GB-M-FACEOUT":"gbmp","GB-M-GRID-HERO":"gbmg","GB-M-HERO":"gbmh","GB-M-HERO-CN":"cnm_ldw_card_atc","GB-M-LIST-HERO":"gbml","GB-M-SUPPLE":"gbms","GB-M-SUBNAV":"gbmu","GB-TAB-FACEOUT":"gbtp","GB-TAB-HERO":"gbth","GB-TAB-SUPPLE":"gbts","GB-FILTER-HERO":"gbpf","GB-GRID-HERO":"gbpg","GB-PC-FACEOUT":"gbpp","GB-SUPPLE":"gbps","GB-SHOVELER":"gbph"},refTags:{addToCart:"atc",adSlot:"ads",clearFilter:"fcr",dpLink:"dpl",filter:"ftr",getWatchedDeals:"gwd",helpLink:"hlp",image:"img",joinWaitlist:"jwl",miniDpPopOver:"mdp",mobile:"mob",recLearnMore:"rlm",restrictionsApply:"rsa",reviews:"rvw",seeAllDeals:"sad",seeAllLocalDeals:"sal",subnavTabRefresh:"str",swipe:"swp",tab:"tab",title:"tit",unrecLearnMore:"ulm",unWatchDeal:"uwd",watchDeal:"wtd"},adRowRefTags:{rowNumber:"r"},initialize:function(){this.reverseMapAmabotParams=f.invert(this.amabotParams)},amabotParams:{pf_rd_p:"placementID",pf_rd_s:"slotName",pf_rd_t:"pageType",pf_rd_i:"pageIndent",pf_rd_m:"merchantID",pf_rd_r:"requestID"},registerWidgetMetricParams:function(c,b){var a=i.$("#"+b+"-amabot").html().split("?");if(a.length>1){for(var a=a[1].split("&amp;"),d,e={},g=0;g<a.length;g++)d=a[g].split("="),!(d.length<=1)&&this.amabotParams[d[0]]&&(e[this.amabotParams[d[0]]]=i.$.trim(d[1]));this.widgetMetricsParams[c]=e}},_addAmabotClickParameters:function(c,b){c&&b&&f.each(this.amabotParams,function(a){b[a]&&(c=gb.utils.setUrlParam(c,this.reverseMapAmabotParams[a],b[a]))},this);return c},addMetricsParams:function(c,b,a,d){if(!c)return"";if(!f.isEmpty(gb.widgets[b])){if(gb.resources.urls.deals_internal_website)return c;var e=this.widgetMetricsParams[b]||{},b=this.creatRefTag(b,a,d,e);gb.resources.deviceInfo.isWindowsPhone||(c=this._addRefTag(c,b),c=this._addAmabotClickParameters(c,e));return c}},creatRefTag:function(c,b,a,d){var c=this.widgetRefTags[gb.widgets[c].widgetName]||"--",b=b||"---",e=this._getSlotRefTag(d),d=this._getPlacementID(d),a=f.map(a,function(a){return((a||"")+"").replace(/[_ ]/g,"")}),a=f.filter(a,function(a){return!!a}),a=f.map(a,function(a){return a.substring(0,8)}).join("_");return[c,b,e,d,a].join("_")},partiallyAppliedReffedURLFunction:function(c){var b=this;return function(a,d){return b.addMetricsParams(a,c.widgetID,d,c.data)}},_getSlotRefTag:function(c){if(!c||!c.slotName)return"";c=c.slotName;return c.length<4?c:c.substring(0,1)+c.substring(c.length-2,c.length)},_getPlacementID:function(c){return!c||!c.placementID?"":f.last(c.placementID,4).join("")},_addRefTag:function(c,b){var a,d,e;d=c.indexOf("#");d===-1?e="":(e=c.substring(d),c=c.substring(0,d));a=c.indexOf("?");a===-1?d="":(d=c.substring(a),c=c.substring(0,a));a=c;a[a.length-1]==="/"&&(a=a.substring(0,a.length-1));a=a.split("/");f.last(a).indexOf("ref=")===0&&(a=f.initial(a));b=b.replace(/%/g,"");d=gb.utils.clearUrlParam(d,"ref_");a.push("ref="+b);return a.join("/")+d+e},generateRef:function(c,b,a){return this.creatRefTag(c,b,a,this.widgetMetricsParams[c]||{})},recordRefViaAjax:function(c){c&&i.$.ajax({type:"POST",url:"/gp/deal/ajax/record-ref.html/ref="+c,aysnc:!0})}})});gb.execute(function(i,f){k.GBSubnavMetrics=GBMetrics.extend({initialize:function(c){GBMetrics.prototype.initialize.call(this);this.registerWidgetMetricParams(c.widgetName,c.domElementID)},addMetricsParams:function(c,b,a,d){if(!c||!b)return"";var e=this.widgetMetricsParams[b]||{},b=this._creatRefTag(b,a,d,e),c=this._addRefTag(c,b);return c=this._addAmabotClickParameters(c,e)},_creatRefTag:function(c,b,a,d){var c=this.widgetRefTags[c]||"--",b=b||"---",e=this._getSlotRefTag(d),d=this._getPlacementID(d),a=f.map(a,function(a){if(a===null||a===m)a="";return(a+"").replace(/[_ ]/g,"")}),a=f.filter(a,function(a){return!!a}),a=f.map(a,function(a){return a.substring(0,8)}).join("_");return[c,b,e,d,a].join("_")}})});gb.execute(function(i,f){k.GBLinkGenerator=i.Collection.extend({redirectionLink:null,initialize:function(c){this.redirectionLink=this._populateRedirectionBaseUrl(c)},_populateRedirectionBaseUrl:function(c){var b;c==="pc"&&(b=gb.resources.getString("gb_app_all_deals_url"),b=b.trim());return b=b||gb.enums.RedirectionLinks[c].ALL_DEALS},generateRedirectLink:function(c,b){var a=this;if(!f.isEmpty(c.dealDisplay)){var d=[];f.map(c.dealDisplay,function(a){d.push(f.keys(a))});c.dealTypes=d}var e,g={brands:"gb_bnd",dealGroups:"gb_dgp",dealStates:"gb_dst",dealTypes:"gb_dtp",enforcedCategories:"gb_cat",enforcedDealIDs:"gb_edi",enforcedMerchantIDs:"gb_emi",excludedCategories:"gb_exc",excludedDealIDs:"gb_exd",excludedExtendedFilters:"gb_exf",exclusiveTargetKeys:"gb_exk",exclusiveTargetValues:"gb_exv",expiringWithin:"gb_exp",extendedFilters:"gb_ext",fromTime:"gb_frt",freeShippingEligibleOnly:"gb_fso",globalEligibleOnly:"gb_geo",inclusiveTargetKeys:"gb_tgk",inclusiveTargetValues:"gb_tgv",minRating:"gb_mnr",primeEligibleOnly:"gb_peo",prioritizedDealIDs:"gb_pdi",redirectPageTitle:"gb_ttl",sortOrder:"gb_srt",toTime:"gb_tot"};f.each(g,function(d,l){if(!(b===gb.enums.Constants.PAGINATED_METADATA_VERSION&&d===g.dealGroups)&&(e=c[l],!f.isEmpty(e))){switch(d){case g.exclusiveTargetValues:case g.inclusiveTargetValues:var p="";f.each(e,function(a){p+="["+a.join()+"],"});e=p.slice(0,-1);break;case g.extendedFilters:case g.excludedExtendedFilters:e=JSON.stringify(e);break;default:typeof e!=="string"&&(e=e.join())}a.redirectionLink=gb.utils.setUrlParam(a.redirectionLink,d,encodeURIComponent(e))}},b);return a.redirectionLink}})});gb.execute(function(i,f){k.GBMetricsManager=i.Model.extend({asinImpressionsHash:{},ClientActions:{ADD_TO_CART:"A",JOIN_WAITLIST:"J",WATCH_DEAL:"W",SEE_MORE:"M",TITLE:"T",REVIEWS:"R",SHARE_DEAL:"S",IMAGE:"I",DEAL_CLICK:"D",LEARN_MORE:"L",TRY_PRIME:"P"},cdsCallIntervalRef:null,cdsPollInterval:3E5,initialize:function(){var c=this;i.$(k).unload(function(){k.clearInterval(c.cdsCallIntervalRef);c.cdsCallIntervalRef=null;c.reportImpression()});c.cdsCallIntervalRef=k.setInterval(function(){c.reportImpression()},c.cdsPollInterval)},recordRender:function(c,b,a){if(!c||!b)return null;a=this.getMetricsLogPosition(c,b,a);if(!a)return null;this.asinImpressionsHash[c]||(this.asinImpressionsHash[c]={});this.asinImpressionsHash[c][b]||(this.asinImpressionsHash[c][b]={});this.asinImpressionsHash[c][b][a]||(this.asinImpressionsHash[c][b][a]={});return a},recordAction:function(c,b,a,d){if(c&&b&&a&&f.contains(f.keys(this.ClientActions),a)&&(d=this.recordRender(c,b,d)))this.asinImpressionsHash[c][b][d][this.ClientActions[a]]||(this.asinImpressionsHash[c][b][d][this.ClientActions[a]]=0),this.asinImpressionsHash[c][b][d][this.ClientActions[a]]++},reportImpression:function(){var c=this,b={};f.each(this.asinImpressionsHash,function(a,d){var e=c.getImpressionRef(d);if(e){var g=[];f.each(a,function(a,d){var b=gb.controller.getDealDAO(d);if(b){var c=b.detail.impressionAsin;if(c){var e=[c,d];gb.utils.isDealActionable(d)&&e.push("Y");b=b.status.percentClaimed;f.isNumber(b)&&b>0&&e.push(b);f.each(a,function(a,d){e.push(d);var b=[];f.each(a,function(a,d){b.push(d,a)});b.length&&e.push(b.join(""))});g.push(e.join("-"))}}});g.length&&(b[e]=g.join())}});this.splitCallClickStream(b);this.asinImpressionsHash={}},splitCallClickStream:function(c){if(!f.isEmpty(c)){var b=gb.utils.setUrlParam(gb.enums.AJAXLinks.CDS,"sID",gb.resources.getCustomerData("sessionId")),b=gb.utils.setUrlParam(b,"oID",gb.controller.contentMetadata.originRID),a=JSON.stringify(c),b=gb.utils.setUrlParam(b,"imp",a);if(k.encodeURIComponent(b).length<=2E3)gb.utils.callAsyncAjax(b);else if(b=f.keys(c),b.length){var d={},e={};if(b.length===1){var g=c[b[0]].split(",");if(g.length<=1)return;a=g.slice(0,Math.ceil(g.length/2));g=g.slice(Math.ceil(g.length/2),g.length);d[b[0]]=a.join();e[b[0]]=g.join()}else a=b.slice(0,Math.ceil(b.length/2)),b=b.slice(Math.ceil(b.length/2),b.length),f.each(a,function(a){d[a]=c[a]}),f.each(b,function(a){e[a]=c[a]});this.splitCallClickStream(d);this.splitCallClickStream(e)}}},getImpressionRef:function(c){if(c){var b=gb.configManager.getWidgetViewConfig(c).clickStreamRefMarker,a=gb.metrics.widgetMetricsParams[c],b=[b,a.slotName,a.placementID];gb.controller.schedulingParams[c].enforceLimitedDeals&&b.push("Y");return b.join(".")}},getMetricsLogPosition:function(c,b,a){if(!c||!b)return null;if(!gb.widgets[c]||!gb.widgets[c].dealViews[b])return null;var d=gb.widgets[c],b=d.dealViews[b][a],a=gb.controller.widgetCurrentPage[c]-1,e=b.position,d=d.dealsPerRow,g=0,h=e;b.row!==m&&b.column!==m?(g=b.row,h=b.column):gb.controller.schedulingParams[c].enforceLimitedDeals||(g=Math.floor(e/d),h=e%d);if(gb.controller.schedulingParams[c].enforceLimitedDeals||!gb.controller.schedulingParams[c].enablePagination)a=0;c=[g,h,a];b.isDoubleCell===!0&&c.push("Y");return c.join(".")}})});gb.execute(function(i,f){k.GBWidgetClientSideHelper=i.Model.extend({callBins:{},callDataArray:{},callID:{},previousDeficit:{},allDealsFetched:{},shouldReduceDeals:{},registerWidgetData:function(c,b){var j;this.callBins[c]=[];this.callID[c]=0;this.allDealsFetched[c]=!1;this.previousDeficit[c]=0;this.shouldReduceDeals[c]=!0;var a=gb.widgets[c],d=gb.controller.schedulingParams[c],e=gb.configManager.getWidgetViewConfig(c),g=d.dealDisplay;if(f.isEmpty(g))if(g=e.defaultNumberOfRows,d.dealTypes){var h=d.dealTypes.join(","),l={};l[h]={rows:g};g=[l]}else g=[{"":{rows:g}}];else h=g[g.length-1],l=f.keys(h),h=h[l[0]],h.deals?this.shouldReduceDeals[c]=!1:h.rows&&(this.shouldReduceDeals[c]=!0);d.dealDisplay=g;a=a.dealsPerRow;j=this.callDataArray[c]=(0,this[e.callDataBuilder])(g,a),e=j;if(!f.isEmpty(d.dealGroups)&&d.enforceLimitedDeals)this.previousDeficit[c]=this.calculatePreviousDeficit(b.sortedDealIDs,a,d.showDoubleCellDOTD);else if(!d.isCritical)if(g=e[0].dealsPerPage,this.callID[c]++,d.enforceLimitedDeals){e=e[0].scheduledDealData;if(!f.isEmpty(b)&&e.rows&&e.rows)b.sortedDealIDs=this.filterDisplayableDealsArray(b.sortedDealIDs,e.rows*a,d.showDoubleCellDOTD);this.previousDeficit[c]=this.calculatePreviousDeficit(b.sortedDealIDs,a,d.showDoubleCellDOTD)}else if(!d.fetchSinglePage)d.pageSize=g},getGBSuppleCallDataArray:function(c,b){var a=[],d=!0;f.each(c,function(c){f.each(c,function(c,e){var l={};l.dealTypes=e&&e!=="ALL"?e.split(","):[];if(c.deals)l.dealsPerPage=c.deals;else if(c.rows)l.dealsPerPage=c.rows*b,d||(l.dealsPerPage+=b);l.dealStates=[];if(c.dealStates)l.dealStates=c.dealStates.split(",");l.scheduledDealData=c;l.dealsPerPage&&(a.push(l),d=!1)})});return a},fetchCallDataArrayDeals:function(c){var b=this.callID[c],a=this.callDataArray[c];if(a.length>b){var d=gb.controller.schedulingParams[c],e=a[b];d.page=1;d.pageSize=e.dealsPerPage;d.dealTypes=e.dealTypes;d.dealStatesDD=e.dealStates;d={metaParams:{}};d.metaParams.callDataArray=a;d.metaParams.callID=b;gb.service.fetchDealWithData(c,d,gb.controller.updatePage)}else this.allDealsFetched[c]=!0,typeof gb.widgets[c].renderLaunchCell==="function"&&gb.widgets[c].renderLaunchCell()},buildSortedDealsArray:function(c,b){var a=gb.widgetHelper.callID[c],d=this.callBins[c][a],e=gb.metadata.sortedDealIDs[c],g=this.callDataArray[c][a].scheduledDealData,a=gb.controller.schedulingParams[c];if(g.rows){var h=0,h=d.length;a.showDoubleCellDOTD&&(h=h+f.intersection(gb.metadata.dealsByType[gb.enums.DealTypes.DOTD],d).length+f.intersection(gb.metadata.dealsByAccessType[gb.enums.DealAccessTypes.PRIME_ONLY_DOTD],d).length);g=g.rows*b;g+=this.previousDeficit[c];d=this.filterDisplayableDealsArray(d,h>=g?g:h,a.showDoubleCellDOTD)}e=f.union(e,d);this.previousDeficit[c]=this.calculatePreviousDeficit(e,b,a.showDoubleCellDOTD);return e},filterDisplayableDealsArray:function(c,b,a){var d=[];f.each(c,function(c){if(b>0){var g=a?f.contains(gb.metadata.dealsByType[gb.enums.DealTypes.DOTD],c)||f.contains(gb.metadata.dealsByAccessType[gb.enums.DealAccessTypes.PRIME_ONLY_DOTD],c):!1;b===1&&g||(d.push(c),g?b-=2:b--)}else return!1});return d},calculatePreviousDeficit:function(c,b,a){var d=0,a=a?gb.metadata.getDOTDCount(c):0,c=c.length+a;c%b!==0&&(d=b-c%b);return d}})});gb.execute(function(i,f){k.GBFilterMetrics=GBMetrics.extend({_filterRefTags:{CATEGORIES:"wht",DEAL_STATE:"dls",DEAL_TYPE:"dlt",DISCOUNT:"dct",PRICE:"prc",REVIEW_RATING:"acr",PAGE:"page",PRIME_ELIGIBLE_ONLY:"prm",PRIME_ACCESS_TYPE:"dlt",SORT_ORDER:"sort"},_filterAttrToHandlers:{CATEGORIES:"_getCategoriesMetric",DEAL_STATE:"_getDealStateMetric",DEAL_TYPE:"_getDealTypeMetric",DISCOUNT:"_getDiscountMetric",PRICE:"_getPriceMetric",REVIEW_RATING:"_getReviewRatingMetric",PAGE:"_getPageMetric",PRIME_ELIGIBLE_ONLY:"_getPrimeEligibleMetric",PRIME_ACCESS_TYPE:"_getDealTypeMetric",SORT_ORDER:"_getSortOrderMetric"},_dealStateRefTags:{ACTIVE:"ACTV",MISSED:"MISD",UPCOMING:"UPCM"},_dealTypeRefTags:{BEST_DEAL:"BD",COUPON_DEAL:"CPN",DEAL_OF_THE_DAY:"DOTD",LIGHTNING_DEAL:"LD",PRIME_EARLY_ACCESS:"PEA"},_sortOrderRefTags:{BY_BEST_SELLING:"BSEL",BY_DISCOUNT_ASCENDING:"DCTA",BY_DISCOUNT_DESCENDING:"DCTD",BY_PRICE_ASCENDING:"PRCA",BY_PRICE_DESCENDING:"PRCD",BY_RELEVANCE:"FEAT",BY_SCORE:"RELV",BY_START_TIME:"STRT"},_primeEligibleRefTag:{ISPM:"ISPM"},initialize:function(){GBMetrics.prototype.initialize.call(this);var c=this;this._binningParamsWithHandlersToAttr={};f.each(f.keys(this._filterAttrToHandlers),function(b){c._binningParamsWithHandlersToAttr[gb.enums.BinningParams[b].key]=b});this._getCategoriesMetric=f.wrap(m,this._metricsChangeWrapper);this._getDealStateMetric=f.wrap(this._transformDealStateValue,this._metricsChangeWrapper);this._getDealTypeMetric=f.wrap(this._transformDealTypeValue,this._metricsChangeWrapper);this._getDiscountMetric=f.wrap(this._transformDiscountValue,this._metricsChangeWrapper);this._getPriceMetric=f.wrap(m,this._metricsChangeWrapper);this._getReviewRatingMetric=f.wrap(m,this._metricsChangeWrapper);this._getPageMetric=f.wrap(m,this._metricsChangeWrapper);this._getPrimeEligibleMetric=f.wrap(this._transformPrimeEligibleValue,this._metricsChangeWrapper);this._getSortOrderMetric=f.wrap(this._transformSortOrderValue,this._metricsChangeWrapper)},appendFilterMetricParams:function(c,b,a,d){return d instanceof Array&&d.length===3?(d=this._getFilterMetricData(d),this.addMetricsParams(c,b,a,d)):c},_getFilterMetricData:function(c){var b=this._binningParamsWithHandlersToAttr[c[1]];return b?this[this._filterAttrToHandlers[b]](c,b):(b=c[1],c[0]&&b&&c.shift(),c)},_metricsChangeWrapper:function(c){var b=f.tail(arguments),a=b[0],d=a[1],a=a[2],b=b[1];c&&(a=c.call(this,a));if(d&&a)return[this._filterRefTags[b],a]},_transformDealStateValue:function(c){if(c===parseInt(c,10)&&gb.widgets[c]&&gb.widgets[c].widgetName===gb.enums.WidgetNames.PC_SHOVELER){var b=gb.controller.schedulingParams[c],b=f.values(b.shovelerStateConfig[b.shovelerStateTab]),b=f.flatten(b);if(f.contains(b,gb.enums.FilterStates.ACTIVE))c=gb.enums.FilterStates.ACTIVE;else if(f.contains(b,gb.enums.FilterStates.UPCOMING))c=gb.enums.FilterStates.UPCOMING;else if(f.contains(b,gb.enums.FilterStates.MISSED))c=gb.enums.FilterStates.MISSED}return this._dealStateRefTags[c]},_transformDealTypeValue:function(c){return this._dealTypeRefTags[c]},_transformDiscountValue:function(c){return c.substring(0,c.indexOf("-")+1)},_transformPrimeEligibleValue:function(c){return c?this._primeEligibleRefTag.ISPM:""},_transformSortOrderValue:function(c){return this._sortOrderRefTags[c]}})});gb.execute(function(i){k.GBConfigManager=i.Model.extend({initialize:function(){this.dealViewConfigs={};this.widgetViewConfigs={}},registerConfigs:function(f){this.registerDealViewConfigs(f.widgetName,f.dealViewConfig);this.registerWidgetViewConfigs(f.widgetName,f.widgetViewConfig)},registerDealViewConfigs:function(f,c){this.dealViewConfigs[f]=this.dealViewConfigs[f]||c},registerWidgetViewConfigs:function(f,c){this.widgetViewConfigs[f]=this.widgetViewConfigs[f]||c},getDealViewConfig:function(f){f=gb.controller.widgetName[f];return!f?null:this.dealViewConfigs[f]||null},getWidgetViewConfig:function(f){f=gb.controller.widgetName[f];return!f?null:this.widgetViewConfigs[f]||null}})});gb.execute(function(i,f){k.GBTemplateManager=i.Model.extend({templates:{},TemplateGroups:{DEAL_SHARE:"dealShare",DEAL_STATE:"dealState",DEAL_VIEW:"dealView",FILTER_VIEW:"filterView",MINI_DP_DEAL_STATE:"miniDPDealState",MINI_DP_DEAL_VIEW:"miniDPDealView",WIDGET_VIEW:"widgetView"},registerTemplates:function(c,b){if(!this.templates[c]){this.templates[c]={};var a=this,d={};f.each(f.values(this.TemplateGroups),function(c){b[c]&&(d[c]=a._fetchTemplates(b[c]))});f.isEmpty(d)||(this.templates[c]=d)}},_fetchTemplates:function(c){var b={};f.each(c,function(a){var d=i.$("#"+a.id).html();b[a.name]=f.template(d)});return f.isEmpty(b)?null:b},hasTemplate:function(c){var b=c.widgetID,a=c.templateGroup,c=c.templateName;if(!b||!a)return!1;if(c===null||c==="")return!1;b=gb.controller.widgetName[b];if(!b||!f.contains(f.values(this.TemplateGroups),a))return!1;a=[b,a];c!==m&&a.push(c);return!gb.utils.areNestedKeysPresent(this.templates,a.join("."))?!1:!0},getWidgetHTML:function(c){var b=c.widgetID,a=c.templateGroup,d=c.templateName,e=c.templateNames,g=c.data;if(!this.hasTemplate({widgetID:b,templateGroup:a,templateName:d}))return"";c=gb.controller.widgetName[b];if(d)return this.generateTemplate(this.templates[c][a][d],g);f.isArray(e)||(e=f.keys(this.templates[c][a]));var h={},l=this;f.each(e,function(d){h[d]=l.getWidgetHTML({widgetID:b,templateGroup:a,templateName:d,data:g})});return h},generateTemplate:function(c,b){return!c?"":f.isFunction(c)?c({data:b||{}}):f.isString(c)?f.template(c,{data:b||{}}):""}})});gb.execute(function(i,f){k.GBDealDAO=i.Model.extend({initialize:function(c){this.dealID=c;this.dealType=this.offerID=this.legacyDealID=null;this.dealState=gb.enums.DealStates.LOADING;this.checkingDealStatus=!1;this.merchantID=null;this.processWatchAction=this.isDealWatched=this.isDigital=!1;this.customerState=null;this.detail={title:null,imageAsin:null,URL:null,itemType:null,buyAsin:null,primeAccessType:null,primeAccessDurationInMs:null,impressionAsin:null,marketingMessage:null,isPrimeOnly:null,isPrimeEarlyAccessDeal:null,isFulfilledByAmazon:null};this.reviews={URL:null,total:null,rating:null};this.teaser={teaserLine:null,teaserImage:null,teaserURL:null};this.auxiliaryData={breaksMAP:null,isPrimeEligible:null};this.pricingData={prices:{dealPrice:null,basisPrice:null},percentOff:null,bKind:null,unitPrice:null,baseUnit:null};this.status={percentClaimed:null,isValidDeal:1,dates:{end:null,start:null,incartEnds:null,cacheExpires:null,startForNonPrimeCustomer:null,pendingATCEnds:null},timeouts:{end:null,start:null,incartEnds:null,cacheExpires:null,earlyAccessExpires:null,pendingATCEnds:null}};this.couponCounts={total:null};this.extendedAttributes={hideAddToCart:!1};this.registerConnections();this.items={};this.selectorData={}},registerConnections:function(){this.on("RefreshView",this.changeView);this.on("RefreshMiniDetailPageView",this.changeMiniDetailPageView)},calculatePercentOff:function(){var c=this.pricingData.prices.dealPrice,b=this.pricingData.prices.basisPrice;if(c&&b&&c.max.value===c.min.value&&b.max.value===b.min.value)this.pricingData.percentOff=gb.utils.calculatePercentOff(b.max.value,c.max.value)},changeView:function(){gb.controller.refreshDealView(this.dealID)},changeMiniDetailPageView:function(){gb.controller.refreshMiniDetailPageView(this.dealID)},getAsinDAO:function(c){return this.items[c]},getVariationAsin:function(c){var b=null;f.each(this.items,function(a){f.isEqual(a.variationDimensions,c)&&(b=a)});return b}})});gb.execute(function(i){k.GBDealAsinDAO=i.Model.extend({initialize:function(f){if(!f.itemID)throw Error("Cannot create a GBDealAsinDAO object with undefined asin");this.asinID=f.itemID;this.timeouts={};this.dealID=f.dealID;this.parentDealDAO=null;if(f.parentItemID)this.parentDealDAO=gb.controller.getDealDAO(f.parentItemID);this.marketplaceID=gb.resources.customerData.marketplaceId;this.dealPriceFormatted=gb.utils.getFormattedPrice(f.dealPrice);this.bKind=f.bKind;this.percentOff=f.percentOff;this.basisPriceFormatted=gb.utils.getFormattedPrice(f.bAmount);this.imageURL=gb.baseUtils.checkAndSetSSLImageUrl(f.primaryImage);this.status={itemState:null,customerState:null,percentClaimed:null,dates:{incartEnds:null,pendingATCEnds:null},timeouts:{incartEnds:null,pendingATCEnds:null}};this.variationDimensions=f.variationDimensions;this.auxiliaryData={isPrimeEligible:f.isPrimeEligible,breaksMAP:null,merchantDetails:{merchantID:f.merchantID,merchantName:f.merchantName}}}})});gb.execute(function(i){k.GBFilterModelFactory=i.Model.extend({getFilterModel:function(f,c){var b=null;f&&c&&(b={widgetGroupID:c},b=gb.widgets[f].widgetName===gb.enums.WidgetNames.PC_SHOVELER?new GBShovelerFilterModel(b):new GBFilterModel(b));return b}})});gb.execute(function(i,f){k.GBFilterModel=i.Model.extend({initialize:function(){this._selectedFilterValues={};this.availableFilterOptions={};this.hasPageChanged=!1;this.filterPlurals={};this.redirectURL=this.widgetGroupAnchor=null;this.doPageRefresh=!1;this.filterConfigValuesHash={};this.attributesList=[];this.attributesWithDisabledValues=[];this.selectedFiltersCount=0;this.setFilterValue=f.wrap(this._setFilterValue,this._filterChangeWrapper);this.addFilterValue=f.wrap(this._addFilterValue,this._filterChangeWrapper);this.removeFilterValue=f.wrap(this._removeFilterValue,this._filterChangeWrapper);this.removeAllFilterValues=f.wrap(this._removeAllFilterValues,this._filterChangeWrapper)},mergeFilters:function(c){var b=this;b.widgetGroupAnchor=c.schedulingParams.widgetAnchorName||b.widgetGroupAnchor;f.each(gb.enums.DCSQueryParams,function(a){var e=c.schedulingParams[a];if(f.isArray(e)?!f.isEmpty(e):e){f.isArray(e)&&(e=f.clone(e));a===gb.enums.DCSQueryParams.DEAL_STATE&&(e=f.map(e,function(a){return gb.enums.DealStatesToFilterStates[a]}),e=f.unique(e));if(a===gb.enums.DCSQueryParams.PRICE_RANGE)a=gb.enums.BinningParams.PRICE.key;if(a===gb.enums.DCSQueryParams.DISCOUNT_RANGE)a=gb.enums.BinningParams.DISCOUNT.key,e=e.join(",");b._selectedFilterValues[a]=e}});f.each(c.schedulingParams.extendedFilters,function(a,c){c===gb.enums.BinningParams.NEW_RELEASES.key&&(a=[1]);c===gb.enums.BinningParams.DISCOUNT.key&&(a=a.join(","));f.isArray(a)&&(a=f.clone(a));b._selectedFilterValues[c]=a});var a=c.schedulingParams.filterConfig;f.each(a,function(a){var c=f.map(a.attr.split(","),i.$.trim);f.each(c,function(g,h){if(a.plural){var l=f.map(a.plural.split(","),i.$.trim);b.filterPlurals[g]=l[h]}if(a.values){var l=c.length>1?a.values[h]:a.values,p=b.getDCSQueryParamForBinningKey(g);b._selectedFilterValues[p]&&f.isEqual(b._selectedFilterValues[p],l)&&delete b._selectedFilterValues[p];if(g===gb.enums.BinningParams.DEAL_STATE.key){var k=[];f.each(l,function(a){k.push(gb.enums.FilterStatesToDealStates[a])});l=f.flatten(k,!0)}b.filterConfigValuesHash[g]=l}if(a.disableValues)b.attributesWithDisabledValues=f.union(b.attributesWithDisabledValues,g)})});b.attributesList=f.union(b.attributesList,gb.utils.getFilterAttributesList(a));b.populateAvailableFilters(c.dcsServerResponse.binning);gb.filterController.trigger("gbfilter:mergeFilters",this)},getDCSQueryParamForBinningKey:function(c){var b=gb.enums.BinningKeyToDCSQueryParamMap[c];if(!b||f.isArray(b))b=c;return b},getSelectedBinningValues:function(c){return this._selectedFilterValues[this.getDCSQueryParamForBinningKey(c)]},getSelectedFilters:function(c,b){var a=f.map(this._selectedFilterValues,function(a,e){if(b&&!f.contains(b,e))return{};if(e!==gb.enums.DCSQueryParams.SORT_ORDER&&e!==gb.enums.DCSQueryParams.PAGE&&e!==gb.enums.DCSQueryParams.MIN_RATING)if(e===gb.enums.DCSQueryParams.PRIME_ELIGIBLE_ONLY||e===gb.enums.DCSQueryParams.GLOBAL_ELIGIBLE_ONLY||e===gb.enums.DCSQueryParams.FREE_SHIPPING_ELIGIBLE_ONLY)a=!0;else if(e===gb.enums.DCSQueryParams.PRIME_ACCESS_TYPE)a=a.toString();else if(e===gb.enums.BinningParams.DISCOUNT.key){if(!c)e=gb.enums.DCSQueryParams.DISCOUNT_RANGE;a=a.split(",")}else if(e===gb.enums.BinningParams.GIFT_WRAPPABLE.key||e===gb.enums.BinningParams.CASH_ON_DELIVERY.key||e===gb.enums.BinningParams.FULLFILLED_BY_AMAZON.key)a=a?["true"]:["false"];else{f.isArray(a)||(a=[a]);if(e===gb.enums.DCSQueryParams.DEAL_STATE){var g=[];f.each(a,function(a){g.push(gb.enums.FilterStatesToDealStates[a])});a=f.flatten(g,!0)}if(!c&&e===gb.enums.BinningParams.PRICE.key)e=gb.enums.DCSQueryParams.PRICE_RANGE}return[e,a]});return f.object(a)},populateAvailableFilters:function(c){var b=this;f.each(c,function(a,d){f.isEmpty(a)?delete b.availableFilterOptions[d]:b.availableFilterOptions[d]=a});b.updateSelectedFiltersCount()},_setFilterValue:function(c,b){this._selectedFilterValues[c]=b},_addFilterValue:function(c,b){this._selectedFilterValues[c]=this._selectedFilterValues[c]||[];this._selectedFilterValues[c].push(b)},_removeFilterValue:function(c,b){var a=f.flatten([this._selectedFilterValues[c]],!0);this._selectedFilterValues[c]=f.without(a,b);if(typeof b==="undefined"||!this._selectedFilterValues[c].length)this._selectedFilterValues[c]=null,delete this._selectedFilterValues[c]},_filterChangeWrapper:function(c){var b=f.tail(arguments),a=this.getDCSQueryParamForBinningKey(b[0]),d=b[1],e=b[2],b=b[3];c.call(this,a,d);if(a===gb.enums.DCSQueryParams.PAGE)this.hasPageChanged=!0;if(!f.isUndefined(e)&&(f.isUndefined(d)?e.context=gb.metrics.refTags.clearFilter:e.data.push(d),a=e.widgetID,d=gb.configManager.getWidgetViewConfig(a).refreshWidgets))for(a in gb.widgets)if(gb.widgets[a].widgetName===d){e.widgetID=a;break}b||this.triggerChangeEvent(e)},_removeAllFilterValues:function(){var c=this._selectedFilterValues[gb.enums.DCSQueryParams.SORT_ORDER];this._selectedFilterValues={};this._setFilterValue(gb.enums.DCSQueryParams.SORT_ORDER,c)},triggerChangeEvent:function(c){this.hasPageChanged||(this._selectedFilterValues[gb.enums.DCSQueryParams.PAGE]=1,gb.controller.widgetCurrentPage[c.widgetID]=1);c.eventID&&!gb.resources.deviceInfo.isPhone&&gb.clientName===gb.enums.MobileClients.APP&&n.when("a-popover").execute(function(b){(b=b.get(gb.enums.WidgetViewIDs.REFINE_POPOVER_NAME))&&b.hide()});this.hasPageChanged=!1;gb.filterController.trigger("gbfilter:change",this,c)},updateSelectedFiltersCount:function(){var c=this;c.selectedFiltersCount=0;f.each(c.attributesList,function(b){c.getSelectedBinningValues(b)&&c.selectedFiltersCount++})},getSelectedFilterCount:function(){return this.selectedFiltersCount}})});gb.execute(function(i,f){k.GBShovelerFilterModel=GBFilterModel.extend({Constants:{DISABLED:"disabled",SHOVL_NEXT:"shovelNext",SHOVL_PREVIOUS:"shovelPrevious",SHOVL_STATE_TAB:"shovelerStateTab"},initialize:function(){GBFilterModel.prototype.initialize.call(this);this._initalizeFilterChangeHandlers();this._updateDealStates=f.wrap(this._updateDealStatesHandler,this._filterChangeWrapper)},_initalizeFilterChangeHandlers:f.once(function(){var c=this;i.A.declarative("gbshovl-state","click",f.wrap(function(b,a){var d=gb.controller.schedulingParams[a.widgetID],c=d.shovelerStateTab,g=parseInt(b.data.tabIndex,10);if(c!==g)c=gb.widgets[a.widgetID],c.renderShovlButtonsContent(!0),c.skinDomElement.find("#"+gb.enums.WidgetViewIDs.SHOVL_PAGINATION).html(""),d.shovelerStateTab=g,gb.widgets[a.widgetID].renderStateHeader(),gb.filterController.models[a.metrics.eventID]._updateDealStates(a.attribute,a.widgetID,a.metrics)},c._shovlFilterChangeWrapper));i.A.declarative("gbshovl-pagination","click",f.wrap(function(b,a){if(b.data.buttonStatus!==c.Constants.DISABLED){gb.widgets[a.widgetID].renderShovlButtonsContent(!0);var d=gb.controller.widgetCurrentPage[a.widgetID],e=b.data.actionType;e===c.Constants.SHOVL_NEXT?d++:e===c.Constants.SHOVL_PREVIOUS&&d--;e=parseInt(b.data.totalPages,10);d>=1&&d<=e&&(e=gb.filterController.models[a.metrics.eventID],gb.controller.widgetCurrentPage[a.widgetID]=d,e.setFilterValue(a.attribute,d,a.metrics))}},c._shovlFilterChangeWrapper))}),_shovlFilterChangeWrapper:function(c){var b=f.tail(arguments)[0],a=parseInt(b.data.widgetID,10),d=b.data.attribute,e=gb.widgets[a].widgetGroupID;a&&e&&c.call(this,b,{attribute:d,metrics:{context:gb.metrics.refTags.filter,data:[e,d],eventID:e,widgetID:a},widgetID:a})},_updateDealStatesHandler:function(c,b){var a=gb.controller.schedulingParams[b],d=f.flatten(f.values(a.shovelerStateConfig[a.shovelerStateTab]));this._selectedFilterValues[c]=f.clone(d);this._selectedFilterValues[this.Constants.SHOVL_STATE_TAB]=a.shovelerStateTab}})});gb.execute(function(i,f){k.GBDCSTranslator=i.Model.extend({initialize:function(){this.registerConnections()},registerConnections:function(){this.on("PopulateMetadata",this.populateSelectDealsMetadata);this.on("PopulateDealDAO",this.populateDealDAO);this.on("PopulateStatus",this.populateDealStatus)},populateSelectDealsMetadata:function(c,b){var a=this;if(b&&b.dealDetails&&b.dealStatus){var d=b.dealDetails,e=b.dealStatus,g=(new Date).getTime();f.each(d,function(d,b){var c=gb.controller.getDealDAO(b),f=e[b];f.responseTimestamp=g;a.trigger("PopulateDealDAO",c,d,f)})}},populateDealDAO:function(c,b,a){this.populateDealDetails(c,b);this.populateDealStatus(c,a)},populateDealDetails:function(c,b){if(b){gb.service.dealsWithDetails[c.dealID]=!0;c.dealType=b.type;c.legacyDealID=b.legacyDealID;c.offerID=b.offerID;c.merchantID=b.merchantID;c.merchantName=b.merchantName;c.detail.title=b.title;if(b.primaryImage)c.detail.imageAsin=gb.baseUtils.checkAndSetSSLImageUrl(b.primaryImage);c.detail.description=b.description;c.detail.URL=this._setDealDetailURL(b,!1);c.detail.itemType=b.itemType;c.detail.buyAsin=b.reviewAsin;c.detail.impressionAsin=b.impressionAsin;if(b.reviewAsin)c.reviews.URL=gb.utils.getReviewsPageURL(b.reviewAsin,b.type);if(b.marketingMessage)c.detail.marketingMessage=b.marketingMessage;if(b.isFulfilledByAmazon)c.detail.isFulfilledByAmazon=b.isFulfilledByAmazon;if(b.totalReviews!==null&&b.totalReviews!==m)c.reviews.total=parseInt(b.totalReviews,10);if(b.reviewRating!==null&&b.reviewRating!==m)c.reviews.rating=parseFloat(b.reviewRating);c.auxiliaryData.isPrimeEligible=gb.resources.getCustomerData("isPrimeMarketplace")&&gb.utils.parseBool(b.isPrimeEligible);if(b.teaser)c.teaser.teaserLine=b.teaser;if(b.teaserImage)c.teaser.teaserImage=gb.baseUtils.checkAndSetSSLImageUrl(b.teaserImage);if(b.teaserAsin)c.teaser.teaserURL=this._setDealDetailURL(b,!0);c.detail.isPrimeEarlyAccessDeal=!1;c.detail.isPrimeOnly=!1;if(b.primeAccessType===gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS&&gb.resources.getFeature("prime_early_access"))c.detail.primeAccessType=gb.enums.DealAccessTypes[b.primeAccessType],c.detail.primeAccessDurationInMs=parseInt(b.primeAccessDuration,10)*6E4,c.detail.isPrimeEarlyAccessDeal=!0;else if(b.primeAccessType===gb.enums.DealAccessTypes.PRIME_ONLY_LD&&gb.resources.getFeature("prime_only_access"))c.detail.primeAccessType=gb.enums.DealAccessTypes.PRIME_ONLY_LD,c.detail.isPrimeOnly=!0;else if(b.primeAccessType===gb.enums.DealAccessTypes.PRIME_ONLY_DOTD&&gb.resources.getFeature("prime_only_access"))c.detail.primeAccessType=gb.enums.DealAccessTypes.PRIME_ONLY_DOTD,c.detail.isPrimeOnly=!0;c.auxiliaryData.breaksMAP=gb.utils.parseBool(b.isMAP);if(b.maxDealPrice!==null&&b.maxDealPrice!==m&&b.minDealPrice!==null&&b.minDealPrice!==m)c.pricingData.prices.dealPrice={max:{value:parseFloat(b.maxDealPrice)},min:{value:parseFloat(b.minDealPrice)}};if(b.maxBAmount!==null&&b.maxBAmount!==m&&b.minBAmount!==null&&b.minBAmount!==m)c.pricingData.prices.basisPrice={max:{value:parseFloat(b.maxBAmount)},min:{value:parseFloat(b.minBAmount)}};if(b.pricePerUnit!==null&&b.pricePerUnit!==m)c.pricingData.unitPrice={value:parseFloat(b.pricePerUnit)},c.pricingData.unitPrice.formattedValue=gb.utils.getFormattedPrice(c.pricingData.unitPrice.value);if(b.baseUnitValue!==null&&b.baseUnitValue!==m&&b.baseUnitName!==null&&b.baseUnitName!==m)c.pricingData.baseUnit={value:b.baseUnitValue,name:b.baseUnitName};f.each(c.pricingData.prices,function(a,d){(a!==null||a!==m)&&f.each(a,function(a,b){c.pricingData.prices[d][b].formattedValue=gb.utils.getFormattedPrice(c.pricingData.prices[d][b].value)})});if(b.maxPercentOff&&b.minPercentOff){var a=parseInt(b.maxPercentOff,10),d=parseInt(b.minPercentOff,10);if(a===d)c.pricingData.percentOff=gb.utils.getDisplayablePercentOff(a)}(c.pricingData.percentOff===null||c.pricingData.percentOff===m)&&c.calculatePercentOff();c.detail.itemType===gb.enums.ItemTypes.VARIATION&&this.populateAsinDetails(b.items,c);if(b.bKind)c.pricingData.bKind=b.bKind;if(b.glProductGroup&&f.indexOf(gb.utils.digitalGlProductGroup,b.glProductGroup)!==-1)c.isDigital=!0;this._setExtendedAttributes(c,b);this._groupDealsByType(c);this._groupDealsByAccessType(c);this._executePostTranslationRules(c)}},_groupDealsByType:function(c){var b=gb.metadata.dealsByType[c.dealType]||[];b.push(c.dealID);gb.metadata.dealsByType[c.dealType]=b},_groupDealsByAccessType:function(c){var b=c.detail.primeAccessType;if(b){var a=gb.metadata.dealsByAccessType[b]||[];a.push(c.dealID);gb.metadata.dealsByAccessType[b]=a}},_setExtendedAttributes:function(c,b){var a=b.extendedAttributes;if(a&&f.isArray(a.hideAddToCart)&&a.hideAddToCart[0]==="1")c.extendedAttributes.hideAddToCart=!0},_setDealDetailURL:function(c,b){var a=c.merchantID,d=gb.clientName,e=c.egressUrl,g=e,h=c.itemType,l=c.reviewAsin;if(b)l=c.teaserAsin;e=e?e.indexOf("/dp/")===-1||e.indexOf("forceLinkOverride")!==-1:!1;if(d===gb.enums.MobileClients.PC){if(c.type===gb.enums.DealTypes.EVENT&&!e||b)g=l?gb.utils.getDetailPageURL(l,d):"";g&&a&&!gb.utils.hasConflictingDpParams(g)&&(g=gb.utils.setUrlParam(g,"smid",a))}else{if(!(c.type===gb.enums.DealTypes.EVENT&&e)){if(gb.utils.isTablet(d))d=gb.enums.Platforms.TAB;var e=gb.utils.isUnsupportedEgressURL(c),f=gb.resources.deviceInfo,h=c.type===gb.enums.DealTypes.DOTD||c.type===gb.enums.DealTypes.BD?h===gb.enums.ItemTypes.SINGLE||e||f.isWindowsPhone||f.isMetro:!1;if(b||h||c.type!==gb.enums.DealTypes.DOTD&&c.type!==gb.enums.DealTypes.BD&&c.type!==gb.enums.DealTypes.COUPON)c.type===gb.enums.DealTypes.BD&&c.itemType===gb.enums.ItemTypes.NONE&&(l=gb.utils.getAsinFromURL(c.egressUrl)),g=l?gb.utils.getDetailPageURL(l,d):""}g&&a&&!gb.utils.hasConflictingDpParams(g)&&(g=gb.utils.setUrlParam(g,"m",a));g&&(g=gb.utils.setUrlParam(g,"dealid",c.dealID))}return g=gb.utils.convertToRequesterDomainUrl(g)},populateDealStatus:function(c,b,a){if(b){var d=b.responseTimestamp,e=c.status.dates.cacheExpires;if(!(c.dealType===gb.enums.DealTypes.LD&&!gb.utils.parseBool(b.isRedemptionStatus)&&e&&e.getTime()>d)){c.customerState=null;c.checkingDealStatus=!1;if(b.percentClaimed!==m&&b.percentClaimed!==null)c.status.percentClaimed=parseInt(b.percentClaimed,10);if(b.isValid!==m&&b.isValid!==null)c.status.isValidDeal=b.isValid;if(b.msCacheTtl!==m&&b.msCacheTtl!==null)c.status.dates.cacheExpires=new Date(d+parseInt(b.msCacheTtl,10));if(b.msToEnd!==m&&b.msToEnd!==null)c.status.dates.end=new Date(d+parseInt(b.msToEnd,10));if(b.msToStart!==m&&b.msToStart!==null)c.status.dates.start=new Date(d+parseInt(b.msToStart,10));if(!gb.resources.customerData.hasEarlyAccessBenefit)d=c.status.dates.start.getTime()+c.detail.primeAccessDurationInMs,c.status.dates.startForNonPrimeCustomer=new Date(d);if(b.totalCouponCount!==m&&b.totalCouponCount!==null)c.couponCounts.total=parseInt(b.totalCouponCount,10);gb.metadata.dealsByState[b.dealState]=gb.metadata.dealsByState[b.dealState]||[];gb.metadata.dealsByState[b.dealState].push(c.dealID);if(b.dealState)c.dealState=b.dealState===gb.enums.DealStates.UPCOMING&&parseInt(b.msToStart,10)<=0?gb.enums.DealStates.COMINGSOON:b.dealState;c.detail.itemType===gb.enums.ItemTypes.VARIATION&&f.each(b.dealItemStatus,function(a,d){var b=c.getAsinDAO(d);b&&a&&gb.translator.populateAsinStatus(b,a)});if(!f.isEmpty(gb.metadata.watchedDeals)&&f.indexOf(gb.metadata.watchedDeals.ALL,c.dealID)>-1)c.isDealWatched=!0;this._setDealTimeouts(c,b);c.trigger("RefreshView");a&&a(c)}}},populateAsinStatus:function(c,b){c.status.itemState=b.itemState;c.status.customerState=b.customerState;if(b.percentClaimed!==m&&b.percentClaimed!==null)c.status.percentClaimed=b.percentClaimed;var a=gb.controller.getDealDAO(c.dealID);a.dealType===gb.enums.DealTypes.LD&&this._setAsinTimeouts(a,c,b)},translateClaimDealStatus:function(c,b,a){if(a){c={isRedemptionStatus:!0,msCacheTtl:gb.enums.DefaultPollingIntervals.LD,dealItemStatus:{}};if(a.msCacheTtl!==m&&a.msCacheTtl!==null)c.msCacheTtl=parseInt(a.msCacheTtl,10);a.dealItemStatus&&(c.dealItemStatus[b]={itemState:a.dealItemStatus.itemState,customerState:a.dealItemStatus.customerState,msToCustomerStateExpiry:a.dealItemStatus.msToCustomerStateExpiry});return c}},_setAsinTimeouts:function(c,b,a){var d=b.status.timeouts,e=b.status.dates,g=(new Date).getTime();k.clearTimeout(d.incartEnds);k.clearTimeout(d.pendingATCEnds);d.incartEnds=e.incartEnds=d.pendingATCEnds=e.pendingATCEnds=null;if(b.status.customerState===gb.enums.CustomerStates.INCART&&a.msToCustomerStateExpiry)e.incartEnds=new Date(g+parseInt(a.msToCustomerStateExpiry,10)),k.clearTimeout(d.incartEnds),d.incartEnds=gb.utils.setSafeTimeout(function(){b.status.customerState=null;c.checkingDealStatus=!0;c.trigger("RefreshView")},e.incartEnds.getTime()-g);if(b.status.customerState===gb.enums.CustomerStates.PENDINGATC&&a.msToCustomerStateExpiry)e.pendingATCEnds=new Date(g+parseInt(a.msToCustomerStateExpiry,10)),k.clearTimeout(d.pendingATCEnds),d.pendingATCEnds=gb.utils.setSafeTimeout(function(){b.status.customerState=null;c.checkingDealStatus=!0;c.trigger("RefreshView")},e.pendingATCEnds.getTime()-g)},_setDealTimeouts:function(c,b){var a=c.status.timeouts,d=c.status.dates,e=(new Date).getTime();k.clearTimeout(a.end);k.clearTimeout(a.start);k.clearTimeout(a.incartEnds);k.clearTimeout(a.earlyAccessExpires);k.clearTimeout(a.pendingATCEnds);a.end=a.start=a.incartEnds=a.earlyAccessExpires=d.incartEnds=d.pendingATCEnds=a.pendingATCEnds=c.customerState=null;if(c.dealState!==gb.enums.DealStates.SOLDOUT&&c.dealState!==gb.enums.DealStates.EXPIRED)a.end=gb.utils.setSafeTimeout(function(){c.dealState=gb.enums.DealStates.EXPIRED;c.trigger("RefreshView");gb.utils.invokeWatchDealStateTransitions(c.dealID)},d.end.getTime()-e);if(gb.utils.isDealInEarlyAccessWindow(c)){var g=c.detail.primeAccessDurationInMs+parseInt(b.msToStart,10);if(g<=parseInt(b.msCacheTtl,10))k.clearTimeout(a.earlyAccessExpires),a.earlyAccessExpires=k.setTimeout(function(){if(!gb.resources.customerData.hasEarlyAccessBenefit)c.checkingDealStatus=!0,c.dealState=gb.enums.DealStates.LOADING;c.trigger("RefreshView");gb.utils.invokeWatchDealStateTransitions(c.dealID)},g),d.cacheExpires=new Date(g+e)}if(c.dealState===gb.enums.DealStates.UPCOMING)a.start=c.dealType===gb.enums.DealTypes.LD&&gb.utils.hasPricingDetails(c)?gb.utils.setSafeTimeout(function(){c.dealState=gb.enums.DealStates.AVAILABLE;f.each(c.items,function(a){a.status.itemState=gb.enums.DealStates.AVAILABLE});gb.service.dealsWithDetails[c.dealID]=!0;gb.utils.invokeWatchDealStateTransitions(c.dealID);c.trigger("RefreshView")},d.start.getTime()-e):gb.utils.setSafeTimeout(function(){c.dealState=gb.enums.DealStates.LOADING;gb.service.dealsWithDetails[c.dealID]=!1;c.trigger("RefreshView");gb.service.getDealDetails(c.dealID);gb.utils.invokeWatchDealStateTransitions(c.dealID)},d.start.getTime()-e);if(gb.watcher.dealsInView[c.dealID])k.clearTimeout(a.cacheExpires),a.cacheExpires=k.setTimeout(function(){c.dealType===gb.enums.DealTypes.LD&&c.dealState===gb.enums.DealStates.UPCOMING&&!gb.utils.hasPricingDetails(c)?(gb.service.dealsWithDetails[c.dealID]=!1,gb.service.getDealDetails(c.dealID)):gb.service.pollDealStatus(c.dealID)},d.cacheExpires.getTime()-e);var g=b.dealItemStatus&&b.dealItemStatus[c.detail.buyAsin],h=c.detail.itemType===gb.enums.ItemTypes.VARIATION&&c.dealType===gb.enums.DealTypes.LD;if(g&&f.contains(f.values(gb.enums.CustomerStates),g.customerState)&&!h)c.customerState=g.customerState;if(c.dealType===gb.enums.DealTypes.LD&&g&&g.customerState===gb.enums.CustomerStates.INCART&&!h&&g.msToCustomerStateExpiry)d.incartEnds=new Date(e+parseInt(g.msToCustomerStateExpiry,10)),k.clearTimeout(a.incartEnds),a.incartEnds=gb.utils.setSafeTimeout(function(){c.customerState=null;c.checkingDealStatus=!0;c.trigger("RefreshView")},d.incartEnds.getTime()-e);if(c.dealType===gb.enums.DealTypes.LD&&g&&g.customerState===gb.enums.CustomerStates.PENDINGATC&&!h&&g.msToCustomerStateExpiry)d.pendingATCEnds=new Date(e+parseInt(g.msToCustomerStateExpiry,10)),k.clearTimeout(a.pendingATCEnds),a.pendingATCEnds=gb.utils.setSafeTimeout(function(){c.customerState=null;c.checkingDealStatus=!0;c.trigger("RefreshView")},d.pendingATCEnds.getTime()-e)},translateRedeemDealStatus:function(c){var b={msCacheTtl:Math.min(c.deal.msToCacheExpires,gb.enums.DefaultPollingIntervals.LD),percentClaimed:c.deal.status.percentClaimed,msToEnd:c.deal.status.msToEnd,msToStart:c.deal.status.msToStart,dealItemStatus:{},isRedemptionStatus:!0};f.each(c.deal.asins,function(a){a.isCustomerClaimed&&(b.dealItemStatus[a.asin]={customerState:gb.enums.legacyPurchaseState[a.status.purchaseStatus.state],msToCustomerStateExpiry:a.status.purchaseStatus.msToExpiry})});return b},populateAsinDetails:function(c,b){f.each(c,function(a){var d=new GBDealAsinDAO(a);b.items[a.itemID]=d})},_executePostTranslationRules:function(c){if(c.dealType==="LOCAL_DEAL"&&c.detail){var b=c.detail.URL;if(b){var a=b.match(/:\/\/(.[^\/]+)/)[1];if(a&&a.match(/^local\./)){var d=b.split(a),a=a.replace(/^local\./,"www."),b=d[0],d=d[1];if(b&&d)c.detail.URL=b+a+"/local"+d}}}}})});gb.execute(function(i,f){k.GBViewComponentBuilder=i.Model.extend({_addMetricsData:function(c){c.getReffedURL=gb.metrics.partiallyAppliedReffedURLFunction({widgetID:c.widgetID,data:[c.deal&&c.deal.dealID]});return c},_addMobileReffedDetailURL:function(c){var b="",b=c.deal.dealState===gb.enums.DealStates.UPCOMING||c.deal.dealState===gb.enums.DealStates.COMINGSOON?c.deal.teaser.teaserURL:c.deal.detail.URL;c.mobileReffedDetailURL=c.getReffedURL(b,gb.metrics.refTags.mobile);return c},_getWidgetViewFlexModelData:function(c,b){var a=gb.configManager.getWidgetViewConfig(c.widgetID),d=document.documentElement.style;if(a.allowFlexRendering&&("flexWrap"in d||"WebkitFlexWrap"in d||"msFlexWrap"in d)){var d=function(d,b){var d=gb.utils.getWindowWidth(d,{hasMargin:a.hasMargin}),c=a.supportEvenColumnsOnly?b-b%2:b;return d=(d-Math.floor(d*0.05)*c)/c},e=d(i.$(k).width(),c.dealsPerRow),g=gb.configManager.getDealViewConfig(c.widgetID);if(Math.abs(g.dealsPerRowL-g.dealsPerRowP)===1){var h,l;c.viewOrientation===gb.enums.ClientOrientation.PORTRAIT?(h=i.$(k).width(),l=i.$(k).height()):(l=i.$(k).width(),h=i.$(k).height());h=g.dealsPerRowP===c.dealsPerRow?e:d(h,g.dealsPerRowP);d=g.dealsPerRowL===c.dealsPerRow?e:d(l,g.dealsPerRowL);e=h<d?h:d}b.doFlexRendering=!0;b.dealWidth=e+"px";d=b.elements||{};d.flexContainer=gb.templateManager.getWidgetHTML({widgetID:c.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"flexContainer",data:b});b.elements=d}},getWidgetViewTemplateData:function(c,b){var a=c.widgetID,d=gb.controller.schedulingParams[a],e=gb.enums.WidgetViewIDs,g=gb.enums.WidgetHeaderIDs,h=gb.configManager.getDealViewConfig(a),l=c.dealsPerRow,f,i=gb.watcher.lowestDealIDWatchedIndex[a]+1-c.nextPositionToRender,k=Math.ceil(i/d.pageSize);f=Math.ceil((c.nextPositionToRender+1)/d.pageSize);if(d.enforceLimitedDeals||d.enablePagination)var k=1,o=d.pageSize,i=Math.min(gb.metadata.selectedDealsCount[a]-(gb.controller.widgetCurrentPage[a]-1)*o,o);var s=b?1:f,o=gb.enums.Constants.MAX_SUPPLE_DEALS_TO_DISPLAY;if(d.pageSize)o=d.pageSize;f=this._getCurrentCategory(a);var m=this._getCurrentStates(a),n=gb.utils.getFilterViewIDs(d.filterConfig),q=d.redirectText||gb.resources.getString("gb_see_all_deals"),e={widgetView:c,schedulingParams:d,widgetID:a,widgetGroupID:c.widgetGroupID,viewIDs:e,filterViewIDs:n,totalDeals:gb.metadata.getAllDisplayableDealIDs(a).length,totalDealsToShowCount:gb.controller.totalDealsToShow[a],orientation:c.viewOrientation,dealViewCount:c.nextPositionToRender,dealViewConfig:h,firstPage:s,columnCount:l,cellCount:i,pagesToDraw:k,pageSize:o,seeAllText:q,WidgetHeaderIDs:g,selectedFilterCount:gb.filterController.models[c.widgetGroupID]?gb.filterController.models[c.widgetGroupID].getSelectedFilterCount():0,sortOptionSelected:gb.resources.getString(gb.enums.SortOrdersToStringsMap[d.sortOrder]),nextAdSlotToRenderIndex:c.nextAdSlotToRenderIndex,currentCategory:f,currentStates:m};this._getWidgetViewFlexModelData(c,e);g=gb.controller.widgetCurrentStatus[a];if(f){if(gb.controller.isPaginatedMetadataCall(a))e.dealCount=gb.metadata.getAllDisplayableDealIDs(a).length;if(gb.metadata.sortedDealIDs[a][g]&&gb.metadata.sortedDealIDs[a][g][f])e.dealCount=gb.metadata.sortedDealIDs[a][g][f].length}if(d.enablePagination)e.widgetLandingPageUrl=gb.utils.getWidgetLandingPageUrl(a);f=this._getNoDealsMessage(c);e.noDealsMessage=f.message;e.isFiltersSelected=f.isFiltersSelected;if(!d.enablePagination&&gb.watcher.lowestDealIDWatchedIndex[a]<e.totalDeals-1&&!d.watchedDealsWidget)e.showLoadingSpinner=!0;return this._addMetricsData(e)},getRefineTemplateData:function(c,b){var a=this.getWidgetViewTemplateData(c);a.useLinksForFilterItem=!0;var d=[];if(gb.controller.isPaginatedMetadataCall(c.widgetID)){a.useLinksForFilterItem=!1;var e=gb.metadata.binningInfo[c.widgetID].whitelist_categories,g=[];gb.resources.whitelistedCategoryList.forEach(function(a){e&&e[a]&&g.push(a)});if(g){for(var h=0;h<g.length;h++)var l=e[g[h]],d=this._getRefineRowData(l,g[h],d,b);if(f.contains(gb.filterController.models[gb.widgets[c.widgetID].widgetGroupID].attributesList,gb.enums.BinningParams.PRIME_ACCESS_TYPE.key))a.showPEALink=!0,a.PEAText=gb.resources.getString("csld-cat-prime_early_access_deals")}}else for(var h=gb.metadata.getMetadataCategories(c.widgetID),i=gb.controller.widgetCurrentStatus[c.widgetID],k=0;k<h.length;k++)l=gb.metadata.sortedDealIDs[c.widgetID][i][h[k]].length,d=this._getRefineRowData(l,h[k],d,b);a.categoryData=d;return a},_getRefineRowData:function(c,b,a,d){d=gb.resources.getCategoryName(b,d);b!==gb.enums.CategoryFilters.ALL&&(d=d+" ("+c+")");c>0&&a.push({nodeId:b,text:d});return a},getDealViewTemplateData:function(c,b){var a=c.deal;if(a.dealState===gb.enums.DealStates.LOADING)return{};var d=c.widgetView,e=gb.configManager.getWidgetViewConfig(d.widgetID),g=gb.configManager.getDealViewConfig(d.widgetID),h=null,l=!1,f=!1,k="";typeof d._isDoubleCell==="function"&&(l=d._isDoubleCell(a.dealID));if(a.dealType===gb.enums.DealTypes.COUPON||a.dealType===gb.enums.DealTypes.LOCAL)h=a.detail.marketingMessage;gb.utils.showPPU(a.dealID)&&a.pricingData.unitPrice&&a.pricingData.baseUnit&&(f=!0,k=gb.resources.getString("gb_ppu_price",{price:a.pricingData.unitPrice.formattedValue,unitValue:a.pricingData.baseUnit.value,unitName:a.pricingData.baseUnit.name}));var r=gb.controller.watchDealView?gb.controller.watchDealView._isPopupTriggerRequired(d):!1,e={widgetID:d.widgetID,widgetGroupID:d.widgetGroupID,deal:a,dealViewConfig:g,widgetViewConfig:e,position:c.position,viewIDs:gb.enums.dealViewIDs,totalDeals:gb.metadata.selectedDealsCount[d.widgetID],orientation:d.viewOrientation,marketingMessage:h,isDoubleCell:l,isPrimeEarly:a.detail.isPrimeEarlyAccessDeal,isPrimeOnly:a.detail.isPrimeOnly,showPPU:f,ppuPrice:k,isPopupTriggerRequired:r};e.showPercentOff=gb.utils.isShowPercentageOffEnabled();e.priceText=gb.utils.getPriceTextForBasisKind(a.pricingData.bKind);if(gb.templateManager.hasTemplate({widgetID:d.widgetID,templateGroup:gb.templateManager.TemplateGroups.DEAL_VIEW,templateName:"badge"}))e.badgeProperty=this.generateBadgeProperties(c);else if(gb.templateManager.hasTemplate({widgetID:d.widgetID,templateGroup:gb.templateManager.TemplateGroups.DEAL_VIEW,templateName:"primeBadge"}))e.badgeProperty=this.generatePrimeBadgeProperties(c);a.detail.itemType===gb.enums.ItemTypes.VARIATION&&gb.widgets[d.widgetID].widgetName===gb.enums.WidgetNames.ML_HERO?(e.asin=b,e.dimensionData=this._findDimensionData(a),e.selectedDimension=c.variationView.selectedDimension,e.unavailableAsinSelected=c.variationView.unavailableAsinSelected,e.templateDecisionInfo=gb.utils.getVariationCustomerActionTemplateInfo(c,b),e.priceText=b?gb.utils.getPriceTextForBasisKind(b.bKind):gb.utils.getPriceTextForBasisKind(a.pricingData.bKind),this._setDealViewTimerData(c,e,b)):(e.templateDecisionInfo=gb.utils.getCustomerActionTemplateInfo(a,d.widgetID),this._setDealViewTimerData(c,e));e.cellCount=gb.metadata.getSortedDealIDs(d.widgetID).length;e.customerRefTag=gb.service.customerID?gb.metrics.refTags.recLearnMore:gb.metrics.refTags.unrecLearnMore;e.imageSize=i.A.capabilities.hires?g.imageSizeLarge||g.imageSize:g.imageSize;return gb.resources.deviceInfo.isPhone?this._addMobileReffedDetailURL(this._addMetricsData(e)):this._addMetricsData(e)},generateBadgeProperties:function(c){var b={tagList:"",batchStyleRule:"",skewElmStyleRule:"",isPrimeBatch:!1},a=[],d=[],e=c.deal.dealType,c=c.deal.detail,g=gb.resources.getString("gb_m_deal_of_the_day");if(c.isPrimeOnly)e===gb.enums.DealTypes.DOTD?(a.push(gb.resources.getString("gb_m_prime_exclusive")),a.push(g),b.skewElmStyleRule="primeDOTDSlide",d.push("Badge162")):(a.push(gb.resources.getString("gb_m_prime_exclusive_deal")),d.push("primeDeal"),d.push("Badge234"),b.skewElmStyleRule="primeSlide",b.isPrimeBatch=!0);else if(c.isPrimeEarlyAccessDeal)a.push(gb.resources.getString("gb_m_prime_early_access_deal")),d.push("primeDeal"),b.skewElmStyleRule="primeSlide",b.isPrimeBatch=!0;if(e===gb.enums.DealTypes.DOTD){if(a.length===0)a.push(g),b.skewElmStyleRule="DOTDSlide",gb.resources.customerData.realm===gb.enums.Realms.IT||gb.resources.customerData.realm===gb.enums.Realms.BR?d.push("Badge234"):d.push("Badge160");d.push("DOTD")}b.tagList=a;b.batchStyleRule=d.join(" ");return b},generatePrimeBadgeProperties:function(c){var b={tag:"",badgeStyleRule:""};c.deal.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS?(b.tag=gb.resources.getString("gb_prime_early_access_deal_caps"),b.badgeStyleRule="primeBadge peaBadge"):c.deal.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_ONLY_LD?(b.tag=gb.resources.getString("gb_m_prime_exclusive_deal"),b.badgeStyleRule="primeBadge poBadge"):c.deal.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_ONLY_DOTD?(b.tag=gb.resources.getString("gb_prime_only_dotdl_caps"),b.badgeStyleRule="primeBadge podotdBadge"):b=null;return b},getDealOptionsTemplateData:function(c){var b={},a=c.widgetView.widgetID,d=gb.configManager.getWidgetViewConfig(a),e=gb.controller.schedulingParams[a],g=gb.utils.isShowPercentageOffEnabled();if(a){if(d.supportWatch&&c.deal.isDealWatched)b.StopWatching=gb.enums.BottomSheetActions.StopWatching;if(e.enableShareDeal)b.ShareDeal=gb.enums.BottomSheetActions.ShareDeal}return{widgetID:a,position:c.position,deal:c.deal,dealAction:b,showPercentOff:g}},getMiniDPViewTemplateData:function(c,b,a){var d=c.deal;if(d.dealState===gb.enums.DealStates.LOADING)return{};var e=c.widgetView,g=gb.configManager.getWidgetViewConfig(e.widgetID),h=gb.configManager.getDealViewConfig(e.widgetID),l=null;if(d.dealType===gb.enums.DealTypes.COUPON||d.dealType===gb.enums.DealTypes.LOCAL)l=d.detail.marketingMessage,d.dealType===gb.enums.DealTypes.COUPON&&(l=l+" "+gb.resources.getString("gb_coupon"));var f=gb.controller.watchDealView?gb.controller.watchDealView._isPopupTriggerRequiredForMiniDP(e):!1,g={widgetID:e.widgetID,widgetGroupID:e.widgetGroupID,deal:d,dealViewConfig:h,widgetViewConfig:g,position:c.position,viewIDs:gb.enums.dealViewIDs,totalDeals:gb.metadata.selectedDealsCount[e.widgetID],orientation:e.viewOrientation,marketingMessage:l,isPrimeEarly:d.detail.isPrimeEarlyAccessDeal,isPrimeOnly:d.detail.isPrimeOnly,isMiniDP:!0,isPopupTriggerRequired:f};g.showPercentOff=gb.utils.isShowPercentageOffEnabled();g.priceText=gb.utils.getPriceTextForBasisKind(d.pricingData.bKind);g.templateDecisionInfo=gb.utils.getCustomerActionTemplateInfo(d,e.widgetID);d.detail.itemType===gb.enums.ItemTypes.VARIATION?(g.asin=a,g.dimensionData=this._findDimensionData(d),g.selectedDimension=c.variationView.selectedDimension,g.unavailableAsinSelected=c.variationView.unavailableAsinSelected,g.templateDecisionInfo=gb.utils.getVariationCustomerActionTemplateInfo(c,a),this._setMiniDPAsinViewTimerData(c,a,g,b.id),g.priceText=a?gb.utils.getPriceTextForBasisKind(a.bKind):gb.utils.getPriceTextForBasisKind(d.pricingData.bKind)):(g.templateDecisionInfo=gb.utils.getCustomerActionTemplateInfo(d,e.widgetID),this._setMiniDetailPageViewTimerData(c,g,b.id));return gb.resources.deviceInfo.isPhone?this._addMobileReffedDetailURL(this._addMetricsData(g)):this._addMetricsData(g)},getDealStateTemplateData:function(c,b,a){var d=c.deal,e=c.widgetView,g=gb.configManager.getWidgetViewConfig(e.widgetID),h=gb.configManager.getDealViewConfig(e.widgetID),l=gb.enums.dealViewIDs,f=!1,i=!1,k=gb.resources.getCustomerData("realm"),o=!1;if(k===gb.enums.Realms.JP||k===gb.enums.Realms.CN)i=!0;d.dealType===gb.enums.DealTypes.LD&&gb.controller.schedulingParams[e.widgetID].fetchWatchedDeals&&(o=!0,d.detail.isPrimeOnly&&(o=gb.resources.getCustomerData("isPrimeMember")));typeof e._isDoubleCell==="function"&&(f=e._isDoubleCell(d.dealID));if(d.dealState===gb.enums.DealStates.LOADING)return{};b={widgetID:e.widgetID,widgetGroupID:e.widgetGroupID,deal:d,dealViewConfig:h,widgetViewConfig:g,position:c.position,viewIDs:l,elements:b,totalDeals:gb.metadata.selectedDealsCount[e.widgetID],orientation:e.viewOrientation,isDoubleCell:f,isPrimeEarly:d.detail.isPrimeEarlyAccessDeal,isPrimeOnly:d.detail.isPrimeOnly,showCouponCount:i,isWatchDeal:o};b.showPercentOff=gb.utils.isShowPercentageOffEnabled();b.priceText=gb.utils.getPriceTextForBasisKind(d.pricingData.bKind);d.detail.itemType===gb.enums.ItemTypes.VARIATION?(g=gb.controller.getDealDAO(c.dealID),b.asin=a,b.dimensionData=this._findDimensionData(g),b.modalFirstLoad=c.variationView?c.variationView.modalFirstLoad:!1,b.selectedDimension=c.variationView?c.variationView.selectedDimension:{},b.templateDecisionInfo=gb.utils.getVariationCustomerActionTemplateInfo(c,a),b.unavailableAsinSelected=c.variationView?c.variationView.unavailableAsinSelected:!1,b.priceText=a?gb.utils.getPriceTextForBasisKind(a.bKind):gb.utils.getPriceTextForBasisKind(d.pricingData.bKind)):b.templateDecisionInfo=gb.utils.getCustomerActionTemplateInfo(d,e.widgetID);b.cellCount=gb.metadata.getSortedDealIDs(e.widgetID).length;b.customerRefTag=gb.service.customerID?gb.metrics.refTags.recLearnMore:gb.metrics.refTags.unrecLearnMore;return gb.resources.deviceInfo.isPhone?this._addMobileReffedDetailURL(this._addMetricsData(b)):this._addMetricsData(b)},getFilterViewTemplateData:function(c){return{view:c,title:c.title,eventID:c.widgetView.widgetGroupID,widgetID:c.widgetView.widgetID,widgetName:c.widgetView.widgetName,filterType:c.type,attributes:c.attributes,filterOptions:c.filterOptions,filterConfig:c.filterConfig,attrPriority:gb.filterController.models[c.widgetView.widgetGroupID].filterAttrituesByPriority}},getAdRowViewData:function(c){return{nextAdSlotToRenderIndex:c.nextAdSlotToRenderIndex,adSlots:gb.controller.schedulingParams[c.widgetID].adSlots,widgetID:c.widgetID}},getMashRefineData:function(c){for(var b=this.getRefineTemplateData(c,!0).categoryData,a=[],d=0;d<b.length;d++)a.push(b[d].text);return{title:gb.controller.schedulingParams[c.widgetID].title,buttonTitles:a,cancelButtonTitle:gb.resources.getString("csld-cancel"),successCallback:function(a){a<b.length&&gb.controller.trigger("WidgetCategoryChange",c.widgetID,b[a].nodeId)}}},getPaginationTemplateData:function(c){var b=gb.controller.widgetCurrentPage[c.widgetID]||1,a=gb.metadata.getAllDisplayableDealIDs(c.widgetID).length,a=Math.ceil(a/gb.controller.schedulingParams[c.widgetID].pageSize);return{widgetID:c.widgetID,widgetName:c.widgetName,filterOptions:[{attribute:gb.enums.BinningParams.PAGE.key,currentPage:b,totalPages:a,dummyUrls:gb.enums.PaginationDummyURLs,minimalPagination:gb.configManager.getWidgetViewConfig(c.widgetID).minimalPagination}]}},_setDealViewTimerData:function(c,b,a){var d=c.deal,e=c.widgetView,g=a?a.status.dates.incartEnds:d.status.dates.incartEnds,h=gb.utils.getDealViewID(e.widgetID,c.position),l=h+gb.enums.dealViewIDs.DEALCLOCK,f=g?!0:!1,i=a?a.status.dates.pendingATCEnds:d.status.dates.pendingATCEnds,a=gb.resources.customerData.hasEarlyAccessBenefit,r=gb.configManager.getWidgetViewConfig(e.widgetID).forceApplyIncartTimer,o=gb.configManager.getWidgetViewConfig(e.widgetID).avoidContextBasedTimer;if(f||i){if(f){if(c.incartClock)k.clearTimeout(c.incartClock.timeout),c.incartClock=null;l=h+gb.enums.dealViewIDs.INCARTCLOCK;c.incartClock=gb.utils.heroTimer(g,c.viewElement,l,!0);b.incartTimeString=c.incartClock.timeString}else if(i){if(c.pendingAtcClock)k.clearTimeout(c.pendingAtcClock.timeout),c.pendingAtcClock=null;l=h+gb.enums.dealViewIDs.PENDINGATCCLOCK;c.pendingAtcClock=gb.utils.heroTimer(i,c.viewElement,l,!0);b.pendingatcTimeString=c.pendingAtcClock.timeString}e.widgetName===gb.enums.WidgetNames.PC_SUPPLE&&!gb.controller.schedulingParams[e.widgetID].showShortCellView&&this._genericEndDateTimerGenerator(c,b)}else if(h=(new Date).getTime(),b.timerTextColor="base",d.dealState===gb.enums.DealStates.AVAILABLE||d.dealState===gb.enums.DealStates.WAITLIST||d.dealState===gb.enums.DealStates.WAITLISTFULL)gb.utils.isDealInEarlyAccessWindow(d)&&!a?(c.clock=gb.utils.heroTimer(d.status.dates.startForNonPrimeCustomer,c.viewElement,l,r),b.timeString=c.clock.timeString,b.timerPrefix=o?gb.resources.getString("gb_starts_in"):gb.resources.getString("gb_starts_for_you_in"),b.isEarlyAccessTimer=!o,b.timerTextColor="success"):this._genericEndDateTimerGenerator(c,b);else if(d.dealState===gb.enums.DealStates.UPCOMING){g=e=d.status.dates.start;if(d.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS)b.isEarlyAccessTimer=!o,a||(e=new Date(e.getTime()+d.detail.primeAccessDurationInMs));h=e.getTime()-h;if(h>864E5)b.showDateOrTime=gb.utils.formatDate(e),b.timerPrefix=gb.resources.getString("gb_starts");else if(h>36E5){b.showDateOrTime=gb.utils.formatTime(e.getHours(),e.getMinutes());b.timerPrefix=gb.resources.getString("gb_starts_at");if(b.isEarlyAccessTimer&&!o)b.timerPrefix=a?gb.resources.getString("gb_starts_for_prime_at"):gb.resources.getString("gb_starts_for_you_at");if(d.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS&&!a)b.primeTimeString=gb.utils.formatTime(g.getHours(),g.getMinutes()),b.primeTimerPrefix=gb.resources.getString("gb_starts_for_prime_at");if(d.detail.isPrimeOnly&&!o)b.timerPrefix=gb.resources.getString("gb_starts_for_prime_at")}else{c.clock=gb.utils.heroTimer(e,c.viewElement,l,r);b.timeString=c.clock.timeString;b.timerTextColor="success";b.timerPrefix=gb.resources.getString("gb_starts_in");if(b.isEarlyAccessTimer&&!o)b.timerPrefix=a?gb.resources.getString("gb_starts_for_prime_in"):gb.resources.getString("gb_starts_for_you_in");if(d.detail.isPrimeOnly&&!o)b.timerPrefix=gb.resources.getString("gb_starts_for_prime_in");if(d.detail.primeAccessType===gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS&&!a)b.primeTimeString=gb.utils.formatTime(g.getHours(),g.getMinutes()),b.primeTimerPrefix=gb.resources.getString("gb_starts_for_prime_at")}}},_setMiniDetailPageViewTimerData:function(c,b,a){if(c.modalClock)k.clearTimeout(c.modalClock.timeout),c.modalClock=null;var d=c.deal,e=c.widgetView,g=d.status.dates.incartEnds,h=gb.utils.getDealViewID(e.widgetID,c.position),l=h+gb.enums.dealViewIDs.DEALCLOCK,f=gb.enums.WidgetViewIDs.MINI_DP_MODAL+l,i=d.status.dates.pendingATCEnds,r=gb.resources.customerData.hasEarlyAccessBenefit,o=d.dealType===gb.enums.DealTypes.LD&&d.detail.itemType!==gb.enums.ItemTypes.SINGLE,e=gb.configManager.getWidgetViewConfig(e.widgetID).forceApplyIncartTimer,s=gb.enums.WidgetViewIDs.A_POPOVER+a;if((g||i)&&!o){if(g){if(c.modalIncartClock)k.clearTimeout(c.modalIncartClock.timeout),c.modalIncartClock=null;f=gb.enums.WidgetViewIDs.MINI_DP_MODAL+h+gb.enums.dealViewIDs.INCARTCLOCK;c.modalIncartClock=gb.utils.heroTimer(g,s,f,!0);b.modalIncartTimeString=c.modalIncartClock.timeString}else if(i){if(c.modalPendingAtcClock)k.clearTimeout(c.modalPendingAtcClock.timeout),c.modalPendingAtcClock=null;f=gb.enums.WidgetViewIDs.MINI_DP_MODAL+h+gb.enums.dealViewIDs.PENDINGATCCLOCK;c.modalPendingAtcClock=gb.utils.heroTimer(i,s,f,!0);b.modalPendingatcTimeString=c.modalPendingAtcClock.timeString}a=d.status.dates.end;g=(new Date).getTime();r=a.getTime()-g;f=gb.enums.WidgetViewIDs.MINI_DP_MODAL+l;r>864E5?(b.showDateOrTime=gb.utils.formatDate(a),b.timerPrefix=gb.resources.getString("gb_ends")):d.dealType===gb.enums.DealTypes.BD&&r>36E5?(b.showDateOrTime=gb.utils.formatTime(a.getHours(),a.getMinutes()),b.timerPrefix=gb.resources.getString("gb_ends_at")):(c.modalClock=gb.utils.heroTimer(a,s,f,e),b.timeString=c.modalClock.timeString,b.timerPrefix=gb.resources.getString("gb_ends_in"))}else if(g=(new Date).getTime(),d.dealState===gb.enums.DealStates.AVAILABLE||d.dealState===gb.enums.DealStates.WAITLIST||d.dealState===gb.enums.DealStates.WAITLISTFULL)gb.utils.isDealInEarlyAccessWindow(d)&&!r&&this._setMiniDPPrimeTimerData(c,b,s),this._genericEndDateTimerGenerator(c,b,a);else if(d.dealState===gb.enums.DealStates.UPCOMING)l=d.status.dates.start,d.detail.primeAccessType?this._setMiniDPPrimeTimerData(c,b,s):(d=l.getTime()-g,d>864E5?(b.showDateOrTime=gb.utils.formatDate(l),b.timerPrefix=gb.resources.getString("gb_deal_starts")):d>36E5?(b.showDateOrTime=gb.utils.formatTime(l.getHours(),l.getMinutes()),b.timerPrefix=gb.resources.getString("gb_deal_starts_at")):(c.modalClock=gb.utils.heroTimer(l,s,f,e),b.timeString=c.modalClock.timeString,b.timerPrefix=gb.resources.getString("gb_deal_starts_in")))},_setMiniDPPrimeTimerData:function(c,b,a){if(c.modalPrimeClock)k.clearTimeout(c.modalPrimeClock.timeout),c.modalPrimeClock=null;var d=c.deal,e=c.widgetView,g=gb.resources.customerData.hasEarlyAccessBenefit,h=gb.enums.WidgetViewIDs.MINI_DP_MODAL+gb.enums.WidgetViewIDs.PRIME+gb.utils.getDealViewID(e.widgetID,c.position)+gb.enums.dealViewIDs.DEALCLOCK;gb.utils.getDealViewID(e.widgetID,c.position);e=(new Date).getTime();if(d.dealState===gb.enums.DealStates.UPCOMING){var l=d.status.dates.start;g||(l=new Date(l.getTime()+d.detail.primeAccessDurationInMs));if(l.getTime()-e>36E5){b.modalPrimeTimerPrefix=g?gb.resources.getString("gb_deal_starts_for_prime_at"):gb.resources.getString("gb_deal_starts_for_you_at");if(d.detail.isPrimeOnly)b.modalPrimeTimerPrefix=gb.resources.getString("gb_deal_starts_at");b.modalPrimeShowDateOrTime=gb.utils.formatTime(l.getHours(),l.getMinutes())}else if(c.modalPrimeClock=gb.utils.heroTimer(l,a,h,!0),b.modalPrimeTimeString=c.modalPrimeClock.timeString,b.modalPrimeTimerPrefix=g?gb.resources.getString("gb_deal_starts_for_prime_in"):gb.resources.getString("gb_deal_starts_for_you_in"),d.detail.isPrimeOnly)b.modalPrimeTimerPrefix=gb.resources.getString("gb_deal_starts_in")}else c.modalPrimeClock=gb.utils.heroTimer(d.status.dates.startForNonPrimeCustomer,a,h,!0),b.modalPrimeTimeString=c.modalPrimeClock.timeString,b.modalPrimeTimerPrefix=gb.resources.getString("gb_deal_starts_for_you_in")},_setMiniDPAsinViewTimerData:function(c,b,a,d){if(c.modalClock)k.clearTimeout(c.modalClock.timeout),c.modalClock=null;var e=c.deal;if(b){var g=b.status,h=c.widgetView,l=b.status.dates.incartEnds,f=gb.utils.getDealViewID(h.widgetID,c.position),i=gb.enums.WidgetViewIDs.MINI_DP_MODAL+(f+gb.enums.dealViewIDs.DEALCLOCK),b=b.status.dates.pendingATCEnds,i=gb.resources.customerData.hasEarlyAccessBenefit;gb.configManager.getWidgetViewConfig(h.widgetID);h=gb.enums.WidgetViewIDs.A_POPOVER+d;if(l||b){if(l){if(c.modalIncartClock)k.clearTimeout(c.modalIncartClock.timeout),c.modalIncartClock=null;i=gb.enums.WidgetViewIDs.MINI_DP_MODAL+f+gb.enums.dealViewIDs.INCARTCLOCK;c.modalIncartClock=gb.utils.heroTimer(l,h,i,!0);a.modalIncartTimeString=c.modalIncartClock.timeString}else if(b){if(c.modalPendingAtcClock)k.clearTimeout(c.modalPendingAtcClock.timeout),c.modalPendingAtcClock=null;i=gb.enums.WidgetViewIDs.MINI_DP_MODAL+f+gb.enums.dealViewIDs.PENDINGATCCLOCK;c.modalPendingAtcClock=gb.utils.heroTimer(b,h,i,!0);a.modalPendingatcTimeString=c.modalPendingAtcClock.timeString}this._genericEndDateTimerGenerator(c,a,d)}else if((new Date).getTime(),g.itemState===gb.enums.DealStates.AVAILABLE||g.itemState===gb.enums.DealStates.WAITLIST||g.itemState===gb.enums.DealStates.WAITLISTFULL)gb.utils.isDealInEarlyAccessWindow(e)&&!i&&this._setMiniDPPrimeTimerData(c,a,h),this._genericEndDateTimerGenerator(c,a,d)}else this._setMiniDetailPageViewTimerData(c,a,d)},_genericEndDateTimerGenerator:function(c,b,a){var d=(new Date).getTime(),e=c.widgetView,g=c.deal.status.dates.end,d=g.getTime()-d,h=gb.utils.getDealViewID(e.widgetID,c.position)+gb.enums.dealViewIDs.DEALCLOCK,e=gb.configManager.getWidgetViewConfig(e.widgetID).forceApplyIncartTimer;b.timerTextColor="base";if(d>864E5)b.showDateOrTime=gb.utils.formatDate(g),b.timerPrefix=gb.resources.getString("gb_ends");else if(c.deal.dealType===gb.enums.DealTypes.BD&&d>36E5)b.showDateOrTime=gb.utils.formatTime(g.getHours(),g.getMinutes()),b.timerPrefix=gb.resources.getString("gb_ends_at");else{if(a){e=gb.enums.WidgetViewIDs.MINI_DP_MODAL+h;a=gb.enums.WidgetViewIDs.A_POPOVER+a;if(c.modalClock)k.clearTimeout(c.modalClock.timeout),c.modalClock=null;c.modalClock=gb.utils.heroTimer(g,a,e,!0);b.timeString=c.modalClock.timeString}else{if(c.clock)k.clearTimeout(c.clock.timeout),c.clock=null;c.clock=gb.utils.heroTimer(g,c.viewElement,h,e);b.timeString=c.clock.timeString}b.timerPrefix=gb.resources.getString("gb_ends_in");if(d<=36E5)b.timerTextColor="success"}},getLaunchCellTemplateData:function(c){var b=gb.controller.schedulingParams[c.widgetID],a=b.redirectText||gb.resources.getString("gb_see_all_deals");return this._addMetricsData({widgetView:c,widgetID:c.widgetID,schedulingParams:b,seeAllText:a,isLocalUrl:b.redirectLink===gb.enums.MiscLinks.LOCAL_URL})},getSuppleWidgetViewTemplateData:function(c,b){var a=gb.controller.schedulingParams[c.widgetID],d=gb.enums.WidgetViewIDs,e=gb.configManager.getDealViewConfig(c.widgetID),g=c.dealsPerRow,h=gb.watcher.lowestDealIDWatchedIndex[c.widgetID]+1,l=h;if(a.enforceLimitedDeals&&a.showDoubleCellDOTD){var f=gb.metadata.getAllDisplayableDealIDs(c.widgetID),f=gb.metadata.getDOTDCount(f);l+=f}a.enforceLimitedDeals&&a.showLaunchCell&&gb.widgetHelper&&gb.widgetHelper.shouldReduceDeals[c.widgetID]&&l%c.dealsPerRow===0&&h--;l=Math.ceil(h/a.pageSize);if(a.enforceLimitedDeals||a.enablePagination)l=1;var f=b?1:gb.controller.widgetCurrentPage[c.widgetID],i=gb.enums.Constants.MAX_SUPPLE_DEALS_TO_DISPLAY;if(a.pageSize)i=a.pageSize;var k=gb.utils.getFilterViewIDs(a.filterConfig),o=c.isLeftFilterRequired,s="",m="";a.disableRestrictionsApply||(s=gb.resources.getString("gb-restrictions-apply"),m=a.customRestrictionsApply||gb.resources.getString("csld-restrictions_link"));var n=a.redirectText||gb.resources.getString("gb_see_all_deals"),d={widgetView:c,schedulingParams:a,widgetID:c.widgetID,widgetGroupID:c.widgetGroupID,viewIDs:d,filterViewIDs:k,totalDeals:gb.metadata.selectedDealsCount[c.widgetID],totalDealsToShowCount:gb.controller.totalDealsToShow[c.widgetID],orientation:c.viewOrientation,dealViewCount:c.nextPositionToRender,dealViewConfig:e,firstPage:f,columnCount:g,dealCount:h,pagesToDraw:l,pageSize:i,seeAllText:n,restrictionsApplyText:s,restrictionsApplyLink:m,title:a.title,isLeftFilterRequired:o},a=this._getNoDealsMessage(c);d.noDealsMessage=a.message;d.isFiltersSelected=a.isFiltersSelected;return this._addMetricsData(d)},getShovelerWidgetViewTemplateData:function(c){var b=gb.controller.schedulingParams[c.widgetID],a=gb.enums.WidgetViewIDs,d=gb.metadata.selectedDealsCount[c.widgetID],e=gb.controller.widgetCurrentPage[c.widgetID],g=b.pageSize,h=0;d&&(h=Math.min(g,d-(e-1)*g));var g=Math.ceil(d/g),l="",f="";b.disableRestrictionsApply||(l=gb.resources.getString("gb-restrictions-apply"),f=b.customRestrictionsApply||gb.resources.getString("csld-restrictions_link"));b={currentPage:e,lastDealIDPosition:h,restrictionsApplyText:l,restrictionsApplyLink:f,schedulingParams:b,title:b.title,totalDeals:d,totalPages:g,viewIDs:a,widgetID:c.widgetID,widgetGroupID:c.widgetGroupID};a=this._getNoDealsMessage(c);b.noDealsMessage=a.message;a=gb.resources.getCustomerData("realm");if(a===gb.enums.Realms.JP&&a===gb.enums.Realms.CN)b.increaseDealViewHeight=!0;b.gridColumnCSS="gridColumn"+c.dealsPerRow;return this._addMetricsData(b)},_findDimensionData:function(c){var b={};f.each(c.items,function(a){f.each(a.variationDimensions,function(a,c){b[c]||(b[c]=[]);b[c].push(a);b[c]=f.unique(b[c])})});return b},getCartErrorDisplayData:function(){var c=gb.resources.getString("gb-cart-error-header"),b=gb.resources.getString("gb-cart-error");return{errorAlertHeaderText:c,errorText:b}},getBottomSheetFilterContentExpanderData:function(c,b){return{view:c,filterOptions:c.filterJSONData,isSortFilter:b.isSortFilter,schedulingParams:gb.controller.schedulingParams[c.widgetID]}},getBottomSheetFilterContentData:function(c){return{view:c,filterOptionList:c.filterOptions,currentSelection:c.widgetView.filterJSONData[c.filterConfig.attr].currentSelection,attribute:c.filterConfig.attr}},getBottomSheetFilterHeaderData:function(c,b){return{title:b.title,widgetView:c.widgetView?c.widgetView:c,selectedOption:c.filterConfig?c.widgetView.filterJSONData[c.filterConfig.attr].currentSelection:"",showClearOption:b.showClearOption,enableBack:b.enableBack}},getBottomSheetFilterFooterData:function(){return{text:gb.resources.getString("csld-cancel")}},_getNoDealsMessage:function(c){var b,a,d=gb.controller.schedulingParams[c.widgetID];if(d.watchedDealsWidget){if(!gb.metadata.watchedDeals.ALL||gb.metadata.watchedDeals.ALL.length===0)gb.clientName===gb.enums.MobileClients.PC?b=gb.resources.getString("gb_no_watched_deals_punting_message",{watchDeal:"<b>"+gb.resources.getString("gb_watch_deal")+".</b>"}):gb.configManager.getWidgetViewConfig(c.widgetID).showNoWatchedDealsMessg&&(b=gb.resources.getString("gb_no_watched_deals_to_show",{watchDeal:"<b>"+gb.resources.getString("gb_watch_deal")+".</b>"}))}else if(f.isEmpty(gb.metadata.getAllDisplayableDealIDs(c.widgetID))){var e=0;if(c.widgetGroupID){var g=gb.filterController.models[c.widgetGroupID].attributesList,e=gb.filterController.models[c.widgetGroupID].getSelectedFilterCount();g.indexOf(gb.enums.BinningParams.SORT_ORDER.key)!==-1&&e--;g.indexOf(gb.enums.BinningParams.PAGE.key)!==-1&&e--}if(e)b=d.noDealsFilterMessage||gb.resources.getString("gb_no_active_deals_on_filters"),a=!0;else if(!gb.widgetHelper||typeof gb.widgetHelper.callID[c.widgetID]==="undefined"||gb.widgetHelper.callID[c.widgetID]===gb.widgetHelper.callDataArray[c.widgetID].length)b=d.noDealsMessage||gb.resources.getString("gb_no_results_to_show")}return{message:b,isFiltersSelected:a}},_getCurrentCategory:function(c){var b=gb.enums.CategoryFilters.ALL;if(gb.controller.isPaginatedMetadataCall(c)){c=gb.widgets[c].widgetGroupID;if(!c)return;c=gb.filterController.models[c].getSelectedFilters(!1,[gb.enums.DCSQueryParams.CATEGORIES,gb.enums.DCSQueryParams.PRIME_ACCESS_TYPE]);if(c.enforcedCategories)b=c.enforcedCategories[0];else if(c.primeAccessType)b=gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS}else b=gb.controller.widgetCurrentCategory[c];return b},_getCurrentStates:function(c){var b=gb.enums.DealStates.AVAILABLE;if(gb.controller.isPaginatedMetadataCall(c)){c=gb.widgets[c].widgetGroupID;if(!c)return;c=gb.filterController.models[c].getSelectedFilters(!1,[gb.enums.DCSQueryParams.DEAL_STATE]);if(c.dealStates)b=c.dealStates;typeof b==="object"&&(b=gb.enums.DealStatesToFilterStates[b[0]])}else b=gb.controller.widgetCurrentStatus[c];b&&(b=b.toLowerCase());return b}})});gb.execute(function(i,f){k.GBShareManager=i.Model.extend({_CONSTANTS:{ShareStringPrefix:"gb-share",ShareHTMLTemplatePostfix:"Share",SharePlatforms:{MOBILE_APP:"appMobile",TABLET_APP:"appTablet",AW:"aw",PC:"pc"},StringElements:["redirectURL","subject"],ShareCallbackFns:{appMobile:"_mashShareDeal",appTablet:"_placeHolderPlatformShare",aw:"_placeHolderPlatformShare",pc:"_placeHolderPlatformShare"},ShareRedirectRefPrefix:"gb_share_"},sharePlatform:null,supportsDeepLinking:!1,shareHTMLTemplateName:null,_shareToPlatform:null,shareRedirectRef:null,_setSharePlatform:function(){var c=gb.resources.deviceInfo.isPhone,b=gb.resources.deviceInfo.isApp,a=this._CONSTANTS.SharePlatforms;this.sharePlatform=a.PC;if(c)if(b){if(this.sharePlatform=a.MOBILE_APP,gb.resources.deviceInfo.isAndroid||gb.resources.deviceInfo.isIOS)this.supportsDeepLinking=!0}else this.sharePlatform=a.AW;else if(b)this.sharePlatform=a.TABLET_APP},_setShareHTMLTemplateName:function(){this.shareHTMLTemplateName=this.sharePlatform+this._CONSTANTS.ShareHTMLTemplatePostfix},_setShareRedirectRef:function(){this.shareRedirectRef=this._CONSTANTS.ShareRedirectRefPrefix+this.sharePlatform},initialize:function(){this._setSharePlatform();this._setShareHTMLTemplateName();this._setShareRedirectRef();this._shareToPlatform=this[this._CONSTANTS.ShareCallbackFns[this.sharePlatform]]},_getShareString:function(c,b,a){if(!c||!b||!f.contains(this._CONSTANTS.StringElements,c))return"";c=[this._CONSTANTS.ShareStringPrefix,this.sharePlatform,c,b.toLowerCase()].join("_");return!a?gb.resources.getString(c):gb.resources.getString(c,a)},_getShareHTML:function(c,b){return gb.templateManager.getWidgetHTML({widgetID:c,templateGroup:gb.templateManager.TemplateGroups.DEAL_SHARE,templateName:this.shareHTMLTemplateName,data:b})},_getMashShareParams:function(c,b){var a=gb.configManager.getDealViewConfig(c),d=b.dealType,e=b.dealID,g=b.detail.title,h={ref:this.shareRedirectRef,dealID:b.dealID,asin:b.detail.impressionAsin},l=gb.resources.getString("gb-share-defaultRedirect",h),f=l;this.supportsDeepLinking&&(f=this._getShareString("redirectURL",d,h));h=gb.resources.getImage("goldbox_upcoming");if(b.detail.imageAsin)h=b.detail.imageAsin;if((b.dealState===gb.enums.DealStates.UPCOMING||b.dealState===gb.enums.DealStates.COMINGSOON)&&b.teaser.teaserImage)h=b.teaser.teaserImage;h=gb.utils.resizeImage(h,a.shareImageSize);a=this._getShareString("subject",d);d={redirectURL:f,imageURL:h,viewTitle:a,dealTitle:g};if(b.merchantID&&b.merchantID!==gb.resources.customerData.amznMerchantID&&b.merchantName)d.merchantName=b.merchantName;if(b.pricingData.prices.dealPrice&&!b.auxiliaryData.breaksMAP){var i=b.pricingData.prices.dealPrice.min.formattedValue;b.pricingData.prices.dealPrice.min.value!==b.pricingData.prices.dealPrice.max.value&&(i+=" - "+b.pricingData.prices.dealPrice.max.formattedValue);d.dealPrice=i;if(gb.utils.showPPU(e))d.ppuValue=gb.resources.getString("gb_ppu_price",{price:b.pricingData.unitPrice.formattedValue,unitValue:b.pricingData.baseUnit.value,unitName:b.pricingData.baseUnit.name});if(b.pricingData.percentOff)e=b.pricingData.prices.basisPrice.min.formattedValue,d.basisPriceText=gb.utils.getPriceTextForBasisKind(b.pricingData.bKind),d.basisPrice=e,d.percentOff=gb.resources.getString("csld-percent_off",{discountPercentage:b.pricingData.percentOff})}if(b.detail.isPrimeEarlyAccessDeal)d.primeMessaging=gb.resources.getString("gb_m_prime_early_access_deal");if(b.detail.isPrimeOnly)d.primeMessaging=gb.resources.getString("gb_m_prime_exclusive");if(this.supportsDeepLinking)d.platformText=gb.resources.getString("gb-sent-using"),gb.resources.deviceInfo.isAndroid?(d.platformURL=gb.resources.getString("gb-android-app-url"),d.platformName=gb.resources.getString("gb-android-name")):(d.platformURL=gb.resources.getString("gb-ios-app-url"),d.platformName=gb.resources.getString("gb-iphone-name"));l=l+" "+g;f=f+" "+g;return{subject:a+" "+g,messagePlain160:l.substring(0,160),messagePlain140:l.substring(0,140),messageHTML:this._getShareHTML(c,d),messagePlain:f,imageURL:h}},_mashShareDeal:function(c,b){var a=this._getMashShareParams(c,b);n.when("mash").execute(function(d){d.share(a)})},_placeHolderPlatformShare:function(){},shareDeal:function(c,b){if(c&&b){var a=gb.controller.getDealDAO(b);a&&this._shareToPlatform(c,a)}}})});gb.execute(function(i,f){k.GBDealView=i.View.extend({initialize:function(c){this.widgetView=c.widgetView;this.position=c.position;this.viewElementID="#"+gb.utils.getDealViewID(this.widgetView.widgetID,this.position);this.viewElement=this.widgetView.skinDomElement.find(this.viewElementID);this.viewOrientation=this.widgetView.viewOrientation;this.dealID=c.dealID;this.isDoubleCell=c.isDoubleCell;this.row=c.row;this.column=c.column;this.deal=gb.controller.getDealDAO(this.dealID);this.modalClock=this.clock=this.restDescription=this.truncatedShipSoldInfo=this.truncatedDescription=this.truncatedTitle=this.viewSkin=null},render:function(){if(!gb.controller.buyingDeals[this.dealID]){var c=this.widgetView.widgetID,b=gb.configManager.getWidgetViewConfig(c),a=b.useCssEllipsification;if(this.viewOrientation!==this.widgetView.viewOrientation)this.restDescription=this.truncatedDescription=this.truncatedTitle=null;this.viewOrientation=this.widgetView.viewOrientation;this.clock&&k.clearTimeout(this.clock.timeout);this.modalClock&&k.clearTimeout(this.modalClock.timeout);this.deal.detail.itemType===gb.enums.ItemTypes.VARIATION&&gb.widgets[c].widgetName===gb.enums.WidgetNames.ML_HERO?(this.variationView=this.variationView||new GBVariationView({dealID:this.deal.dealID,widgetView:this.widgetView,isMiniDP:!1,position:this.position,dealView:this}),this.variationView.render()):(this.viewSkin=this._generateStateHTMLFromViewSubTemplates(),this.viewElement.html(this.viewSkin));this.renderTitle(a);this.renderDescription();this._renderShipSold();this._handleDealActions(b);b=gb.controller.schedulingParams[c];gb.utils.isTouchDevice()&&b.showShortCellView&&(this.viewElement.find(".restVisible").remove(),this.viewElement.find(".hoverVisible").css("display","block"));this.updateOptionsHTML();this.renderEldaradoUtil();gb.metricsManager.recordRender(c,this.dealID,this.position)}},_generateStateHTMLFromViewSubTemplates:function(c){var b=this.widgetView.widgetID,a=this.deal.dealState,d=this.deal.dealType,e=gb.utils.getStateTemplateName(a,d),d=gb.utils.getViewTemplatesForState(a,d),c=c||{},a=c.stateTemplateGroup||gb.templateManager.TemplateGroups.DEAL_STATE,g=c.viewTemplateGroup||gb.templateManager.TemplateGroups.DEAL_VIEW,h=c.viewTemplateData||gb.viewComponentBuilder.getDealViewTemplateData(this),l=this,c=c.stateTemplateDataBuilderFn||function(a){return gb.viewComponentBuilder.getDealStateTemplateData(l,a)},d=gb.templateManager.getWidgetHTML({widgetID:b,templateGroup:g,templateNames:d,data:h}),c=c(d);return gb.templateManager.getWidgetHTML({widgetID:b,templateGroup:a,templateName:e,data:c})},enableOptions:function(c){var c=i.$(c),b={header:c.find("#"+gb.enums.dealViewIDs.OPT_HEADER),contents:c.find("#"+gb.enums.dealViewIDs.OPT_CONTENT),footer:c.find("#"+gb.enums.dealViewIDs.OPT_FOOTER)};this.viewElement.find(".dealAction").click(function(a){gb.controller.getBottomSheet().render(b);a.stopPropagation();a.preventDefault()})},_handleDealActions:f.once(function(c){i.A.declarative("gbdeal-addtocart","click",function(b){var b=b.data,a=b.asin;gb.metricsManager.recordAction(b.widgetID,b.dealID,"ADD_TO_CART",b.position);gb.controller.dealDAOs[b.dealID].checkingDealStatus=!0;gb.controller.refreshDealView(b.dealID,a);gb.controller.processActionableClick({widgetID:b.widgetID,dealID:b.dealID,dealType:b.dealType,dealState:b.dealState,asin:a,offerID:b.offerID,legacyDealID:b.legacyDealID,quantity:1})});i.A.declarative("gbdeal-watchdeal",c.enableClickOnlyWatch?"click":"click touchstart",function(b){var a=b.data.dealID,d=b.data.widgetID,c=gb.controller.dealDAOs[a],g=gb.controller.watchDealView,h=k.dealNotifier;if(g&&!c.isDealWatched&&!gb.resources.customerData.isWatchDealPopupMarked)g.changeWatchPopupState(gb.enums.WatchDealPopoverActions.HIDE_WATCH_POPUP),gb.watchDealService.modifyPopupStatus({action:gb.enums.SembuActions.SET_COOKIE,type:gb.enums.DataTypes.BOOL,value:1,key:g.key,domain:g.domain}),gb.resources.customerData.isWatchDealPopupMarked=!0,h&&h.watchDealNotifier&&h.watchDealNotifier.registerWatchDeals([]);gb.metricsManager.recordAction(d,a,"WATCH_DEAL",b.data.position);gb.controller.watchDeal(d,a)});gb.clientName===gb.enums.MobileClients.PC&&i.A.declarative("gbdeal-watchdeal","mouseenter mouseleave",function(b){var a=b.data.dealID,d=b.data.widgetID,c=gb.controller.dealDAOs[a];if(gb.controller.watchDealView&&c.isDealWatched){var g=b.$target.closest("#"+gb.enums.WatchDealViewIDs.WATCH_BUTTON+a);gb.controller.watchDealView.triggerMouseEventsOnWatchingDeal(a,g,b.type);n.when("A","a-modal").execute(function(c,e){var f=e.get(gb.enums.WidgetViewIDs.MINI_DP_MODAL+a);f&&f.isActive()&&(f.$popover.find("."+gb.enums.WatchDealViewIDs.MINI_DP_WATCH_BUTTON_MAPPING[gb.widgets[d].widgetName]),gb.controller.watchDealView.triggerMouseEventsOnWatchingDeal(a,g,b.type))})}});i.A.declarative("gbdeal-joinwaitlist","click",function(b){var b=b.data,a=b.asin;gb.metricsManager.recordAction(b.widgetID,b.dealID,"JOIN_WAITLIST",b.position);gb.controller.dealDAOs[b.dealID].checkingDealStatus=!0;gb.controller.refreshDealView(b.dealID,a);gb.controller.processActionableClick({widgetID:b.widgetID,dealID:b.dealID,dealType:b.dealType,dealState:b.dealState,asin:a,offerID:b.offerID,legacyDealID:b.legacyDealID,action:gb.metrics.refTags.joinWaitlist})});i.A.declarative("gbdeal-checkout","click",function(){k.location.href="/gp/cart/view.html"});i.A.declarative("gbdeal-add-to-wishlist","click",function(b){b=b.data;gb.controller.dealDAOs[b.dealID].addingToWishList=!0;gb.controller.refreshDealView(b.dealID);gb.controller.addItemToWishList({dealID:b.dealID,asin:b.asin})});i.A.declarative("gbdeal-view-wishlist","click",function(b){k.location.href="/gp/registry/wishlist/"+b.data.defaultRegistryID});i.A.declarative("gbdeal-seeoptions","click",function(b){var a=gb.widgets[b.data.widgetID].dealViews[b.data.dealID][b.data.position];gb.metricsManager.recordAction(b.data.widgetID,b.data.dealID,"SEE_MORE",b.data.position);a.renderMiniDetailPage(b.data.asin);b=gb.metrics.generateRef(b.data.widgetID,gb.metrics.refTags.miniDpPopOver,[b.data.dealID]);gb.metrics.recordRefViaAjax(b)});i.A.declarative("gb-image","click tap",function(b){var a=gb.widgets[b.data.widgetID].dealViews[b.data.dealID][b.data.position],d=gb.utils.shouldShowMiniDetailPageModal(a);gb.metricsManager.recordAction(b.data.widgetID,b.data.dealID,"IMAGE",b.data.position);d?(a.renderMiniDetailPage(),b=gb.metrics.generateRef(b.data.widgetID,gb.metrics.refTags.miniDpPopOver,[b.data.dealID]),gb.metrics.recordRefViaAjax(b)):k.location.href=b.data.redirectionUrl});i.A.declarative("gbdeal-actionrecord","click",function(b){var a=b.data.customURL;gb.metricsManager.recordAction(b.data.widgetID,b.data.dealID,b.data.actionType,b.data.position);if(a)k.location.href=a});i.A.declarative("gbdeal-mashshare","click",function(b){var a=b.data.widgetID,d=b.data.dealID;a&&d&&gb.controller.getDealDAO(d)&&(gb.metricsManager.recordAction(a,d,"SHARE_DEAL",b.data.position),gb.controller.closeBottomSheet(),gb.controller.getShareManager().shareDeal(a,d))})}),renderTitle:function(c){var b=this.widgetView.widgetID;if(!c&&!gb.configManager.getWidgetViewConfig(b).disableJsEllipsification&&(c=this.viewElement.find("#"+gb.enums.dealViewIDs.TITLE),c.length))for(var a=0;a<c.length;a++){var d=i.$(c[a]);this._truncateText(d,"truncatedTitle");gb.configManager.getWidgetViewConfig(b).enableAutoTitleAdjustment&&d.addClass("autoHeight")}},renderDescription:function(){var c=this.viewElement.find("#"+gb.enums.dealViewIDs.DESC_ABBR);if(c.length)if(c=i.$(c[0]),this.truncatedDescription)c.html(this.truncatedDescription),this._setRestDescription(this.restDescription,this.truncatedDescription);else{var b=c.html().trim();if(b){var a=!0;if(gb.resources.customerData.realm===gb.enums.Realms.CN||gb.resources.customerData.realm===gb.enums.Realms.JP)a=!1;gb.utils.ellipsify({jQuery:i.$,el:c,removeDots:!0,wordsIntact:a});this.truncatedDescription=c.html().trim();this._setRestDescription(b.substr(this.truncatedDescription.length),this.truncatedDescription)}}},_renderShipSold:function(){var c=this.viewElement.find("#"+gb.enums.dealViewIDs.SHIP_SOLD);c.length>0&&this._truncateText(c,"truncatedShipSoldInfo");gb.configManager.getWidgetViewConfig(this.widgetView.widgetID).enableAutoTitleAdjustment&&c.addClass("autoHeight")},_truncateText:function(c,b){this[b]?c.html(this[b]):(gb.utils.ellipsify({jQuery:i.$,el:c}),this[b]=c.html())},_setRestDescription:function(c,b){if(c){var a=this.viewElement.find("#"+gb.enums.dealViewIDs.DESC_REST);i.$(a[0]).html(c);this.restDescription=c}else a=this.viewElement.find("#"+gb.enums.dealViewIDs.DESC),i.$(a[0]).html(b)},signalMarker:function(c,b){if(gb.csm&&c&&!gb.csm.recordedMarkers[c]){var a=b&&b.recordMarkerFeature?!0:!1,d=function(){gb.csm.signalMarker(c)},e=this.viewElement.find("img");e.length&&e[0]&&e[0].complete?d():e.load(d).error(d);a&&(gb.csm.recordedMarkers[c]=!0,n.register(c))}},renderMiniDetailPage:function(c){var b=this,a=b.deal,d=a.dealID,e=gb.enums.WidgetViewIDs.MINI_DP_MODAL+d,g=gb.resources.getImage("spinner");n.when("A","a-modal","ready").execute(function(h,f){var i={name:e,header:gb.resources.getString("gb_deal_details"),width:"655",inlineContent:"<img src="+g+">"},k=b.viewElement.find("#"+gb.enums.dealViewIDs.IMAGE),o=f.get(gb.enums.WidgetViewIDs.MINI_DP_MODAL+d);o||(o=f.create(k,i),o.show());a.detail.itemType===gb.enums.ItemTypes.VARIATION?(b.variationView=b.variationView||new GBVariationView({dealID:d,widgetView:b.widgetView,asinID:c,isMiniDP:!0,modalInstance:o,position:b.position,dealView:b}),b.variationView.render()):(b.viewSkin=b._generateStateHTMLFromViewSubTemplates({viewTemplateGroup:gb.templateManager.TemplateGroups.MINI_DP_DEAL_VIEW,stateTemplateGroup:gb.templateManager.TemplateGroups.MINI_DP_DEAL_STATE,viewTemplateData:gb.viewComponentBuilder.getMiniDPViewTemplateData(b,o,c)}),o.updateContent(b.viewSkin).lock().show(),gb.controller.popOverVisible=!0)});var h="a:popover:beforeHide:"+e;n.when("A").execute(function(a){a.on(h,function(){n.when("GBEventManager").execute(function(a){a.trigger("popoverClosed");gb.controller.popOverVisible=!1})})})},renderEldaradoUtil:function(){var c=gb.utils.getDealsInternalUrl(this.dealID);if(c){var b=document.createElement("a");b.href=c;b.setAttribute("value","View Deals Internal Website");b.style.backgroundImage="url('http://g-ec2.images-amazon.com/images/G/01/goldbox/gb_icon_tiny._V192570393_.gif')";b.style.width="30px";b.style.height="26px";b.style.border="none";b.style.display="block";b.style.position="absolute";b.style.top=0;b.style.zIndex=100;this.viewElement.css("position","relative");this.viewElement.append(b)}},updateOptionsHTML:function(){var c=this.widgetView.widgetID,b=gb.configManager.getWidgetViewConfig(c),a=gb.controller.schedulingParams[c];gb.resources.deviceInfo.isPhone&&gb.resources.deviceInfo.isApp&&(a.enableShareDeal||b.supportWatch)&&this.enableOptions(gb.templateManager.getWidgetHTML({widgetID:c,templateGroup:gb.templateManager.TemplateGroups.DEAL_VIEW,templateName:"dealOptions",data:gb.viewComponentBuilder.getDealOptionsTemplateData(this)}))}})});gb.execute(function(i,f){k.GBVariationView=GBDealView.extend({initialize:function(c){this.dealID=c.dealID;this.viewSkin=null;this.isMiniDP=c.isMiniDP;this.asinID=c.asinID;this.unavailableAsinSelected=!1;this.selectedDimension={};this.modalInstance=c.modalInstance;this.dealView=c.dealView},render:function(){var c=null,c=this.asinID,b=this.dealView.deal,c=this.selectedDimension?b.getVariationAsin(this.selectedDimension):c?b.getAsinDAO(c):null;this.modalFirstLoad=!0;this.update(c);this.handleDropDownActions();this.modalFirstLoad=!1},update:function(c){var b=this,a=b.modalInstance,d=b.isMiniDP;!c||c.status.itemState===gb.enums.DealStates.SOLDOUT?b.unavailableAsinSelected=!0:(f.each(c.variationDimensions,function(a,d){b.selectedDimension[d]=a}),b.unavailableAsinSelected=!1);var e=gb.templateManager.TemplateGroups.DEAL_VIEW,g=gb.templateManager.TemplateGroups.DEAL_STATE,h=gb.viewComponentBuilder.getDealViewTemplateData(b.dealView,c);if(d)e=gb.templateManager.TemplateGroups.MINI_DP_DEAL_VIEW,g=gb.templateManager.TemplateGroups.MINI_DP_DEAL_STATE,h=gb.viewComponentBuilder.getMiniDPViewTemplateData(b.dealView,a,c);b.viewSkin=b.dealView._generateStateHTMLFromViewSubTemplates({viewTemplateGroup:e,stateTemplateGroup:g,viewTemplateData:h,stateTemplateDataBuilderFn:function(a){return gb.viewComponentBuilder.getDealStateTemplateData(b.dealView,a,c)}});d&&a?a.updateContent(b.viewSkin).lock().show():(b.dealView.viewElement.html(b.viewSkin),b.dealView.updateOptionsHTML())},handleDropDownActions:function(){var c=this,b=c.dealID,a=c.dealView.deal;f.keys(a.items);n.when("A","a-dropdown").execute(function(d,e){d.on("a:dropdown:select",function(d){if(d.id.slice(d.id.length-b.length,d.id.length)===b){c.selectedDimension={};var h;c.selectedDimension[d.name]=decodeURIComponent(d.value);var l=a.items[f.keys(a.items)[0]];f.each(l.variationDimensions,function(b,h){if(h!==d.name){var f=h.replace(/\s/g,"")+a.dealID,f=encodeURIComponent(f),f=f.replace(/%/g,"\\%"),f=decodeURIComponent(e.getSelect(f).val());c.selectedDimension[h]=f}});h=c.getSelectorData();f.isEmpty(h)&&f.find(c.selectedDimension,function(a,b){if(b!==d.name)return c.selectedDimension[b]=gb.resources.getString("csld-select"),h=c.getSelectorData(),!f.isEmpty(h)});c._setDropdownValueBasedOnSelection(h,e,d);l=a.getVariationAsin(c.selectedDimension);c.update(l)}})});n.when("A").execute(function(d){d.on("a:popover:dismiss:"+gb.enums.WidgetViewIDs.MINI_DP_MODAL+b,function(){if(a.detail.itemType===gb.enums.ItemTypes.VARIATION)c.selectedDimension={}})})},getSelectorData:function(){var c=this,b={},a=this.dealView.deal;f.each(c.selectedDimension,function(d,e){f.each(a.items,function(a){c.isMatchingCombination(a)&&f.each(a.variationDimensions,function(a,d){d!==e&&(b[d]||(b[d]=[]),b[d].push(a))})})});return b},isMatchingCombination:function(c){var b=!0;f.each(this.selectedDimension,function(a,d){a!==c.variationDimensions[d]&&a!==gb.resources.getString("csld-select")&&(b=!1)});return b},_setDropdownValueBasedOnSelection:function(c,b,a){var d=this;f.each(c,function(e,g){if(g!==a.name){var h=g.replace(/\s/g,"")+d.dealID,h=encodeURIComponent(h),h=h.replace(/%/g,"\\%");e.length===1?(b.getSelect(h).setValue(e[0]),d.selectedDimension[g]=e[0]):c[g].indexOf(d.selectedDimension[g])===-1&&(b.getSelect(h).setValue(gb.resources.getString("csld-select")),d.selectedDimension[g]=gb.resources.getString("csld-select"))}})}})});gb.execute(function(i,f){k.GBViewPortManager=i.Model.extend({initialize:function(c){this.lastDealPosition=this.firstDealPosition=this.lastScrollTop=-1;this.widgetContentPage=1;this.isScrollBound=!1;this.scrollCallback=null;this.widgetID=c.widgetID;this.pageSize=c.pageSize;this.totalDeals=c.totalDeals;this.domElementID=c.domElementID;this.pageScroll();this.attachScroll()},detachScroll:function(){if(this.isScrollBound&&this.scrollCallback!==null)i.$(k).unbind("scroll",this.scrollCallback),this.isScrollBound=!1,this.scrollCallback=null},attachScroll:function(){if(!this.isScrollBound&&this.scrollCallback===null){this.scrollCallback=f.bind(this.pageScroll,this);if(f.isNumber(gb.controller.schedulingParams[this.widgetID].subnavPage))this.subnavPage=gb.controller.schedulingParams[this.widgetID].subnavPage,gb.controller.schedulingParams[this.widgetID].enableHidingWidgetHeader&&this.setHidingHeaderVariables();(!f.isNumber(this.subnavPage)||this.subnavPage===gb.subnavController.currentPageNumber)&&i.$(k).scrollTop(0);i.$(k).bind("scroll",this.scrollCallback);this.isScrollBound=!0}},clearHeaderInSubnav:function(){this.widgetHeaderInSubnav&&this.disableHidingWidgetHeaderOnScroll();gb.subnavController&&this.subnavPage===gb.subnavController.currentPageNumber&&gb.subnavController.subnavSlideCompletelyDown()},setHidingHeaderVariables:function(){this.subnavContainer=document.querySelector(gb.subnavController.SubnavIDs.SubnavContainer);this.widgetHeaderHolder=i.$(gb.subnavController.SubnavIDs.SubnavWidgetHolder+this.subnavPage);this.widgetHeaderInSubnav=!1;this.subnavContainerHeightDiv=i.$(gb.subnavController.SubnavIDs.SubnavHeightDiv+this.subnavPage);this.enableHidingWidgetHeaderOnScroll()},pageScroll:function(){var c;if(!f.isNumber(this.subnavPage)||!(gb.subnavController.currentPageNumber!==this.subnavPage&&this.lastScrollTop!==-1)){c=i.$(k).scrollTop();var b=this.lastScrollTop;this.lastScrollTop=c;c<b?this.setWidgetCurrentPage(gb.enums.Direction.UP):c>b&&this.setWidgetCurrentPage(gb.enums.Direction.DOWN);this.handlePageChange()}},handlePageChange:function(){var c=gb.controller.widgetCurrentPage[this.widgetID],b=this.getCurrentPage();if(c!==b)gb.controller.widgetCurrentPage[this.widgetID]=b,c=gb.widgets[this.widgetID].totalPages,b>=c-1&&gb.widgets[this.widgetID].hideLoading(),b!==c&&(gb.controller.scrollPage(this.widgetID),this.garbageCollectAndReRender())},getCurrentPage:function(){return this.widgetContentPage},setWidgetCurrentPage:function(c){for(var b=this.widgetContentPage;gb.utils.isElementInViewPort(gb.utils.getPageID(this.widgetID,b))===gb.enums.ViewPortPresence.ABSENT;)if(c===gb.enums.Direction.UP&&b>0)--b;else if(c===gb.enums.Direction.DOWN&&b<=this.totalDeals/this.pageSize)++b;else{b=1;break}this.widgetContentPage=b},garbageCollectAndReRender:function(){this.firstDealPosition=this.widgetContentPage>3?(this.widgetContentPage-3)*this.pageSize:0;this.lastDealPosition=(this.widgetContentPage+2)*this.pageSize-1;if(this.lastDealPosition>=this.totalDeals)this.lastDealPosition=this.totalDeals-1;this.renderedDealViews=this.renderedDealViews||[];var c=this.firstDealPosition,b=this.lastDealPosition,a=gb.metadata.getAllDisplayableDealIDs(this.widgetID).slice(c,b),d=f.difference(this.renderedDealViews,a);this.renderedDealViews=a;gb.widgets[this.widgetID].reRenderDealViews(c,b);gb.garbageCollector.deepCleanDealViews(this.widgetID,d)},enableHidingWidgetHeaderOnScroll:function(){this.widgetHeader=i.$("#"+gb.enums.WidgetHeaderIDs.WidgetHeader+this.widgetID);this.subnavContainerHeightDiv.height(this.subnavContainerHeightDiv.height()+this.widgetHeader.height());this.widgetHeaderHolder.html(this.widgetHeader.html());this.widgetHeader.html("");this.widgetHeaderInSubnav=!0},disableHidingWidgetHeaderOnScroll:function(){this.widgetHeader.html(this.widgetHeaderHolder.html());this.widgetHeaderHolder.html("");this.widgetHeaderInSubnav=!1;this.subnavContainerHeightDiv.height(this.subnavContainer.getBoundingClientRect().height)}})});gb.execute(function(i,f){k.GBWidgetView=i.View.extend({initialize:function(c){this.widgetID=c.widgetID;this.widgetGroupID=c.widgetGroupID;this.widgetName=c.widgetName;this.domElementID=c.domElementID;this.dealViews={};this.fullyRenderedPages=[];this.pageHandlers=[];this.filterViews=[];this.skinDomElement=null;this.isRefineRender=!1;this.totalPages=this.viewOrientation=null;this.isCFRecorded=!1;this.minDealViewWidth=this.getMinDealWidth();this.viewPortManager=this.dealsPerRow=null;this.nextPositionToRender=0;this.filterJSONData={};this.nextAdSlotToRenderIndex=-1;this.initializeView()},initializeView:function(){this.skinDomElement=i.$("#"+this.domElementID);gb.configManager.getWidgetViewConfig(this.widgetID).disableOrientationChange||this.enableOrientationChange();this.dealsPerRow=this.getDealsPerRow();var c=gb.controller.schedulingParams[this.widgetID];if(!f.isEmpty(c.adSlots))this.nextAdSlotToRenderIndex=0;if(c.allowWidgetRefresh)if(gb.subnavController&&f.isNumber(c.subnavPage)){gb.subnavController.widgetsToRefresh=gb.subnavController.widgetsToRefresh||{};var b=c.subnavPage;gb.subnavController.widgetsToRefresh[b]=gb.subnavController.widgetsToRefresh[b]||{};gb.subnavController.widgetsToRefresh[b][c.subnavPageSlot]=this}else throw Error("allowWidgetRefresh cannot be used without a subnav instance in place.");},enableRefine:function(){var c=this;c.skinDomElement.find("#"+gb.enums.WidgetViewIDs.REFINE).click(function(){c.renderRefine()});c.filterAndSortEventsCache=c.filterAndSortEventsCache||{};c.filterAndSortEventsCache[c.widgetID]||(c.filterAndSortEventsCache[c.widgetID]=f.once(function(){i.A.declarative("gbfilter-click-"+c.widgetID,"click",function(){c.renderFilter(!1)});i.A.declarative("gbsort-click-"+c.widgetID,"click",function(){c.renderFilter(!0)})}));c.filterAndSortEventsCache[c.widgetID].call()},enableOrientationChange:function(){if(gb.clientName!==gb.enums.MobileClients.PC)this.viewOrientation=gb.utils.getDeviceOrientation(this.widgetID);i.$(k).resize(f.bind(this.resizeWindow,this))},enableInfiniteScroll:function(){var c=gb.controller.schedulingParams[this.widgetID],b=!0;f.each(c.filterConfig,function(a){if(a.attr===gb.enums.BinningParams.PAGE.key)return b=!1});if(b&&!this.viewPortManager){var a=gb.metadata.getAllDisplayableDealIDs(this.widgetID);this.viewPortManager=new GBViewPortManager({widgetID:this.widgetID,pageSize:c.pageSize,totalDeals:a.length,domElementID:this.domElementID})}},getMinDealWidth:function(){return gb.enums.Constants.MIN_TABLET_VIEW_WIDTH},getDealsPerRow:function(){var c=gb.configManager.getDealViewConfig(this.widgetID),b=gb.configManager.getWidgetViewConfig(this.widgetID);return gb.resources.deviceInfo.isPhone?this.viewOrientation===gb.enums.ClientOrientation.LANDSCAPE?c.dealsPerRowL||gb.enums.Constants.PHONE_LANDSCAPE_COLUMN_COUNT:c.dealsPerRowP||gb.enums.Constants.PHONE_PORTRAIT_COLUMN_COUNT:gb.utils.getDealsPerRow(i.$(k).width(),this.minDealViewWidth,b.hasMargin,b.supportEvenColumnsOnly)},resizeWindow:function(){var c=gb.configManager.getWidgetViewConfig(this.widgetID).allowFlexRendering;if(!this.isRefineRender){if(gb.controller.watchDealView)gb.controller.watchDealView.isWatchDealPopupRendered=!1;var b=this.dealsPerRow;this.dealsPerRow=this.getDealsPerRow();if(gb.clientName===gb.enums.MobileClients.PC){if(b===this.dealsPerRow)return}else if(b=gb.utils.getDeviceOrientation(this.widgetID),b===this.viewOrientation)return;else{var a=gb.configManager.getDealViewConfig(this.widgetID);this.viewOrientation=b;if(this.viewPortManager)this.viewPortManager.lastScrollTop=b===gb.enums.ClientOrientation.LANDSCAPE?Math.ceil(this.viewPortManager.lastScrollTop*a.dealsPerRowP/a.dealsPerRowL):Math.ceil(this.viewPortManager.lastScrollTop*a.dealsPerRowL/a.dealsPerRowP)}c?(i.$(k).scrollTop(this.viewPortManager.lastScrollTop),this._navigateToWidget()):(this.renderContent(!0),gb.controller.watchDealView&&gb.controller.watchDealView.changeWatchPopupState(gb.enums.WatchDealPopoverActions.UPDATE_WATCH_POPUP))}},renderWireFrame:function(){this.isRefineRender=!1;gb.garbageCollector.clearDealViews(this.widgetID);f.isNumber(gb.controller.schedulingParams[this.widgetID].subnavPage)&&gb.controller.schedulingParams[this.widgetID].enableHidingWidgetHeader&&gb.widgets[this.widgetID]&&gb.widgets[this.widgetID].viewPortManager&&gb.widgets[this.widgetID].viewPortManager.clearHeaderInSubnav();this.filterViews=[];this.totalCellsRendered=0;var c=gb.viewComponentBuilder.getWidgetViewTemplateData(this);this.skinDomElement.html(gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"wireFrame",data:c}));f.isNumber(gb.controller.schedulingParams[this.widgetID].subnavPage)&&gb.controller.schedulingParams[this.widgetID].enableHidingWidgetHeader&&gb.widgets[this.widgetID]&&gb.widgets[this.widgetID].viewPortManager&&gb.widgets[this.widgetID].viewPortManager.enableHidingWidgetHeaderOnScroll();this._handleFilterChange();this._handleClearFilters();gb.controller.schedulingParams[this.widgetID].enablePagination&&this.renderPagination(c)},showLoading:function(){this.skinDomElement.html(gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"widgetLoading"}))},hideLoading:function(){this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.LOADING).css("display","none")},renderContent:function(c){var b=null;if(c)b=this.viewPortManager?this.viewPortManager.lastScrollTop:null,this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CONTENT).empty(),this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.FILTERS).empty(),this.filterViews=[],gb.garbageCollector.clearViewPort(this.widgetID),gb.garbageCollector.clearDealViews(this.widgetID);var a=gb.viewComponentBuilder.getWidgetViewTemplateData(this,c),d=gb.metadata.getAllDisplayableDealIDs(this.widgetID),e=gb.controller.schedulingParams[this.widgetID],g=gb.enums.WidgetViewIDs.CONTENT,a=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"widgetContent",data:a});this.totalPages=Math.ceil(d.length/e.pageSize);e.enablePagination?this.skinDomElement.find("#"+g).html(a):this.skinDomElement.find("#"+g).append(a);for(var a=gb.controller.widgetCurrentPage[this.widgetID],g=e.pageSize,a=gb.controller.schedulingParams[this.widgetID].eventID||e.enablePagination?g*(a-1):0,h=d.length<this.dealsPerRow?d.length:this.dealsPerRow;this.nextPositionToRender<=gb.watcher.lowestDealIDWatchedIndex[this.widgetID]&&a+this.nextPositionToRender<d.length;){var l=d[a+this.nextPositionToRender],p=new GBDealView({dealID:l,widgetView:this,position:this.nextPositionToRender});this.dealViews[l]=this.dealViews[l]||{};this.dealViews[l][this.nextPositionToRender]=p;p.render();this._publishLatencyMetrics(this.nextPositionToRender,gb.watcher.lowestDealIDWatchedIndex[this.widgetID],h,p);this._recordWidgetCF(e.featureScope);this.nextPositionToRender++}d=e.adSlots;if(!f.isEmpty(d))for(;this.nextAdSlotToRenderIndex<d.length;)if(h=this.skinDomElement.find("#"+gb.utils.getAdRowID(this.widgetID,this.nextAdSlotToRenderIndex)),h.length)a=gb.viewComponentBuilder.getAdRowViewData(this),a=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"adSlot",data:a}),h.html(a),this.nextAdSlotToRenderIndex++;else break;!e.enforceLimitedDeals&&!e.enablePagination&&g>0&&this.enableInfiniteScroll();e.enableCategoryRefine&&this.enableRefine();this.widgetName===gb.enums.WidgetNames.TAB_HERO&&!e.enforceLimitedDeals&&this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.FILTER_CONTENT).html(this._getRefineHTML());this._renderFilterViews();if(c&&this.viewPortManager){if(b)this.viewPortManager.lastScrollTop=b;e.subnavPage!==m&&e.subnavPage!==null?i.$(gb.utils.getSubnavPageElementFromDomID(this.domElementID)).scrollTop(this.viewPortManager.lastScrollTop):i.$(k).scrollTop(this.viewPortManager.lastScrollTop)}this._publishWidgetLatencyMetrics(e.featureScope);this._navigateToWidget();this._renderEllipsifiedTitle();this.applyWidgetSpecificStyle()},_publishLatencyMetrics:function(c,b,a,d){parseInt(this.widgetID,10)===100&&(c<a&&(c===a-1?d.signalMarker("af",{recordMarkerFeature:!0}):d.signalMarker("af")),c===b-1?d.signalMarker("cf",{recordMarkerFeature:!0}):d.signalMarker("cf"))},applyWidgetSpecificStyle:function(){i.$("#filterContent").css("background","white");i.$("#categoryRefineContent").parent().css("background","white");this.widgetName===gb.enums.WidgetNames.MG_HERO&&(this.skinDomElement.find(".widgetContentRow.noBorder").removeClass("noBorder"),this.skinDomElement.find(".widgetContentRow:not(:has(*>*))").addClass("noBorder"))},reRenderDealViews:function(c,b){if(!(b<=c))for(var a=gb.metadata.getAllDisplayableDealIDs(this.widgetID),d=c;d<b;d++){var e=a[d],g=null;this.dealViews[e]&&this.dealViews[e][d]&&(g=this.dealViews[e][d]);if(!g||g.viewElement.children("a").length===0)g||(g=new GBDealView({dealID:e,widgetView:this,position:d}),this.dealViews[e]=this.dealViews[e]||{},this.dealViews[e][d]=g),g.render()}},_navigateToWidget:function(){var c=gb.controller.schedulingParams[this.widgetID].widgetAnchorName;c&&k.location.hash==="#"+c&&f.defer(function(){i.$("html, body").scrollTop(i.$("#"+c).offset().top)})},_renderFilterViews:function(){var c=this;if(c.isFilterEnabled()&&(c.widgetName!==gb.enums.WidgetNames.MG_HERO||f.isEmpty(c.filterViews))){f.each(gb.controller.schedulingParams[c.widgetID].filterConfig,function(a){a=new GBFilterItemView({},{filterConfig:a,widgetView:c});c.filterViews.push(a);gb.configManager.getWidgetViewConfig(c.widgetID).showBottomSheetFilter||a.render()});var b=c.skinDomElement.find(gb.enums.WidgetViewSelectors.FILTER_BOX),a=0;f.each(b,function(d){a<i.$(d).height()&&(a=i.$(d).height())});c.skinDomElement.find(gb.enums.WidgetViewSelectors.TRIANGLE).height();f.each(b,function(d){i.$(d).height(a);d=i.$(d).find(gb.enums.WidgetViewSelectors.FILTERLINK);i.$(d).height(a)})}},_getRefineHTML:function(){var c=this.isEventsWidget()?"filter":"refine",b=gb.viewComponentBuilder.getRefineTemplateData(this);return gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:c,data:b})},renderRefine:function(c){var b=this;b.isRefineRender=!0;var a=b._getRefineHTML();if(b.isEventsWidget()){var a=i.$("<div>").html(a),d=i.$("#"+gb.enums.WidgetViewIDs.FILTERS,b.skinDomElement).html();i.$("#"+gb.enums.WidgetViewIDs.FILTERS,a).html(d);a=a.html()}b.skinDomElement.hide();c?i.$("#"+c).html(a):b.skinDomElement.html(a);b.skinDomElement.slideDown();b.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CANCEL).click(function(a){a.preventDefault();b.skinDomElement.slideUp(function(){b.skinDomElement.show();b.renderWireFrame();b.renderContent(!0)})})},renderPagination:function(){var c=gb.viewComponentBuilder.getPaginationTemplateData(this),c=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:"pagination",data:c});this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.PAGINATION_ROW).html(c);this._handlePageChange()},_handleFilterChange:f.once(function(){i.A.declarative("refine","click",function(c){c.$event.preventDefault();var b=c.data.widgetID,a=c.$target.closest("[data-status]").data("status"),c=c.$target.closest("[data-category]").data("category");a?(gb.controller.trigger("WidgetStatusChange",b,a),gb.widgets[b].renderRefine(gb.enums.WidgetViewIDs.FILTER_CONTENT),gb.widgets[b].enableInfiniteScroll()):c&&gb.controller.trigger("WidgetCategoryChange",b,c);(a||c)&&n.when("a-popover").execute(function(a){gb.widgets[b].isRefineRender=!1;(a=a.get(gb.enums.WidgetViewIDs.REFINE_POPOVER_NAME))&&a.hide()})})}),_handlePageChange:f.once(function(){i.A.declarative("gbfilter-pagination","click",function(c){c.$event.preventDefault();var b=c.data.widgetID,a=parseInt(c.data.currentPage,10),d=parseInt(c.data.totalPages,10),e=c.$target.closest("[data-page]").data("page");e||(c=c.$target[0].href&&c.$target[0].href.split("#")[1],c===gb.enums.PaginationDummyURLs.PREV&&a>1?e=a-1:c===gb.enums.PaginationDummyURLs.NEXT&&a<d&&(e=a+1));e&&(gb.controller.widgetCurrentPage[b]=e,b&&!gb.widgets[b].isEventsWidget()&&(gb.controller.trigger("WidgetPageUpdate",b,!0),gb.controller.updateAppliedFilters(b)))})}),_handleClearFilters:f.once(function(){i.A.declarative("clear-refine","click",function(c){c.$event.preventDefault();c=c.data.widgetID;gb.controller.widgetCurrentStatus[c]=gb.enums.StatusFilters.AVAILABLE;gb.controller.widgetCurrentCategory[c]=gb.enums.CategoryFilters.ALL;gb.controller.widgetCurrentPage[c]=1;gb.controller.trigger("WidgetPageUpdate",c,!0);gb.controller.updateAppliedFilters(c)})}),scrollToWidgetTop:function(){typeof k.scrollTo==="function"&&k.scrollTo(0,this.skinDomElement.offset().top)},isEventsWidget:function(){return!!gb.controller.schedulingParams[this.widgetID].eventID},isFilterEnabled:function(){return!!this.widgetGroupID},_renderEllipsifiedTitle:function(){var c=this;gb.configManager.getWidgetViewConfig(this.widgetID).useCssEllipsification&&f.defer(function(){f.each(c.dealViews,function(b){f.each(b,function(a){a.renderTitle(!1)})})})},_publishWidgetLatencyMetrics:function(c){c&&gb.csm&&!gb.csm.publishedMetrics[c]&&(gb.csm.signalMarker("be",c),gb.csm.publishMetrics(c))},_recordWidgetCF:function(c){if(c&&!this.isCFRecorded&&gb.csm&&!gb.csm.publishedMetrics[c])gb.csm.signalMarker("cf",c),this.isCFRecorded=!0},renderFilter:function(c){this.filterViews[0]._handleFilterChange();this.getIntialFilterList(c);this._handleBottomSheetFilterEvents()},getIntialFilterList:function(c){var b=this,a=f.keys(gb.filterController.models[this.widgetGroupID].availableFilterOptions),d=f.keys(b.filterViews[0]._staticFilterAttrToValues),a=f.union(a,d,[gb.enums.BinningParams.REVIEW_RATING.key,gb.enums.BinningParams.SORT_ORDER.key]);this.filterJSONData={};f.each(gb.controller.schedulingParams[b.widgetID].filterConfig,function(d){var c=!1,e="";f.each(d.attr.split(","),function(d){!c&&f.contains(a,d)&&(c=!0);e||(e=b.filterViews[0].getLabelForSelectedAttribute(d))});c&&(b.filterJSONData[d.attr]={currentSelection:e,filterConfig:d})});d=f.without(Object.keys(b.filterJSONData),gb.enums.BinningParams.SORT_ORDER.key);if(!c&&d.length===1)(new GBFilterItemView({},{filterConfig:b.filterJSONData[d[0]].filterConfig,widgetView:b})).render();else{var e=gb.viewComponentBuilder.getBottomSheetFilterContentExpanderData(b,{isSortFilter:c}),d=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:"expander",data:e}),e=gb.viewComponentBuilder.getBottomSheetFilterHeaderData(b,{title:c?gb.resources.getString("gb_sort_by").toUpperCase():gb.resources.getString("csld-refine").toUpperCase(),showClearOption:!c,enableBack:0}),c=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:"header",data:e}),e=gb.viewComponentBuilder.getBottomSheetFilterFooterData(),e=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:"footer",data:e}),c={header:c,contents:d,footer:e};gb.controller.getBottomSheet().render(c)}},_handleBottomSheetFilterEvents:function(){var c=this;c.bottomSheetFilterEventsCache=c.bottomSheetFilterEventsCache||{};c.bottomSheetFilterEventsCache[c.widgetID]||(c.bottomSheetFilterEventsCache[c.widgetID]=f.once(function(){i.A.declarative("gbfilter-back-navigation-"+c.widgetID,"click",function(){c.getIntialFilterList(!1)});i.A.declarative("gbfilter-expander-"+c.widgetID,"click",function(b){(new GBFilterItemView({},{filterConfig:c.filterJSONData[b.data.attribute].filterConfig,widgetView:c})).render()})}));c.bottomSheetFilterEventsCache[c.widgetID].call()},refreshWidget:function(){var c=this,b=gb.controller.schedulingParams[c.widgetID];c.showLoading();b.fetchWatchedDeals&&gb.service.customerID&&gb.metadata.refreshWatchedDeals(c.widgetID);if(!b.watchedDealsWidget){delete gb.metadata.sortedDealIDs[c.widgetID];var a={};c.viewPortManager&&(a={dealsPerPage:gb.configManager.getWidgetViewConfig(c.widgetID).preFetchGDMDeals,getDealsSize:2*b.pageSize});gb.service.fetchDealWithData(c.widgetID,a,function(){gb.filterController._updateWidgetGroup(c.widgetGroupID)})}}})});gb.execute(function(i,f){k.GBSuppleWidgetView=GBWidgetView.extend({totalCellsRendered:0,isLeftFilterRequired:!1,initialize:function(c){var b=["all",gb.enums.BinningParams.PAGE.key,gb.enums.BinningParams.SORT_ORDER.key];this.isLeftFilterRequired=!f.isEmpty(f.reject(c.schedulingParams.filterConfig,function(a){return f.contains(b,a.attr)}));GBWidgetView.prototype.initialize.call(this,c)},renderWireFrame:function(){this.filterViews=[];gb.garbageCollector.clearDealViews(this.widgetID);this.totalCellsRendered=0;var c=gb.viewComponentBuilder.getSuppleWidgetViewTemplateData(this);this.skinDomElement.html(gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"wireFrame",data:c}));var c=this.skinDomElement.find(gb.enums.WidgetViewSelectors.PADCENTER),b=gb.enums.Constants.MIN_NAV_WIDTH;gb.controller.schedulingParams[this.widgetID].enforceLimitedDeals||(b-=gb.enums.Constants.SUPPLE_FILTER_COLUMN_WIDTH);c.css("min-width",b)},renderContent:function(c){var b=this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.FILTERS),a=gb.controller.schedulingParams[this.widgetID];if(c)this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CONTENT).empty(),b.empty(),b.height("auto"),this.filterViews=[],gb.garbageCollector.clearDealViews(this.widgetID);var d=gb.viewComponentBuilder.getSuppleWidgetViewTemplateData(this,c),c=gb.metadata.getAllDisplayableDealIDs(this.widgetID).length,e=gb.metadata.getSortedDealIDs(this.widgetID),g=gb.enums.WidgetViewIDs.CONTENT,d=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"widgetContent",data:d}),h=gb.controller.widgetCurrentPage[this.widgetID],f=a.pageSize;this.skinDomElement.find("#"+g).html(d);this.totalPages=Math.ceil(c/f);g=this.getATFDealsCount(c,a.enforceLimitedDeals,gb.widgetHelper.allDealsFetched[this.widgetID]);d=0;a.enforceLimitedDeals?d=e.length:c&&(d=Math.min(f,c-(h-1)*f));this.totalCellsRendered=0;this._renderFilterViews();for(var i=f=h=0;h<d;h++){var k=e[h];if(k){var r=this._isDoubleCell(k),o=r?2:1;i+o<=this.dealsPerRow||(f++,i=0);var s=new GBDealView({dealID:k,widgetView:this,position:h,isDoubleCell:r,row:f,column:i});i+o>=this.dealsPerRow?(i=0,f++):i+=o;this.dealViews[k]=this.dealViews[k]||{};this.dealViews[k][h]=s;s.render();this._publishLatencyMetrics(h,d,g,s);this._recordWidgetCF(a.featureScope);r=this._isDoubleCell(k);this.totalCellsRendered+=r?2:1;k=this.totalCellsRendered<=this.dealsPerRow;o=!1;this.totalCellsRendered%this.dealsPerRow===0?o=!0:h+1===e.length&&(o=!a.showLaunchCell||!a.enforceLimitedDeals);(r=this.getDealViewCSS(r,k,o))&&s.viewElement.addClass(r);gb.utils.isTouchDevice()&&a.showShortCellView&&s.viewElement.removeClass("shortCellView").addClass("shortCellViewTablet")}}this.widgetGroupID&&(e=b.height(),g=this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CONTENT).height(),e<g&&b.height(g));a.enforceLimitedDeals&&c>0&&this.renderLaunchCell();this._publishWidgetLatencyMetrics(a.featureScope);this._navigateToWidget();this._renderEllipsifiedTitle()},getATFDealsCount:function(c,b,a){var d=this.dealsPerRow;b?a&&d>c&&(d=c):d>c&&(d=c);return d},getDealsPerRow:function(){var c=i.$("#"+this.domElementID).width();!gb.controller.schedulingParams[this.widgetID].enforceLimitedDeals&&this.isLeftFilterRequired&&(c-=gb.enums.Constants.SUPPLE_FILTER_COLUMN_WIDTH);c=gb.utils.getDealsPerRow(c,this.minDealViewWidth,gb.configManager.getWidgetViewConfig(this.widgetID).hasMargin,!1,!0);c=Math.min(c,8);return c=Math.max(3,c)},renderLaunchCell:function(){if(gb.controller.schedulingParams[this.widgetID].enforceLimitedDeals&&gb.controller.schedulingParams[this.widgetID].showLaunchCell&&gb.widgetHelper.allDealsFetched[this.widgetID]&&f.keys(this.dealViews).length!==0){var c=this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.LAUNCH_CELL);c&&c.remove();var b=!1;this.totalCellsRendered<=this.dealsPerRow&&(b=!0);c=gb.viewComponentBuilder.getLaunchCellTemplateData(this);c=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"launchCell",data:c});b=this.getDealViewCSS(!1,b,!0);this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CONTENT).append(c);c=this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.LAUNCH_CELL);c.addClass(b)}},getDealViewCSS:function(c,b,a){var d=gb.resources.getCustomerData("realm"),d=d==="JP"||d==="CN"?"tallCellViewJPCN":"tallCellView";gb.controller.schedulingParams[this.widgetID].showShortCellView&&(d="shortCellView");d=d+" "+("gridColumn"+this.dealsPerRow);b&&gb.controller.schedulingParams[this.widgetID].enforceLimitedDeals&&(d+=" firstRowDiv");a&&(d+=" rightMostDiv");d+=c?" doubleCell":" singleCell";return d},_isDoubleCell:function(c){return gb.controller.schedulingParams[this.widgetID].enforceLimitedDeals&&gb.controller.schedulingParams[this.widgetID].showDoubleCellDOTD&&(f.contains(gb.metadata.dealsByType[gb.enums.DealTypes.DOTD],c)||f.contains(gb.metadata.dealsByAccessType[gb.enums.DealAccessTypes.PRIME_ONLY_DOTD],c))},renderErrorMessage:function(){if(!gb.controller.popOverVisible){this.removeErrorMessage();var c=gb.viewComponentBuilder.getCartErrorDisplayData();this.skinDomElement.prepend(gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"widgetErrorAlert",data:c}));gb.Backbone.$("html,body").animate({scrollTop:gb.Backbone.$("#"+this.domElementID).offset().top},"slow")}},removeErrorMessage:function(){var c=this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CART_ERROR);c.length>0&&c.remove()},getMinDealWidth:function(){return gb.enums.Constants.MIN_PC_VIEW_WIDTH}})});gb.execute(function(){k.GBShovelerWidgetView=GBWidgetView.extend({Constants:{MIN_SHOVELER_VIEW_WIDTH:223,RIGHT_PADDING:33,WIDGET_CONTENT_PERCENTAGE:0.95},initialize:function(i){GBWidgetView.prototype.initialize.call(this,i)},renderWireFrame:function(){gb.garbageCollector.clearDealViews(this.widgetID);var i=this.skinDomElement.width();if(i<gb.enums.Constants.MIN_NAV_WIDTH)i=gb.enums.Constants.MIN_NAV_WIDTH;this.skinDomElement.css("min-width",i);i=gb.viewComponentBuilder.getShovelerWidgetViewTemplateData(this);this.skinDomElement.html(gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"wireFrame",data:i}));this.renderStateHeader(i)},renderContent:function(){var i=gb.controller.schedulingParams[this.widgetID],f=gb.viewComponentBuilder.getShovelerWidgetViewTemplateData(this),c=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"widgetContent",data:f});this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CONTENT).html(c);this.renderShovlButtonsContent(!1,f);this._renderShovlPagination(f);for(var c=f.totalDeals<this.dealsPerRow?f.totalDeals:this.dealsPerRow,b=0,a=0,d=gb.metadata.getSortedDealIDs(this.widgetID);b<f.lastDealIDPosition;){var e=d[b];if(e){var g=new GBDealView({dealID:e,widgetView:this,position:b,row:1,column:a});this._recordWidgetCF(i.featureScope);this.dealViews[e]=this.dealViews[e]||{};this.dealViews[e][b]=g;g.render();this._publishLatencyMetrics(b,f.lastDealIDPosition,c,g);b++;a++}else b++}this._publishWidgetLatencyMetrics(i.featureScope);this._renderEllipsifiedTitle()},getDealsPerRow:function(){var i=this.skinDomElement.width();i-=this.Constants.RIGHT_PADDING;i*=this.Constants.WIDGET_CONTENT_PERCENTAGE;i=gb.utils.getDealsPerRow(i,this.minDealViewWidth,gb.configManager.getWidgetViewConfig(this.widgetID).hasMargin,!1,!0);i=Math.min(i,12);return i=Math.max(3,i)},renderErrorMessage:function(){if(!gb.controller.popOverVisible){this.removeErrorMessage();var i=gb.viewComponentBuilder.getCartErrorDisplayData();this.skinDomElement.prepend(gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"widgetErrorAlert",data:i}));i=this.skinDomElement.position().top;k.scrollY>i&&gb.Backbone.$("html,body").animate({scrollTop:i},"slow")}},removeErrorMessage:function(){var i=this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CART_ERROR);i.length>0&&i.remove()},getMinDealWidth:function(){return this.Constants.MIN_SHOVELER_VIEW_WIDTH},renderShovlButtonsContent:function(i,f){var c=f;c||(c=gb.viewComponentBuilder.getShovelerWidgetViewTemplateData(this));c.disableButton=i;var b=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"previousButton",data:c});this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.PREV_SHOVL_BUTTON).html(b);c=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"nextButton",data:c});this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.NEXT_SHOVL_BUTTON).html(c)},_renderShovlPagination:function(i){i=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"pagination",data:i});this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.SHOVL_PAGINATION).html(i)},renderStateHeader:function(i){i||(i=gb.viewComponentBuilder.getShovelerWidgetViewTemplateData(this));i=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"stateHeader",data:i});this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.SHOVL_STATE_HEADER).html(i)},showLoading:function(){var i=gb.templateManager.getWidgetHTML({widgetID:this.widgetID,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"widgetLoading"});this.skinDomElement.find("#"+gb.enums.WidgetViewIDs.CONTENT).html(i)}})});gb.execute(function(i){k.GBWidgetViewFactory=i.Model.extend({getWidgetView:function(f){switch(f.widgetName){case gb.enums.WidgetNames.PC_SUPPLE:return new GBSuppleWidgetView(f);case gb.enums.WidgetNames.PC_SHOVELER:return new GBShovelerWidgetView(f);default:return new GBWidgetView(f)}}})});gb.execute(function(i,f){k.GBFilterItemView=i.View.extend({_staticFilterAttrToValues:{},initialize:function(c,b){this.widgetView=b.widgetView;this.filterConfig=b.filterConfig;this.type=this.filterConfig.type;this.title=this.filterConfig.title;var a=this.filterConfig.attr.split(",");this.attributes=f.map(a,function(a){return i.$.trim(a)});this.viewElement=this.widgetView.skinDomElement.find("#"+gb.utils.getFilterItemViewID(this.attributes,this.type));this.viewElement.length?this.viewElement.empty():this.viewElement=this.widgetView.skinDomElement.find("#"+gb.enums.WidgetViewIDs.FILTERS);this._populateStaticFilterValues()},render:function(){this.filterOptions=this._getFilterOptionList(this.attributes,this.widgetView);if(gb.configManager.getWidgetViewConfig(this.widgetView.widgetID).showBottomSheetFilter){var c=gb.viewComponentBuilder.getBottomSheetFilterContentData(this),b=gb.templateManager.getWidgetHTML({widgetID:this.widgetView.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:"links",data:c}),c=gb.viewComponentBuilder.getBottomSheetFilterHeaderData(this,{title:gb.resources.getString(this.filterConfig.title).toUpperCase(),showClearOption:0,enableBack:f.without(gb.filterController.models[this.widgetView.widgetGroupID].attributesList,gb.enums.BinningParams.SORT_ORDER.key).length===1?0:1}),a=gb.templateManager.getWidgetHTML({widgetID:this.widgetView.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:"header",data:c}),c=gb.viewComponentBuilder.getBottomSheetFilterFooterData(),c=gb.templateManager.getWidgetHTML({widgetID:this.widgetView.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:"footer",data:c}),b={header:a,contents:b,footer:c};gb.controller.getBottomSheet().render(b)}else c=gb.viewComponentBuilder.getFilterViewTemplateData(this),c.elements=this.generateFilterViewComponent(c),this.viewSkin=gb.templateManager.getWidgetHTML({widgetID:this.widgetView.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:"filterItem",data:c}),this.viewElement.append(this.viewSkin);this._handleFilterChange()},generateFilterViewComponent:function(c){var b={};b[this.type]=gb.templateManager.getWidgetHTML({widgetID:this.widgetView.widgetID,templateGroup:gb.templateManager.TemplateGroups.FILTER_VIEW,templateName:this.type,data:c});return b},getFilterLabel:function(c,b){var a;switch(c.attribute){case gb.enums.BinningParams.CATEGORIES.key:a=gb.resources.whitelistedCategoryNamesParsed[c.value];break;case gb.enums.BinningParams.DEAL_STATE.key:case gb.enums.BinningParams.DEAL_TYPE.key:case gb.enums.BinningParams.PRIME_ACCESS_TYPE.key:if(!(c.value===gb.enums.DealAccessTypes.PRIME_ONLY_LD||c.value===gb.enums.DealAccessTypes.PRIME_ONLY_DOTD)||gb.resources.getFeature("prime_only_access"))a=gb.enums.FilterAttrToStrings[c.value],a=gb.resources.getString(a);break;case gb.enums.BinningParams.DISCOUNT.key:a=gb.enums.FilterAttrToStrings.DISCOUNT;if(c.rangeStart){if(!c.rangeEnd)a=gb.enums.FilterAttrToStrings.DISCOUNT_END}else a=gb.enums.FilterAttrToStrings.DISCOUNT_START;a=gb.resources.getString(a,{start:c.rangeStart,end:c.rangeEnd});break;case gb.enums.BinningParams.FREE_SHIPPING_ELIGIBLE_ONLY.key:a=gb.enums.FilterAttrToStrings.FREE_SHIPPING_ELIGIBLE_ONLY;a=gb.resources.getString(a);break;case gb.enums.BinningParams.GIFT_WRAPPABLE.key:a=gb.enums.FilterAttrToStrings.GIFT_WRAPPABLE;a=gb.resources.getString(a);break;case gb.enums.BinningParams.GLOBAL_ELIGIBLE_ONLY.key:a=gb.enums.FilterAttrToStrings.GLOBAL_ELIGIBLE_ONLY;a=gb.resources.getString(a);break;case gb.enums.BinningParams.NEW_RELEASES.key:a=gb.enums.FilterAttrToStrings.NEW_RELEASES;a=gb.resources.getString(a);break;case gb.enums.BinningParams.PRICE.key:a=gb.enums.FilterAttrToStrings.PRICE;if(c.rangeStart){if(!c.rangeEnd)a=gb.enums.FilterAttrToStrings.PRICE_END}else a=gb.enums.FilterAttrToStrings.PRICE_START;a=gb.resources.getString(a,{start:c.rangeStart,end:c.rangeEnd});break;case gb.enums.BinningParams.PRIME_ELIGIBLE_ONLY.key:a=b?gb.enums.FilterAttrToStrings.PRIME_SUMMARY:gb.enums.FilterAttrToStrings.PRIME;a=gb.resources.getString(a);break;case gb.enums.BinningParams.REVIEW_RATING.key:a=gb.enums.FilterAttrToStrings.REVIEW_RATING;a=gb.resources.getString(a,{stars:c.selected});break;case gb.enums.BinningParams.SORT_ORDER.key:a=gb.enums.SortOrdersToStringsMap[c.selected];a=gb.resources.getString(a);break;case gb.enums.BinningParams.CASH_ON_DELIVERY.key:a=gb.enums.FilterAttrToStrings.CASH_ON_DELIVERY;a=gb.resources.getString(a);break;case gb.enums.BinningParams.FULLFILLED_BY_AMAZON.key:a=gb.enums.FilterAttrToStrings.FULLFILLED_BY_AMAZON;a=gb.resources.getString(a);break;default:a=c.value}return a},_paginationDummyUrls:{PREV:"prev",NEXT:"next"},_getTypeCorrectedData:function(c){var b=parseInt(c,10);return!isNaN(b)&&b+""===c&&b>=0?b:f.isNumber(c)&&c<0?c.toString():c},_handleFilterChange:f.once(function(){var c=this,b=function(a){var d=f.tail(arguments)[0],b=d.$target.closest("[data-widgetid]").data("widgetid");if(b){var g=gb.widgets[b].widgetGroupID,h=d.data.attribute,l=d.data.attributes;a.call(c,d,{widgetID:b,widgetGroupID:g,attribute:h,attributes:l,linkType:d.data.linkType,redirectURL:d.data.redirectURL,title:d.data.title,metrics:{widgetID:b,eventID:g,data:[g,h||l],context:gb.metrics.refTags.filter},isSelected:d.data.isSelected},gb.filterController.models[g]);return!1}};i.A.declarative("gbfilter-checkbox","change",f.wrap(function(a,d,b){var c=a.data.value;a.$target.is(":checked")?b.addFilterValue(d.attribute,c,d.metrics):(d.metrics.context=gb.metrics.refTags.clearFilter,b.removeFilterValue(d.attribute,c,d.metrics))},b));i.A.declarative("gbfilter-dropdown","change",f.wrap(function(a,d,b){a=a.$target.val();b.setFilterValue(d.attribute,a,d.metrics)},b));i.A.declarative("gbfilter-link","click",f.wrap(function(a,d,b){if(d.linkType==="clear")if(d.isSelected==="true")gb.controller.getBottomSheet().close();else{var g=f.map(d.attributes.split(","),i.$.trim);f.each(g,function(a){b.removeFilterValue(a,m,d.metrics,!0)});b.triggerChangeEvent(d.metrics)}else a.data.attribute===gb.enums.BinningParams.DEAL_TYPE.key?b.removeFilterValue(gb.enums.BinningParams.PRIME_ACCESS_TYPE.key,m,m,!0):a.data.attribute===gb.enums.BinningParams.PRIME_ACCESS_TYPE.key&&b.removeFilterValue(gb.enums.BinningParams.DEAL_TYPE.key,m,m,!0),g=a.$target.closest("[data-value]").data("value"),a.$target.closest("[data-isselected]").data("isselected")?gb.controller.getBottomSheet().close():g&&(g=a.data.attribute===gb.enums.BinningParams.CATEGORIES.key?g.toString():c._getTypeCorrectedData(g),b.setFilterValue(d.attribute,g,d.metrics));a.$event.preventDefault()},b));i.A.declarative("gbfilter-faceout","click",f.wrap(function(a,d,b){a=a.$target.closest("[data-value]").data("value");if(d.redirectURL){var c=encodeURIComponent(d.title);b.redirectURL=gb.utils.setUrlParam(d.redirectURL,"ttl",c);if(gb.clientName===gb.enums.MobileClients.APP||gb.clientName===gb.enums.MobileClients.AW)b.doPageRefresh=!0}a?(a=a.toString(),b.removeFilterValue(d.attribute,m,d.metrics,!0),d.metrics.context=gb.metrics.refTags.filter,b.addFilterValue(d.attribute,a,d.metrics)):b.removeFilterValue(d.attribute,m,d.metrics)},b));i.A.declarative("gbfilter-clear-all","click",f.wrap(function(a,d,b){d.metrics.context=gb.metrics.refTags.clearFilter;b.removeAllFilterValues(null,null,d.metrics)},b));i.A.declarative("gbfilter-pagination","click",f.wrap(function(a,d,b){var g=parseInt(a.data.currentPage,10),h=parseInt(a.data.totalPages,10),f=a.$target.closest("[data-page]").data("page");parseInt(f,10)||(f=m);a.$event.preventDefault();f||(a=a.$target[0].href&&a.$target[0].href.split("#")[1],a===c._paginationDummyUrls.PREV&&g>1?f=g-1:a===c._paginationDummyUrls.NEXT&&g<h&&(f=g+1));f&&(gb.controller.widgetCurrentPage[d.widgetID]=f,b.setFilterValue(d.attribute,f,d.metrics))},b))}),_sortAlphabetically:function(c){c=f.pairs(c);return f.sortBy(c,function(b){return b[0]})},_sortRanges:function(c){c=f.pairs(c);return f.sortBy(c,function(b){b=b[0].split("-")[0]||0;return parseInt(b,10)})},_getFilterOptionList:function(c,b){var a=this,d=[],e=gb.filterController.models[b.widgetGroupID];if(c[0]==="all"){c=f.keys(e.availableFilterOptions);c.push(gb.enums.BinningParams.PAGE.key);var g=gb.filterController.models[b.widgetGroupID].attributesList,h=f.keys(a._staticFilterAttrToValues),h=f.union(h,[gb.enums.BinningParams.REVIEW_RATING.key,gb.enums.BinningParams.FREE_SHIPPING_ELIGIBLE_ONLY.key]),c=f.union(c,f.intersection(g,h))}f.each(c,function(b){var c;c=a._staticFilterAttrToValues[b]?a._getStaticBinningResponse(b):e.availableFilterOptions[b]||{};b=a._getFilterOptions(b,c);Array.prototype.push.apply(d,b)});return d},_getFilterOptionsForDealStates:function(c,b){var a={};f.each(c,function(d){var b=gb.enums.DealStatesToFilterStates[d[0]],c=parseInt(a[b],10);a[b]=c?(c+parseInt(d[1],10)).toString():d[1]});return f.map(a,function(a,c){return{value:c,selected:f.contains(b,c),count:a,attribute:gb.enums.BinningParams.DEAL_STATE.key}})},_populateStaticFilterValues:function(){this._staticFilterAttrToValues[gb.enums.BinningParams.DEAL_STATE.key]=gb.enums.DealStates;this._staticFilterAttrToValues[gb.enums.BinningParams.DEAL_TYPE.key]=gb.enums.DealTypes;this._staticFilterAttrToValues[gb.enums.BinningParams.PRIME_ACCESS_TYPE.key]=gb.enums.DealAccessTypes},_getStaticBinningResponse:function(c){c=f.values(this._staticFilterAttrToValues[c]);return f.object(f.map(f.values(c),function(b){return[b,1]}))},_getFilterOptions:function(c,b){var a,d=gb.filterController.models[this.widgetView.widgetGroupID].getSelectedBinningValues(c);if(c===gb.enums.BinningParams.PRICE.key)f.isArray(d)||(d=[d]),a=this._sortRanges(b),a=f.map(a,function(a){var b=a[0].split("-");return{rangeStart:b[0],rangeEnd:b[1],value:a[0],count:a[1],attribute:c,selected:f.contains(d,a[0])}});else if(c===gb.enums.BinningParams.DISCOUNT.key){var e="",g=0;f.isArray(d)&&(d=d.join(","));a=this._sortRanges(b).reverse();a=f.map(a,function(a){var b=a[0].split("-");e=e?a[0]+","+e:a[0];g+=a[1];return{rangeStart:b[0]?b[0]:"0",value:e,count:g,attribute:c,selected:d===e}});a=a.reverse()}else if(c===gb.enums.BinningParams.PAGE.key)a=[{currentPage:gb.controller.widgetCurrentPage[this.widgetView.widgetID],totalPages:this.widgetView.totalPages,dummyUrls:this._paginationDummyUrls,count:1,attribute:c,minimalPagination:gb.configManager.getWidgetViewConfig(this.widgetView.widgetID).minimalPagination}];else if(c===gb.enums.BinningParams.SORT_ORDER.key||c===gb.enums.BinningParams.REVIEW_RATING.key)a=[{count:1,attribute:c,selected:d}];else if(c===gb.enums.BinningParams.PRIME_ELIGIBLE_ONLY.key||c===gb.enums.BinningParams.GLOBAL_ELIGIBLE_ONLY.key||c===gb.enums.BinningParams.NEW_RELEASES.key||c===gb.enums.BinningParams.GIFT_WRAPPABLE.key||c===gb.enums.BinningParams.FREE_SHIPPING_ELIGIBLE_ONLY.key||c===gb.enums.BinningParams.CASH_ON_DELIVERY.key||c===gb.enums.BinningParams.FULLFILLED_BY_AMAZON.key)a=[{value:1,selected:d,count:1,attribute:c}];else{c===gb.enums.BinningParams.CATEGORIES.key?(a=f.filter(gb.resources.whitelistedCategoryList,function(a){return a in b}),a=f.map(a,function(a){return[a,b[a]]})):a=this._sortAlphabetically(b);var h=gb.filterController.models[this.widgetView.widgetGroupID].filterConfigValuesHash[c];h&&(a=f.filter(a,function(a){return f.contains(h,a[0])?!0:!1}),a=f.sortBy(a,function(a){return f.indexOf(h,a[0])}));f.isArray(d)||(d=[d]);a=c===gb.enums.BinningParams.DEAL_STATE.key?this._getFilterOptionsForDealStates(a,d):f.map(a,function(a){return{value:a[0],selected:f.contains(d,a[0]),count:a[1],attribute:c}})}return a},getLabelForSelectedAttribute:function(c){var b,a=gb.filterController.models[this.widgetView.widgetGroupID].getSelectedBinningValues(c);a&&(b={},gb.enums.BinningParams.DEAL_STATE.key===c?b=f.object(gb.enums.FilterStatesToDealStates[a],f.range(gb.enums.FilterStatesToDealStates[a].length).map(function(){return 1})):b[a]=1,b=this.getFilterLabel(this._getFilterOptions(c,b)[0]));return b}})});gb.execute(function(i,f){k.BottomSheetView=i.View.extend({els:{},elClasses:{},elHTMLs:{header:"",contents:"",footer:""},modalHeight:0,currentSheetHeightPercentage:0,minScrollableHeight:0,isModalTranslating:!1,maxScrollTopPosition:0,isIphone:!1,initialScrollPosition:0,scrollDirection:0,bodyScrollPosition:0,Constants:{EL_LIST:"container,background,modal,header,contents,footer".split(","),CSS_CLASS_PREFIX:"bottomSheet",BASE_HTML:'<div class="bottomSheetContainer BOTTOM-SHEET"><div class="bottomSheetBackground"></div><div class="bottomSheetModal"><div class="bottomSheetHeader"></div><div class="bottomSheetContents"></div><div class="bottomSheetFooter"></div></div></div>',ANIMATE_TIMEOUT:20,SHEET_MAX_HEIGHT_RATIO:0.5,PARTIAL_VISIBLE_ROW_HEIGHT:0.6,SCROLL_TOP_BUFFER:5},_getElClass:function(c){return!f.contains(this.Constants.EL_LIST,c)?void 0:this.Constants.CSS_CLASS_PREFIX+c.charAt(0).toUpperCase()+c.substr(1).toLowerCase()},initialize:function(){var c=this;f.each(this.Constants.EL_LIST,function(b){c.elClasses[b]=c._getElClass(b)})},render:function(c){var b=this;if(!f.isEmpty(c)){this.isIphone=gb.resources.deviceInfo.isIOS;var a=i.$(k).height(),d=i.$("body"),e=b.isBottomSheetDomPresent();if(!e)b.bodyScrollPosition=i.$("body")[0].scrollTop,i.$("#a-page").css({height:a+"px",overflow:"hidden"}),i.$("#a-page")[0].scrollTop=b.bodyScrollPosition;f.each(f.keys(this.elHTMLs),function(a){c[a]&&(b.elHTMLs[a]=c[a])});e||d.append(this.Constants.BASE_HTML);b=this;f.each(this.Constants.EL_LIST,function(a){b.els[a]=d.find("."+b.elClasses[a])});b=this;f.each(this.elHTMLs,function(a,d){b.els[d].html(a)});b.modalHeight=b.els.header.outerHeight()+b.els.footer.height()+b.els.contents.height();this.setContainerProperties();this.registerEvents();e?this.maxScrollTopPosition+this.minScrollableHeight<this.Constants.SHEET_MAX_HEIGHT_RATIO*a?this.els.container[0].scrollTop=this.maxScrollTopPosition:(a=this.els.contents.children().eq(0).children().eq(0).height(),this.els.container[0].scrollTop=(Math.floor((this.els.container[0].scrollTop+a)/a)+b.Constants.PARTIAL_VISIBLE_ROW_HEIGHT-1)*a):this.animate();(!k.history.state||!k.history.state.bottom_sheet_open)&&k.history.pushState({bottom_sheet_open:1},"","")}},registerEvents:function(){var c=this;c.isEventRegistered(this.els.background,"touchmove")||this.els.background.bind("touchmove",function(b){b.stopPropagation();b.preventDefault()});c.isEventRegistered(this.els.background,"click")||this.els.background.bind("click",function(b){c.isModalTranslating||b.target===this&&c.close()});c.isEventRegistered(this.els.container,"scroll")||this.els.container.scroll(function(){c.scrollTransition()});c.isEventRegistered(this.els.modal,"touchstart")||this.els.modal.bind("touchstart",function(b){if(gb.resources.deviceInfo.isIOS)c.initialScrollPosition=b.originalEvent.touches[0].pageY;b.stopPropagation()});i.$(k).resize(function(){var b=i.$(k).height();c.setContainerProperties();c.els.background.css("max-height",b-c.minScrollableHeight);c.els.container[0].scrollTop=b*c.currentSheetHeightPercentage});c.isEventRegistered(this.els.modal,"touchmove")||this.els.modal.bind("touchmove",function(b){b.stopPropagation();c.isModalTranslating&&b.preventDefault();if(c.isIphone)c.scrollDirection=b.originalEvent.touches[0].pageY===c.initialScrollPosition?0:b.originalEvent.touches[0].pageY<c.initialScrollPosition?1:-1,c.initialScrollPosition=b.originalEvent.touches[0].pageY});this.isIphone&&!c.isEventRegistered(this.els.modal,"touchend")&&this.els.modal.bind("touchend",function(){var b=0;c.scrollDirection===-1?b=-c.els.container[0].scrollTop:c.scrollDirection===1&&(b=c.maxScrollTopPosition-c.els.container[0].scrollTop);if(b!==0)c.isModalTranslating=!0,c.els.modal.addClass("scrollTransition"),c.els.background.addClass("scrollTransition"),c.els.modal.css(c._getTranslateCss(-b+"px")),c.els.background.css(c._getTranslateCss(-b+"px")),c.els.modal.bind("transitionend webkitTransitionEnd",function(){c.isModalTranslating=!1;c.scrollDirection=0;c.els.modal.removeClass("scrollTransition");c.els.background.removeClass("scrollTransition");c.els.modal.css(c._getTranslateCss(0));c.els.background.css(c._getTranslateCss(0));c.els.container[0].scrollTop+=b;c.els.modal.unbind("transitionend webkitTransitionEnd")})})},animate:function(){var c=i.$(k).height(),b=this.Constants.SHEET_MAX_HEIGHT_RATIO*c,a;if(this.modalHeight>b){a=this.els.contents.children().eq(0).children().eq(0).height();b=Math.ceil((b-this.els.header.outerHeight()-this.els.footer.height())/a)*a+a*this.Constants.PARTIAL_VISIBLE_ROW_HEIGHT+this.els.header.outerHeight()+this.els.footer.height();if(b>this.modalHeight)b=this.modalHeight;this.els.modal.css("height",b)}else b=this.modalHeight;this.els.contents.css("padding-bottom",this.els.footer.height()+"px");this.currentSheetHeightPercentage=b/(c-this.minScrollableHeight);var d=this;setTimeout(function(){d.isModalTranslating=!0;d.els.modal.addClass("slideAnimateUp");d.els.background.addClass("slideAnimateUp");d.els.modal.css(d._getTranslateCss(-b+"px"));d.els.background.css(d._getTranslateCss(-b+"px"))},d.Constants.ANIMATE_TIMEOUT);this.els.modal.bind("transitionend webkitTransitionEnd",function(){d.isModalTranslating=!1;d.els.modal.removeClass("slideAnimateUp");d.els.background.removeClass("slideAnimateUp");d.els.modal.css(d._getTranslateCss(0));d.els.background.css(d._getTranslateCss(0));i.$("body").append(d.els.footer);d.els.modal.css("height","100%");d.els.container[0].scrollTop=b;var a=d.els.container[0].scrollTop;d.els.background.css("max-height",c-d.minScrollableHeight);d.els.container[0].scrollTop=a-d.minScrollableHeight;d.els.modal.unbind("transitionend webkitTransitionEnd")})},scrollTransition:function(){var c=i.$(k).height(),b=this.els.container[0].scrollTop;this.currentSheetHeightPercentage=b/(c-this.minScrollableHeight);if(b>=parseInt(this.els.background.css("max-height"),10)-this.Constants.SCROLL_TOP_BUFFER)this.els.container[0].scrollTop=c,this.isIphone&&this.els.modal.unbind("touchstart touchmove touchend"),this.els.container.css({overflow:"hidden"}),this.els.contents.css({"overflow-y":"scroll","-webkit-overflow-scrolling":"touch"})},close:function(){var c=this;if(c.isBottomSheetDomPresent()){if(k.history.state&&k.history.state.bottom_sheet_open)gb.globalFlags.ignoreBottomSheet=!0,k.history.back();this.els.modal.append(i.$("."+this.elClasses.footer));var b=c.els.container[0].scrollTop;this.els.background.css({"max-height":i.$(k).height()});c.els.container[0].scrollTop=b+c.minScrollableHeight;this.els.modal.bind("transitionend webkitTransitionEnd",function(){c.isModalTranslating=!1;c.els.container[0].scrollTop=0;c.els.currentSheetHeightPercentage=0;c.els.background.unbind("click");c.isIphone&&c.els.modal.unbind("touchstart touchmove touchend");c.els.modal.unbind("transitionend webkitTransitionEnd");c.removeContent()});setTimeout(function(){c.isModalTranslating=!0;i.$("#a-page").css({height:"",overflow:""});i.$("body")[0].scrollTop=c.bodyScrollPosition;c.els.modal.addClass("slideAnimateDown");c.els.background.addClass("slideAnimateDown");c.els.modal.css(c._getTranslateCss(c.els.container[0].scrollTop+"px"));c.els.background.css(c._getTranslateCss(c.els.container[0].scrollTop+"px"))},20)}},removeContent:function(){this.els.container.remove()},_getTranslateCss:function(c){c="translate3d(0,"+c+", 0)";return{"-webkit-transform":c,"-o-transform":c,"-moz-transform":c,"-ms-transform":c,transform:c}},setContainerProperties:function(){var c=i.$(k).height();this.els.container.css({"max-height":c,overflow:"auto"});this.els.background.css("height",c);this.els.modal.css("max-height",c);this.els.contents.css({"max-height":c-this.els.header.outerHeight(),overflow:"hidden"});this.minScrollableHeight=this.els.footer.height()+this.els.header.outerHeight()+this.els.contents.children().eq(0).children().eq(0).height();this.maxScrollTopPosition=this.els.contents.height()-this.els.contents.children().eq(0).children().eq(0).height()},isEventRegistered:function(c,b){var a=!1,d=i.$._data(c[0],"events");d!==m&&d[b]!==m&&(a=!0);return a},isBottomSheetDomPresent:function(){return this.elClasses&&this.elClasses.container?i.$("."+this.elClasses.container).length:!1}})});gb.execute(function(i,f){k.GBWatchDealView=i.View.extend({defaults:{isWatchDealPopupRendered:null,domain:null,key:null,watchDealPopupHandler:null},initialize:function(){this.domain=gb.enums.WatchDealViewKeys.GOLDBOX_DOMAIN;this.key=gb.enums.WatchDealViewKeys.DISMISS_WATCHPOPUP_KEY;this.isWatchDealPopupRendered=!1;this._handleWatchUnwatchActions();i.A.on.afterLoad(function(){if(gb.controller.watchDealView&&!gb.controller.watchDealView.isWatchDealPopupRendered&&gb.controller.watchDealView.changeWatchPopupState(gb.enums.WatchDealPopoverActions.SHOW_WATCH_POPUP))gb.controller.watchDealView.isWatchDealPopupRendered=!0})},_handleWatchUnwatchActions:f.once(function(){i.A.on("a:popover:dismiss:watch_preload",function(){var c=gb.controller.watchDealView,b=k.dealNotifier;c.changeWatchPopupState(gb.enums.WatchDealPopoverActions.HIDE_WATCH_POPUP);gb.watchDealService.modifyPopupStatus({action:gb.enums.SembuActions.SET_COOKIE,type:gb.enums.DataTypes.BOOL,value:1,key:c.key,domain:c.domain});gb.resources.customerData.isWatchDealPopupMarked=!0;b&&b.watchDealNotifier&&b.watchDealNotifier.registerWatchDeals([])});n.when("A","a-popover","ready").execute(function(c,b){gb.controller.watchDealView.watchDealPopupHandler=b})}),changeWatchPopupState:function(c){if(gb.controller.watchDealView.watchDealPopupHandler){var b=gb.controller.watchDealView.watchDealPopupHandler.get(i.A.$("#"+gb.enums.WatchDealViewIDs.WATCH_POPOVER));if(b){switch(c){case gb.enums.WatchDealPopoverActions.SHOW_WATCH_POPUP:b.lock().show();break;case gb.enums.WatchDealPopoverActions.HIDE_WATCH_POPUP:b.unlock().hide();break;case gb.enums.WatchDealPopoverActions.UPDATE_WATCH_POPUP:b.lock().show().updatePosition()}return!0}}return!1},resetWatchDealVariables:function(){if(gb.controller.watchDealView.changeWatchPopupState(gb.enums.WatchDealPopoverActions.HIDE_WATCH_POPUP))gb.controller.watchDealView.isWatchDealPopupRendered=!1},triggerMouseEventsOnWatchingDeal:function(c,b,a){a==="mouseenter"?(b.find("#"+gb.enums.WatchDealViewIDs.WATCH_BUTTON_TEXT+c).html(gb.resources.getString("gb_stop_watching_deal")),b.find("#"+gb.enums.WatchDealViewIDs.WATCHING_IMAGE+c).removeClass("watchingImage").addClass("stopWatchingImage"),b.find(".watchingText").removeClass("watchingText").addClass("stopWatchingText")):a==="mouseleave"&&(b.find("#"+gb.enums.WatchDealViewIDs.WATCH_BUTTON_TEXT+c).html(gb.resources.getString("gb_watching_deal")),b.find("#"+gb.enums.WatchDealViewIDs.WATCHING_IMAGE+c).removeClass("stopWatchingImage").addClass("watchingImage"),b.find(".stopWatchingText").removeClass("stopWatchingText").addClass("watchingText"))},_isPopupTriggerRequired:function(c){return!(gb.resources.customerData.isWatchDealPopupMarked||gb.controller.watchDealView.isWatchDealPopupRendered)&&gb.controller.schedulingParams[c.widgetID].fetchWatchedDeals},_isPopupTriggerRequiredForMiniDP:function(c){return!gb.resources.customerData.isWatchDealPopupMarked&&gb.controller.schedulingParams[c.widgetID].fetchWatchedDeals}})});gb.execute(function(i,f){k.GBMetadata=i.Model.extend({sortedDealIDs:{},dealIDLocations:{},selectedDealsCount:{},binningInfo:{},dealsByType:{},dealsByState:{},dealsByAccessType:{},metadataResponse:{},watchedDeals:{},dealCategoryHash:{},initialize:function(){this.registerConnections()},registerConnections:function(){this.on("ConsumeMetadataChange",this.updateMetadata);this.on("RefreshWatchedDealWidgets",this.updateWatchDealWidgets)},parseSortedDealIDs:function(c,b){var a=gb.controller.schedulingParams[c],d=a.prioritizedDealIDs;if(gb.controller.isPaginatedMetadataCall(c)){if(d.length){var e=this.dealsByState[gb.enums.DealStates.AVAILABLE];b.sortedDealIDs=f.intersection(b.sortedDealIDs,e)}}else{if(d.length&&(e=b.dealsByState[gb.enums.DealStates.AVAILABLE],d=f.intersection(d,e),d.length))b.sortedDealIDs=f.union(d,b.sortedDealIDs);if(a.enforceLimitedDeals)b.sortedDealIDs=b.sortedDealIDs.slice(0,a.pageSize)}},registerMetadata:function(c,b,a){typeof a==="undefined"&&(a=!0);this.metadataResponse[c]=b;var d=gb.controller.schedulingParams[c];if(d.enableDeDuping)b.sortedDealIDs=this.deDupeDeals(b.sortedDealIDs,c);if(gb.controller.isPaginatedMetadataCall(c)){this.sortedDealIDs[c]=b.sortedDealIDs||[];if(!d.enforceLimitedDeals){var e=b.selectedDealsCount?parseInt(b.selectedDealsCount,10):0,g=d.pageSize,h=0;d.page>1&&d.fetchSinglePage&&(h=(d.page-1)*g);this.sortedDealIDs[c]=gb.utils.getExtendedArray(e,b.sortedDealIDs,h)}if(b.binning)this.binningInfo[c]=b.binning}else this.registerSortedDealIDs(c,b),this.registerDealCategoryHashMap(b),this.populateIsDigitalDeals();this.registerDealIDLocations(c);this.selectedDealsCount[c]=parseInt(b.selectedDealsCount,10)||0;gb.controller.trigger("WidgetPageUpdate",c,a)},registerSortedDealIDs:function(c,b){var a=this,d=gb.controller.widgetCurrentStatus[c],e=gb.controller.widgetCurrentCategory[c],g=b.dealsByState[d.toUpperCase()]||[];a.sortedDealIDs[c]={};a.sortedDealIDs[c][d]={};d===gb.enums.StatusFilters.AVAILABLE?(g=g.concat(b.dealsByState.UPCOMING||[]),a._isWidgetScheduledWithDOTD(c)&&!gb.utils.isWidgetWithStatusFilter(gb.widgets[c].widgetName)&&(g=g.concat(b.dealsByState.SOLDOUT))):d===gb.enums.StatusFilters.MISSED&&(g=b.dealsByState[d.toUpperCase()]||[],g=g.concat(b.dealsByState.SOLDOUT));var h=gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS;e!==gb.enums.CategoryFilters.ALL&&e!==h?g=f.intersection(g,b.dealsByCategory[e]):e===h&&(g=f.intersection(g,a.metadataResponse.dealsByAccessType[h]));a.sortedDealIDs[c][d][e]=f.intersection(b.sortedDealIDs,g);f.each(a.sortedDealIDs[c][d][e],function(b,g){a.registerDealIDLocation(b,c,d,e,g)})},registerDealIDLocations:function(c){var b=this;gb.controller.isPaginatedMetadataCall(c)?f.each(b.sortedDealIDs[c],function(a,d){b.dealIDLocations[a]=b.dealIDLocations[a]||{};b.dealIDLocations[a][c]=d}):f.each(b.sortedDealIDs[c],function(a,d){f.each(a,function(a,g){f.each(a,function(a,e){b.registerDealIDLocation(a,c,d,g,e)})})})},registerDealCategoryHashMap:function(c){var b=this;f.each(c.dealsByCategory,function(a,d){f.each(a,function(a){b.dealCategoryHash[a]||(b.dealCategoryHash[a]=[]);f.indexOf(b.dealCategoryHash[a],d)===-1&&b.dealCategoryHash[a].push(d)})})},populateIsDigitalDeals:function(){f.each(this.dealCategoryHash,function(c,b){gb.controller.getDealDAO(b).isDigital=gb.utils.hasDigitalCategory(c)})},registerWatchedDeals:function(c){c[gb.enums.Constants.ALL]=f.flatten(c);this.watchedDeals=c},updateWatchedDeals:function(c){var b,a,d=this.watchedDeals;a=gb.controller.dealDAOs[c];b=f.keys(gb.widgets);a.isDealWatched?(a=gb.enums.WatchedDealStateMap.UPCOMING,d.ALL=f.union(d.ALL,[c]),d[a]=d[a]||[],d[a]=f.union(d[a],[c])):(a=gb.enums.WatchedDealStateMap[a.dealState],d.ALL=f.without(d.ALL,c),d[a]=f.without(d[a],c));this.trigger("RefreshWatchedDealWidgets",b,c)},refreshWatchedDeals:function(c){var b=this,c=gb.metrics.generateRef(c,gb.metrics.refTags.getWatchedDeals,["ALL"]);gb.service.getWatchedDeals(function(a){if(a.error)throw Error("Sable call to fetch watched deals failed");else gb.metadata.registerWatchedDeals(a.data),a=f.keys(gb.widgets),f.each(a,function(a){var c=gb.controller.schedulingParams[a];c.watchedDealsWidget&&(c=gb.utils.getWatchedDealWidgetData(c.dealStates),b.registerMetadata(a,c))}),f.each(gb.metadata.watchedDeals.ALL,function(a){gb.controller.dealDAOs[a]&&(gb.controller.dealDAOs[a].isDealWatched=!0)})},c)},updateWatchDealWidgets:function(c,b){var a=this,d=gb.controller.dealDAOs[b],e=gb.enums.WatchedDealStateMap[d.dealState],g=!1,h=gb.metadata.watchedDeals.ALL.length;if(h===0||h===1&&d.isDealWatched)g=!0;f.each(c,function(c){var h=gb.controller.schedulingParams[c];if(h.watchedDealsWidget){var i=gb.utils.getWatchedDealStates(h.dealStates),h=a.getAllDisplayableDealIDs(c),r=f.indexOf(h,b);if((i=f.contains(i,e))||r!==-1){var o=!0;i&&d.isDealWatched&&r===-1?h.unshift(b):(!d.isDealWatched||!i)&&r!==-1?h.splice(r,1):o=!1;if(o){var s={sortedDealIDs:h,selectedDealsCount:h.length,dealsByState:{}};s.dealsByState[gb.enums.DealStates.AVAILABLE]=h;gb.widgets[c].dealViews[b]&&gb.metadata.watchedDeals.ALL&&gb.metadata.watchedDeals.ALL.length?(f.each(gb.widgets[c].dealViews[b],function(a){a.viewElement.slideUp(200)}),k.setTimeout(function(){a.registerMetadata(c,s)},200)):a.registerMetadata(c,s)}}else g&&gb.controller.trigger("WidgetPageUpdate",c,!0)}})},getSortedDealIDs:function(c,b){b||(b=gb.controller.widgetCurrentPage[c]||0);var a=gb.controller.schedulingParams[c],d=a.pageSize||0,e=d*(b-1),d=e+d*2,g=this.getAllDisplayableDealIDs(c);return g?a.enforceLimitedDeals?g:g.slice(e,d):[]},getAllDisplayableDealIDs:function(c){var b=[];if(gb.controller.isPaginatedMetadataCall(c)){var b=this.sortedDealIDs[c],a=this.dealsByType[gb.enums.DealTypes.DOTD]||[],d=this.dealsByAccessType[gb.enums.DealAccessTypes.PRIME_ONLY_DOTD]||[],e=gb.controller.schedulingParams[c];e.enforceLimitedDeals&&e.showDoubleCellDOTD&&(b=this._rearrangeDealIds(c,b,f.union(a,d)));return b}else a=gb.controller.widgetCurrentStatus[c],d=gb.controller.widgetCurrentCategory[c],a&&d&&this.sortedDealIDs[c][a]&&this.sortedDealIDs[c][a][d]&&(b=this.sortedDealIDs[c][a][d]);return this._insertBlankDealIDs(c,b)},getMetadataCategories:function(c){var b=[];if(!gb.controller.isPaginatedMetadataCall(c)){var a=gb.controller.widgetCurrentStatus[c];this.metadataResponse[c]&&(this.registerFullMetadata(this.metadataResponse[c],c),this.metadataResponse[c]=null);for(var d=0;d<gb.resources.categories.length;d++){var e=gb.resources.categories[d].nodeId;this.sortedDealIDs[c][a]&&this.sortedDealIDs[c][a][e]&&b.push(e)}}return b},getDealIDPosition:function(c,b){if(c){var a=this.dealIDLocations[c];if(gb.controller.isPaginatedMetadataCall(b))return a[b];else{var d=gb.controller.widgetCurrentStatus[b],e=gb.controller.widgetCurrentCategory[b];if(a&&a[b]&&a[b][d]&&a[b][d][e]!==null&&a[b][d][e]!==m)return a[b][d][e]}}return-1},_insertBlankDealIDs:function(c,b){var a,d=gb.controller.widgetCurrentPage[c],e=gb.controller.schedulingParams[c].pageSize;gb.widgets[c]&&gb.widgets[c].widgetGroupID&&this.selectedDealsCount[c]>b.length&&(a=gb.utils.getExtendedArray(this.selectedDealsCount[c],b,e*(d-1)));return a||b},updateMetadata:function(c,b,a,d){var e=gb.widgets[c],g=gb.controller.schedulingParams[c],h=d.metaParams;if(h&&h.callDataArray)gb.widgetHelper.callBins[c][h.callID]=b.sortedDealIDs||[],g.enableDeDuping&&(gb.widgetHelper.callBins[c][h.callID]=this.deDupeDeals(gb.widgetHelper.callBins[c][h.callID],c)),this.sortedDealIDs[c]=gb.widgetHelper.buildSortedDealsArray(c,e.dealsPerRow),gb.widgetHelper.callID[c]++,gb.widgetHelper.fetchCallDataArrayDeals(c);else{if(g.enableDeDuping)b.sortedDealIDs=this.deDupeDeals(b.sortedDealIDs,c);h&&h.isPageChange?(this.sortedDealIDs[c]=gb.utils.getExtendedArray(b.selectedDealsCount,b.sortedDealIDs,(b.page-1)*(d.dealsPerPage?d.dealsPerPage:g.pageSize),this.sortedDealIDs[c]),b.binning=this.getBinningInfo(c)):this.sortedDealIDs[c]=gb.utils.getExtendedArray(b.selectedDealsCount,b.sortedDealIDs)}this.selectedDealsCount[c]=this.sortedDealIDs[c].length;this.binningInfo[c]=b.binning;this.registerDealIDLocations(c);(d=e.widgetGroupID)&&gb.filterController.models[d].populateAvailableFilters(b.binning);typeof a==="function"&&a(c)},getDOTDCount:function(c){return f.intersection(f.union(this.dealsByType[gb.enums.DealTypes.DOTD]||[],this.dealsByAccessType[gb.enums.DealAccessTypes.PRIME_ONLY_DOTD]||[]),c).length},getBinningInfo:function(c){return this.binningInfo[c]},isCurrentWindowFull:function(c,b,a){if(!this.sortedDealIDs[c])return!1;b=(b-1)*a;c=this.sortedDealIDs[c].slice(b,b+a);for(a=0;a<c.length;)if(!c[a++])return!1;return!0},_rearrangeDealIds:function(c,b,a){var a=f.intersection(b,a),d=gb.widgets[c].dealsPerRow,e=0;a.length>0&&f.each(a,function(c){e+=1;c=f.indexOf(b,c);if((c+e)%d===0&&c<b.length){var h=1;if(!(c+h>=b.length)){for(;f.contains(a,b[c+h]);)if(h++,c+h>=b.length)break;c+h<b.length&&(h=b.splice(c+h,1),b.splice(c,0,h))}}});return b},registerFullMetadata:function(c,b){var a=gb.enums.StatusFilters;this.sortedDealIDs[b][a.AVAILABLE]={};this.sortedDealIDs[b][a.UPCOMING]={};this.sortedDealIDs[b][a.MISSED]={};var d=c.dealsByState.AVAILABLE||[],e=c.dealsByState.UPCOMING||[],g=c.dealsByState.EXPIRED||[],d=d.concat(e);this._isWidgetScheduledWithDOTD(b)&&!gb.utils.isWidgetWithStatusFilter(gb.widgets[b].widgetName)?d=d.concat(c.dealsByState.SOLDOUT):g=g.concat(c.dealsByState.SOLDOUT);this.sortedDealIDs[b][a.MISSED][gb.enums.CategoryFilters.ALL]=f.intersection(c.sortedDealIDs,g);this.sortedDealIDs[b][a.UPCOMING][gb.enums.CategoryFilters.ALL]=f.intersection(c.sortedDealIDs,e);this.sortedDealIDs[b][a.AVAILABLE][gb.enums.CategoryFilters.ALL]=f.intersection(c.sortedDealIDs,d);this.registerCategories(c,b);this.registerDealIDLocations(b)},registerCategories:function(c,b){for(var a=gb.enums.StatusFilters,d=gb.enums.CategoryFilters,e=this.sortedDealIDs[b][a.AVAILABLE][d.ALL],g=this.sortedDealIDs[b][a.UPCOMING][d.ALL],d=this.sortedDealIDs[b][a.MISSED][d.ALL],h=1;h<gb.resources.categories.length;h++){var l=gb.resources.categories[h].nodeId;c.dealsByCategory[l]&&(this.sortedDealIDs[b][a.AVAILABLE][l]=f.intersection(e,c.dealsByCategory[l]),this.sortedDealIDs[b][a.UPCOMING][l]=f.intersection(g,c.dealsByCategory[l]),this.sortedDealIDs[b][a.MISSED][l]=f.intersection(d,c.dealsByCategory[l]))}h=gb.enums.DealAccessTypes.PRIME_EARLY_ACCESS;if((l=c.dealsByAccessType[h])&&gb.resources.getFeature("prime_early_access"))this.sortedDealIDs[b][a.AVAILABLE][h]=f.intersection(e,l),this.sortedDealIDs[b][a.UPCOMING][h]=f.intersection(g,l),this.sortedDealIDs[b][a.MISSED][h]=f.intersection(d,l)},registerDealIDLocation:function(c,b,a,d,e){this.dealIDLocations[c]||(this.dealIDLocations[c]={});this.dealIDLocations[c][b]||(this.dealIDLocations[c][b]={});this.dealIDLocations[c][b][a]||(this.dealIDLocations[c][b][a]={});this.dealIDLocations[c][b][a][d]=e},_isWidgetScheduledWithDOTD:function(c){var b=!1;f.contains(gb.controller.schedulingParams[c].dealTypes,gb.enums.DealTypes.DOTD)&&(b=!0);return b},deDupeDeals:function(c,b){var a=this;f.each(gb.widgets,function(d){if(d.widgetID!==b||gb.controller.schedulingParams[b].enforceLimitedDeals)c=f.difference(c,a.sortedDealIDs[d.widgetID])});return c}})});gb.execute(function(i,f){k.GBDealContentService=i.Model.extend({clientID:null,baseRetryInterval:6E4,continueRetries:!0,customerID:null,callTimeoutValue:3E5,statusPollTimeoutValue:2E3,statusPollCache:[],getDealsTimeoutValue:500,getDealsCache:[],dealsWithDetails:{},maxDealIDsLength:12,getDealsMaxJitter:null,apiNames:{GDM:"GetDealMetadata",GDS:"GetDealStatus",GD:"GetDeals",RD:"RedeemDeal",CD:"ClaimDeal"},initialize:function(){this.marketplaceID=gb.resources.getCustomerData("marketplaceId");this.sessionID=gb.resources.getCustomerData("sessionId");this.customerID=gb.resources.getCustomerData("customerId");this.getDealsMaxJitter=gb.enums.Constants.GET_DEALS_MAX_JITTER},setClientID:function(c){this.clientID=this.clientID||gb.enums.ClientIDPrefix+"_"+c},_ajaxWithRetries:function(c,b){var a=this,d=new Date,e=0,g=a.baseRetryInterval,h=c.error;delete c.error;var f=function(){if(a.continueRetries){c.url=gb.utils.setUrlParam(c.url,"nocache",(new Date).getTime());var p=c.success;c.success=function(g){if(g&&gb.utils.parseBool(g.retry))c.error();else{var h=e>0;b.latency=(new Date).getTime()-d.getTime();a._recordAPIMetrics(h,!0,b);p(g)}};c.error=function(i){var p=e>0;b.latency=(new Date).getTime()-d.getTime();a._recordAPIMetrics(p,!1,b);c.url=gb.utils.setUrlParam(c.url,"retrying",1);var o=g*(1+Math.pow(2,e++)*Math.random());o+(new Date).getTime()-d.getTime()>a.callTimeoutValue?(o="Request failing for "+b.apiName+".",p&&(o=o+" Retry number: "+e),h(Error(o+JSON.stringify(i)))):k.setTimeout(f,o)};i.$.ajax(c)}else h(Error("continueRetries is false: No more requests should be made."))};f()},_call:function(c,b,a,d,e){var g=this,c={success:function(d){if(d.responseMetadata)g.baseRetryInterval=d.responseMetadata.baseRetryInterval,this.continueRetries=d.responseMetadata.continueRetries;a(d)},error:d,url:c,type:"POST",data:JSON.stringify(b),dataType:"json"};g._ajaxWithRetries(c,e)},callAPI:function(c,b,a,d){for(var e=[],g=0;g<b.length;g++)e.length===this.maxDealIDsLength&&(this[c](e,a,d),e=[]),e.push(b[g]);if(e.length)this[c](e,a,d)},getGetDealStatusRequestParam:function(c){c=c.sort();c={requestMetadata:{marketplaceID:this.marketplaceID,clientID:this.clientID},dealTargets:f.map(c,function(b){return{dealID:b}}),responseSize:"STATUS_ONLY",itemResponseSize:"DEFAULT_WITH_PREEMPTIVE_LEAKING"};if(this.customerID)c.requestMetadata.customerID=this.customerID;if(this.sessionID)c.requestMetadata.sessionID=this.sessionID;return c},GetDealStatusCall:function(c){if(c.length){var b=gb.enums.Constants.AJAX_ENDPOINT+this.apiNames.GDS,a=this.getGetDealStatusRequestParam(c);this._call(b,a,function(a){var b=(new Date).getTime();f.each(c,function(c){var h=gb.controller.getDealDAO(c),c=a.dealStatus[c];c.responseTimestamp=b;gb.translator.trigger("PopulateStatus",h,c)})},function(a){throw a;},{apiName:this.apiNames.GDS})}},getGetDealsRequestParam:function(c,b){var a=!1,d=null;b&&(a=b.excludeCustomerID?b.excludeCustomerID:!1,d=b.widgetID?gb.controller.schedulingParams[b.widgetID].eventID:null);var c=c.sort(),e={requestMetadata:{marketplaceID:this.marketplaceID,clientID:this.clientID},dealTargets:f.map(c,function(a){return{dealID:a}}),responseSize:"ALL",itemResponseSize:"DEFAULT_WITH_PREEMPTIVE_LEAKING"};if(!a&&this.customerID)e.requestMetadata.customerID=this.customerID;if(this.sessionID)e.requestMetadata.sessionID=this.sessionID;if(d)e.extendedAttributes=["hideAddToCart"];return e},GetDealsCall:function(c,b,a){if(c.length){var d=gb.enums.Constants.AJAX_ENDPOINT+this.apiNames.GD,b=this.getGetDealsRequestParam(c,b);this._call(d,b,function(d){var b=(new Date).getTime();f.each(c,function(a){var c=gb.controller.getDealDAO(a);d.dealStatus[a].responseTimestamp=b;gb.translator.trigger("PopulateDealDAO",c,d.dealDetails[a],d.dealStatus[a])});typeof a==="function"&&a(c)},function(a){throw a;},{apiName:this.apiNames.GD})}},getDealDetails:function(c){var b=this;f.contains(b.getDealsCache,c)||(b.getDealsCache.push(c),b.getDealsCache.length===1&&(c=Math.floor(Math.random()*b.getDealsMaxJitter*1E3),c+=b.getDealsTimeoutValue,k.setTimeout(function(){var a=[];f.each(b.getDealsCache,function(d){b.dealsWithDetails[d]||a.push(d)});b.getDealsCache=[];b.callAPI("GetDealsCall",a,{})},c)))},pollDealStatus:function(c){var b=this,a=gb.controller.getDealDAO(c);a.dealType===gb.enums.DealTypes.EVENT||f.contains(b.statusPollCache,c)||(b.statusPollCache.push(c),b.statusPollCache.length===1&&k.setTimeout(function(){var d=new Date,c=[];f.each(b.statusPollCache,function(b){var h=a.status.dates.cacheExpires;d.getTime()-h.getTime()>=0&&c.push(b)});b.statusPollCache=[];b.callAPI("GetDealStatusCall",c)},b.statusPollTimeoutValue))},fetchDeals:function(c,b,a){var d=this,e=new Date,g=[],h=[];f.each(c,function(a){a&&(d.dealsWithDetails[a]?gb.controller.getDealDAO(a).status.dates.cacheExpires.getTime()<=e.getTime()&&h.push(a):g.push(a))});typeof a==="function"&&a(f.difference(c,g));d.callAPI("GetDealsCall",g,{widgetID:b},a);d.callAPI("GetDealStatusCall",h)},redeemDeal:function(c,b,a,d){d=gb.utils.setUrlParam("/gp/deal/ajax/redeemDeal.html/ref="+d,"marketplaceID",this.marketplaceID);d=gb.utils.setUrlParam(d,"dealID",c.legacyDealID);d=gb.utils.setUrlParam(d,"asin",c.asin);d=gb.utils.setUrlParam(d,"sessionID",this.sessionID);this._call(d,{},b,a,{apiName:this.apiNames.RD})},claimDeal:function(c,b,a,d){d=gb.utils.setUrlParam("/gp/deal/ajax/claimDeal.html/ref="+d,"dealId",c.dealID);d=gb.utils.setUrlParam(d,"itemId",c.asin);this._call(d,{},b,a,{apiName:this.apiNames.CD})},watchDeal:function(c,b,a,d){c={watchAction:b,dealId:c};if(gb.clientName!==gb.enums.MobileClients.PC&&gb.resources.customerData.isWatchedDealFirstRun)c.isWatchedDealFirstRun=!0;i.$.ajax({success:function(d,b,c){gb.resources.customerData.csrfToken=c.getResponseHeader("X-CSRFToken");a(d)},beforeSend:function(a){a.setRequestHeader("X-CSRFToken",gb.resources.customerData.csrfToken)},url:gb.enums.AJAXLinks.WATCH_DEAL+d,type:"POST",data:c,dataType:"json",error:function(){a({status:0})}})},getWatchedDeals:function(c,b){i.$.ajax({success:function(a){c({data:a})},url:gb.enums.AJAXLinks.GET_WATCHED+b,type:"POST",error:function(){c({error:!0})}})},fetchDealWithData:function(c,b,a){var d=this;d.GetDealMetadataCall(c,b,function(e){var g=[],h=f.clone(e.sortedDealIDs);b.getDealsSize&&(h=h.slice(0,b.getDealsSize));d.fetchDeals(h,c,function(d){g=f.union(g,d);g.length===h.length&&gb.metadata.trigger("ConsumeMetadataChange",c,e,a,b)})})},GetDealMetadataCall:function(c,b,a){var d=gb.enums.Constants.AJAX_ENDPOINT+this.apiNames.GDM,c=this.getGetDealMetadataRequestParam(c,b),b={apiName:this.apiNames.GDM};if(c.version===gb.enums.Constants.PAGINATED_METADATA_VERSION)b.version=c.version;this._call(d,c,function(d){a(d)},function(a){throw a;},b)},getGetDealMetadataRequestParam:function(c,b){var a={requestMetadata:{clientID:this.clientID,marketplaceID:this.marketplaceID,sessionID:this.sessionID},queryProfile:{},sortOrder:gb.enums.SortOrders.BY_SCORE,version:gb.enums.Constants.PAGINATED_METADATA_VERSION,page:1,dealsPerPage:0};if(this.customerID)a.requestMetadata.customerID=this.customerID;var d=gb.controller.schedulingParams[c],e={enforcedCategories:"includedCategories",enforcedDealIDs:"includedDealIDs",enforcedMerchantIDs:"merchantIDs",expiredDealsDisplayDuration:"expiredDealLookBackHours",exclusiveTargetArray:"exclusiveTargetValues",inclusiveTargetArray:"inclusiveTargetValues"};f.each("brands,dealGroups,dealStates,dealTypes,enforcedCategories,excludedCategories,enforcedDealIDs,enforcedMerchantIDs,excludedDealIDs,excludedExtendedFilters,excludedItemIDs,exclusiveTargetArray,expiredDealsDisplayDuration,extendedFilters,includedCategories,includedDealIDs,inclusiveTargetTypes,inclusiveTargetArray,itemIDs,merchantIDs,includedBins,eventID,featuredOnly,freeShippingEligibleOnly,globalEligibleOnly,maxPercentOff,maxPrice,minDuration,minPercentOff,minPrice,minRating,primeAccessType,primeEligibleOnly,fromTime,toTime,discountRanges,priceRanges,featuredDealsElevationSize".split(","),function(c){if(!(c==="includedBins"&&(d.eventID||b.metaParams&&b.metaParams.isPageChange))){var g=d[c];e[c]&&(c=e[c]);f.isObject(g)?f.isEmpty(g)||(g=gb.utils.removeNulls(g))&&(a.queryProfile[c]=g):g&&(a.queryProfile[c]=g)}});if(d.dealDisplay&&d.dealStatesDD)a.queryProfile.dealStates=d.dealStatesDD;if(d.expiringWithin&&d.expiringWithin>0)a.queryProfile.expiringWithin=d.expiringWithin;a.sortOrder=this._getRequestSortOrder(d.sortOrder,d.rankingStrategy);a.page=b.page?b.page:d.page;a.dealsPerPage=d.pageSize;if(b.dealsPerPage){for(var g=Math.ceil(((a.page-1)*d.pageSize+1)/b.dealsPerPage);gb.metadata.isCurrentWindowFull(c,g,b.dealsPerPage);)g++;a.page=g;a.dealsPerPage=b.dealsPerPage}var h=gb.controller.contentMetadata,g={};if(!f.isEmpty(h)){if(h.pageType)g.pageType=h.pageType;if(h.subPageType)g.subPageType=h.subPageType;if(h.deviceType)g.deviceType=h.deviceType;if(h.originRef)g.refTag=h.originRef;if(h.originRID)g.refRID=h.originRID;if(h.browseNode)g.pageTypeID=h.browseNode}h=gb.metrics.widgetMetricsParams[c];if(!f.isEmpty(h)){if(h.placementID)g.widgetID=h.placementID;if(h.slotName)g.slotName=h.slotName}if(!f.isEmpty(g))a.widgetContext=g;return a=gb.utils.sortRequestObj("",a)},_getRequestSortOrder:function(c,b){return f.contains(f.values(gb.enums.RankingStrategies),b)&&c===gb.enums.SortOrders.BY_SCORE?b:c},_generateAPIMetricName:function(c,b,a){var d="goldbox:";a.apiName&&(d+=a.apiName,a.version&&(d=d+":"+a.version),d=d+":"+(b?"success":"error")+":"+(c?"retry":"noretry"));d=d+":"+this.clientID;return d.toLowerCase()},_recordAPIMetrics:function(c,b,a){if(c=this._generateAPIMetricName(c,b,a))ue.count(c,(ue.count(c)||0)+1),a.latency&&ue.count(c+":time",a.latency)}})});gb.execute(function(i){k.GBMobileNotificationSubscriptionService=i.Model.extend({baseRetryInterval:2E4,continueRequests:!0,customerId:"",sessionId:null,timeout:3E5,initialize:function(){this.sessionId=gb.resources.getCustomerData("sessionId");this.customerId=gb.resources.getCustomerData("customerId")},ajaxWithRetries:function(f){var c=this,b=new Date,a=0,d=f.retryInterval||this.baseRetryInterval||6E4;delete f.retryInterval;var e=f.error;delete f.error;var g=function(){c.continueRequests?(f.url=f.url.indexOf("?")===-1?f.url+"?nocache="+(new Date).getTime():f.url+"&nocache="+(new Date).getTime(),f.error=function(){var h=d*(1+Math.pow(2,a++)*Math.random());h+(new Date).getTime()-b.getTime()>c.timeout?e(Error("timed out")):k.setTimeout(g,h)},k.P&&k.P.AUI_BUILD_DATE?n.when("jQuery").execute(function(a){a.ajax(f)}):jQuery.ajax(f)):e(Error("continueRequests is false: no more requests should be made."))};g()},call:function(f,c,b,a,d){f={success:b,error:a,url:f,type:"POST",data:JSON.stringify(c),dataType:"json"};if(d!==m)f.retryInterval=d;this.ajaxWithRetries(f)},registerForNotifications:function(f,c,b){this.call("/gp/deal/ajax/registerForNotifications.html/ref=gb_mshop?customer="+this.customerId+"&sessionId="+this.sessionId+"&token="+f.pushToken+"&application="+f.appID+"&protocol="+f.protocol,{},c,b,this.baseRetryInterval)}})});gb.execute(function(i){k.GBWatchDealService=i.Model.extend({modifyPopupStatus:function(f,c){i.A.post(gb.enums.AJAXLinks.UPDATE_EMBU,{success:c,error:function(){throw Error("get/set status of watchdeal popup failed");},params:{action:f.action,key:f.key},dataType:"json"})},addWatchedDealOnLoginRedirect:function(f){if(gb.clientName===gb.enums.MobileClients.APP)gb.resources.deviceInfo.isPhone?(f=encodeURIComponent(k.location.href.replace(/^http:/,"https:")),k.location.href=gb.utils.setUrlParam(gb.resources.urls.app_login_url,"openid.return_to",f)):(f=gb.utils.getWindowLocationOrigin(),k.location.href=gb.utils.setUrlParam(f,"app-action","login"));else if(gb.clientName===gb.enums.MobileClients.AW)k.location.href=m;else{var c=gb.resources.getUrl("watching_login_redirect"),c=c.replace(/%257BmarketplaceID%257D/,gb.resources.customerData.marketplaceId);k.location.href=c.replace(/%257BdealID%257D/,f)}}})});gb.execute(function(i,f){k.GBNotifications=i.Model.extend({pushNotificationInfo:{},initialize:function(){this.mnssService=new GBMobileNotificationSubscriptionService;this.getPushNotificationInfo()},subscribeNotifications:function(){this.getAppNotificationStatus()&&this.mnssService.registerForNotifications(this.pushNotificationInfo,function(){},function(){})},getPushNotificationInfo:function(c){var b=this;n.when("mash").execute(function(){k.amazon.mash.privateAPI&&k.amazon.mash.privateAPI.getPushNotificationInfo({successCallback:function(a){b.pushNotificationInfo=a;typeof c==="function"&&c()},failCallback:function(){ue.count("goldboxDetailDeviceTokenUnavailable",(ue.count("goldboxDetailDeviceTokenUnavailable")||0)+1)}})})},invokePushNotificationInterstitial:function(c){var b=this;n.when("mash").execute(function(){cordova.require("cordova/exec")(function(){gb.controller.getPushNotificationInfo(function(){b.subscribeNotifications();c()})},function(){c()},"PushNotificationsIOS","invokePushNotificationInterstitial",[gb.resources.getString("gb-interstitial-title"),gb.resources.getString("gb-interstitial-subtitle"),"http://g-ec2.images-amazon.com/images/G/01/golbox/mshop/INTERSTITIAL_1X._V293550351_.png",["DEALS:waitlist"]])})},getAppNotificationStatus:function(){return typeof this.pushNotificationInfo==="object"&&!f.isEmpty(this.pushNotificationInfo)}})});gb.execute(function(i,f){k.GBWatcher=i.Model.extend({viewPort:{},dealsInView:{},lowestDealIDWatchedIndex:{},changePage:function(c){var b=this;b.viewPort[c]=b.viewPort[c]||[];b.lowestDealIDWatchedIndex[c]=b.lowestDealIDWatchedIndex[c]||0;var a=f.compact(gb.metadata.getSortedDealIDs(c)),d=f.difference(b.viewPort[c],a),e=f.difference(a,b.viewPort[c]);b.viewPort[c]=a;a=f.last(a);a=gb.metadata.getDealIDPosition(a,c);a>b.lowestDealIDWatchedIndex[c]&&(b.lowestDealIDWatchedIndex[c]=a);f.each(d,function(a){b.dealsInView[a]&&(b.dealsInView[a][c]=null,delete b.dealsInView[a][c],f.isEmpty(b.dealsInView[a])&&(b.dealsInView[a]=null,delete b.dealsInView[a]))});f.each(e,function(a){b.dealsInView[a]=b.dealsInView[a]||{};var d=gb.metadata.getDealIDPosition(a,c);d!==-1&&(b.dealsInView[a][c]=d)});b.unwireStatusRefresh(d);b.wireStatusRefresh(e)},wireStatusRefresh:function(c){var b=new Date;f.each(c,function(a){var d=gb.controller.getDealDAO(a);if((a=d.status.dates.cacheExpires)&&d.dealType!==gb.enums.DealTypes.EVENT)a=a.getTime()-b.getTime(),d.status.timeouts.cacheExpires=gb.utils.setSafeTimeout(function(){gb.service.pollDealStatus(d.dealID)},a)})},unwireStatusRefresh:function(c){f.each(c,function(b){b=gb.controller.getDealDAO(b);if(b.status.timeouts.cacheExpires)k.clearTimeout(b.status.timeouts.cacheExpires),b.status.timeouts.cacheExpires=null})}})});gb.execute(function(i,f){k.GBGarbageCollector=i.Model.extend({clearDealViews:function(c,b){if(c&&!f.isEmpty(gb.widgets)&&!f.isEmpty(gb.widgets[c])&&!f.isEmpty(gb.widgets[c].dealViews)){if(b===m)b=f.keys(gb.widgets[c].dealViews),gb.widgets[c].nextPositionToRender=0;f.each(b,function(a){gb.widgets[c].dealViews[a]&&(f.each(gb.widgets[c].dealViews[a],function(d,b){if(d.clock)k.clearTimeout(d.clock.timeout),d.clock=null;gb.widgets[c].dealViews[a][b]=null;delete gb.widgets[c].dealViews[a][b]}),delete gb.widgets[c].dealViews[a])})}},deepCleanDealViews:function(c,b){if(c&&!f.isEmpty(gb.widgets)&&!f.isEmpty(gb.widgets[c])&&!f.isEmpty(gb.widgets[c].dealViews)&&b&&!f.isEmpty(b)){var a=[],d=gb.widgets[c];f.each(b,function(b){d.dealViews[b]&&(a.push(b),f.each(d.dealViews[b],function(a){gb.utils.removeImage(a.viewElement)}))});this.clearDealViews(c,a)}},clearViewPort:function(c){if(c&&!f.isEmpty(gb.widgets)&&!(f.isEmpty(gb.widgets[c])||gb.widgets[c].viewPortManager===null))gb.subnavController&&gb.widgets[c].viewPortManager.clearHeaderInSubnav(),gb.widgets[c].viewPortManager.detachScroll(),gb.widgets[c].viewPortManager=null}})});gb.execute(function(i,f){k.GBController=i.Collection.extend({nextWidgetID:100,schedulingParams:{},dealDAOs:{},totalDealsToShow:{},widgetCurrentPage:{},widgetCurrentCategory:{},widgetCurrentStatus:{},widgetFilters:{},widgetName:{},pageOrientation:null,clientName:null,useHtmlRefineButton:!1,buyingDeals:{},bottomSheet:null,originRID:null,popOverVisible:!1,watchDealView:null,contentMetadata:{pageType:null,subPageType:null,originRef:null,originRID:null,deviceType:null},initialize:function(c){gb.widgets={};var b=c.resources;this.contentMetadata.pageType=c.contentMetadata.pageType;this.contentMetadata.subPageType=c.contentMetadata.subPageType;this.contentMetadata.originRef=c.contentMetadata.refTag;this.contentMetadata.originRID=c.contentMetadata.originRID;this.contentMetadata.deviceType=c.contentMetadata.deviceType;this.instantiateFramework(b);this._handleActions();this.registerConnections();n.when("A","jQuery").execute(function(a,d){d(k).unload(function(){var a=!1,a=f.any(gb.widgets,function(a){return a.isEventsWidget()});k.history&&typeof history.pushState==="function"&&!a&&(a=gb.utils.setUrlParam(k.location.href,"nocache",(new Date).getTime()),gb.utils.updateAddressBarUrl(a));gb.metricsManager.reportImpression()})});i.$(k).bind("popstate",function(a){gb.globalFlags.ignoreBottomSheet?f.isEmpty(a.originalEvent.state)||location.reload():(a=gb.controller.bottomSheet)&&i.$("."+a.elClasses.container).length&&a.close();gb.globalFlags.ignoreBottomSheet=!1})},instantiateFramework:function(c){gb.globalFlags={};gb.enums=k.GBEnums.getInstance();gb.baseUtils=new GBBaseUtilities(c);gb.resources=new GBResourceManager(c);gb.utils=k.GBUtilities.getInstance();gb.metrics=gb.metrics||new GBMetrics;gb.configManager=new GBConfigManager;gb.templateManager=new GBTemplateManager;gb.metadata=new GBMetadata;gb.service=new GBDealContentService;gb.translator=new GBDCSTranslator;gb.viewComponentBuilder=new GBViewComponentBuilder;gb.watcher=new GBWatcher;gb.garbageCollector=new GBGarbageCollector;gb.metricsManager=new GBMetricsManager;gb.widgetViewFactory=new GBWidgetViewFactory;gb.notifications=new GBNotifications;gb.filterController=new GBFilterController;n.register("GBEventManager",function(){return f.extend({},i.Events)})},registerConnections:function(){this.on("WidgetPageUpdate",this.updatePage);this.on("WidgetPageScroll",this.scrollPage);this.on("WidgetCategoryChange",this.changeCategory);this.on("WidgetStatusChange",this.changeStatus)},registerWidget:function(c){f.isEmpty(gb.metadata.watchedDeals)&&c.watchedDeals&&gb.metadata.registerWatchedDeals(c.watchedDeals);if(c.schedulingParams.watchedDealsWidget)c.dcsServerResponse=gb.utils.getWatchedDealWidgetData(c.schedulingParams.dealStates);var b=c.dcsServerResponse||{};b.sortedDealIDs=b.sortedDealIDs||[];b.dealsByCategory=b.dealsByCategory||{};b.dealsByAccessType=b.dealsByAccessType||{};b.dealsByState=b.dealsByState||{};b.binning=b.binning||{};c.dcsServerResponse=b;var a=(this.nextWidgetID++).toString();gb.service.setClientID(gb.clientName||"");if(c.schedulingParams.maxJitter){var d=parseInt(c.schedulingParams.maxJitter,10);if(d&&d>gb.enums.Constants.GET_DEALS_MAX_JITTER&&d>gb.service.getDealsMaxJitter)gb.service.getDealsMaxJitter=d}gb.configManager.registerConfigs(c);gb.templateManager.registerTemplates(c.widgetName,c.templates);this.totalDealsToShow[a]=b.selectedDealsCount;this.widgetName[a]=c.widgetName;this.registerSchedulingParams(a,c.schedulingParams,c.widgetViewConfig.dcsMetadataVersion);d=this.schedulingParams[a];c.schedulingParams=d;c.widgetID=a;d.fetchWatchedDeals&&(gb.controller.getWatchDealService(),gb.clientName===gb.enums.MobileClients.PC&&gb.controller.getWatchDealView());this.widgetFilters[a]=d.filterConfig||[];var e=gb.filterController.getWidgetGroupID(c);gb.widgets[a]=gb.widgetViewFactory.getWidgetView({widgetID:a,widgetGroupID:e,widgetName:c.widgetName,domElementID:c.domElementID,schedulingParams:d});if(e&&gb.controller.isPaginatedMetadataCall(a)&&f.isEmpty(d.includedBins))d.includedBins=gb.utils.getIncludedBins(d.filterConfig);gb.filterController.registerFilters(c,a,e);gb.metrics.registerWidgetMetricParams(a,c.domElementID);gb.translator.trigger("PopulateMetadata",a,b);gb.metadata.parseSortedDealIDs(a,b);if(gb.configManager.getWidgetViewConfig(a).callDataBuilder)gb.widgetHelper=gb.widgetHelper||new GBWidgetClientSideHelper,gb.widgetHelper.registerWidgetData(a,b);this.setInitialFilters(a);gb.metadata.registerMetadata(a,b);gb.widgetHelper&&gb.widgetHelper.callDataArray[a]&&gb.widgetHelper.fetchCallDataArrayDeals(a)},registerSchedulingParams:function(c,b,a){var d={adSlots:[],allowWidgetRefresh:!1,brands:[],customRestrictionsApply:null,dealDisplay:{},dealGroups:{},dealStates:[],dealTypes:[],disableRestrictionsApply:!1,disableSortFilter:!1,disableStatusFilter:!1,disableWidgetHeader:!1,discountRanges:[],displayFeaturedDeals:!1,enablePagination:!1,enableCategoryRefine:!0,enableDeDuping:!1,enableHidingWidgetHeader:!1,enableShareDeal:!1,enforcedCategories:[],enforcedDealIDs:[],enforcedMerchantIDs:[],enforceLimitedDeals:!1,eventID:null,excludedCategories:[],excludedDealIDs:[],excludedExtendedFilters:{},exclusiveTargetKeys:[],exclusiveTargetValues:[],exclusiveTargetArray:[],expiringWithin:0,expiredDealsDisplayDuration:0,extendedFilters:{},filterConfig:[],featureScope:null,featuredDealsElevationSize:null,fetchSinglePage:!1,fetchWatchedDeals:!1,fromTime:null,freeShippingEligibleOnly:!1,globalEligibleOnly:!1,includedBins:[],inclusiveTargetKeys:[],inclusiveTargetValues:[],inclusiveTargetArray:[],isCritical:!1,maxJitter:2,minRating:null,noDealsFilterMessage:null,noDealsMessage:null,page:1,pageSize:4,priceRanges:[],primeAccessType:null,primeEligibleOnly:!1,prioritizedDealIDs:[],rankingStrategy:null,redirectBackLink:null,redirectBackTitle:null,redirectLink:null,redirectPageTitle:null,redirectText:null,rowsOfDeals:1,seeAllText:null,shovelerEndText:null,shovelerStateConfig:[],shovelerStateTab:0,showDoubleCellDOTD:!0,showLaunchCell:!0,showHelpLink:!1,showShortCellView:!1,sortOrder:gb.enums.SortOrders.BY_SCORE,sortOptionsOverride:[],subnavPage:null,subnavPageSlot:null,subTitle:null,title:null,titleWithS:null,toTime:null,watchedDealsWidget:!1,widgetAnchorName:null,widgetGroupID:null};if(b.clientName===gb.enums.MobileClients.APP)gb.clientName=gb.enums.MobileClients.APP;f.each(d,function(a,c){b[c]!==null&&b[c]!==m&&(d[c]=b[c])});if(!isNaN(parseInt(d.pageSize,10)))d.pageSize=parseInt(d.pageSize,10);if(!isNaN(parseInt(d.featuredDealsElevationSize,10)))d.featuredDealsElevationSize=parseInt(d.featuredDealsElevationSize,10);if(!isNaN(parseInt(d.expiredDealsDisplayDuration,10)))d.expiredDealsDisplayDuration=parseInt(d.expiredDealsDisplayDuration,10);if(!isNaN(parseInt(d.subnavPage,10)))d.subnavPage=parseInt(d.subnavPage,10);if(!isNaN(parseInt(d.subnavPageSlot,10)))d.subnavPageSlot=parseInt(d.subnavPageSlot,10);f.isEmpty(d.adSlots)||d.adSlots.sort(function(a,d){return a.rowNumber<d.rowNumber?-1:a.rowNumber>d.rowNumber?1:0});var e=k.amazon&&k.amazon.mash?!0:!1;if(d.sortOptionsOverride.length&&!f.contains(d.sortOptionsOverride,d.sortOrder))d.sortOrder=d.sortOptionsOverride[0];if(d.enforceLimitedDeals){if(d.redirectLink===null)d.redirectLink=(new GBLinkGenerator(gb.clientName)).generateRedirectLink(d,a);if(this.widgetName[c]===gb.enums.WidgetNames.TAB_HERO&&d.redirectText===null)d.redirectText=d.dealTypes.length===1&&d.dealTypes[0]===gb.enums.DealTypes.LD?gb.resources.getString("gb_tabhero_ld_redirect_text"):gb.resources.getString("gb_tabhero_bd_redirect_text");if(d.redirectLink&&d.redirectPageTitle===null)d.redirectPageTitle=d.title;if(gb.clientName===gb.enums.MobileClients.APP&&d.redirectLink&&d.redirectPageTitle&&e)d.redirectLink=gb.utils.setUrlParam(d.redirectLink,"app-title",encodeURIComponent(d.redirectPageTitle));d.redirectBackLink=null}else if(gb.controller.widgetName[c]===gb.enums.WidgetNames.HERO){d.redirectLink=null;d.redirectText=null;d.redirectPageTitle=null;if(d.redirectBackLink===null)d.redirectBackLink=gb.enums.RedirectionLinks[gb.clientName].GATEWAY_PAGE;if(gb.clientName===gb.enums.MobileClients.APP&&d.redirectBackLink&&d.redirectBackTitle===null)d.redirectBackTitle=gb.resources.getString("gb_page_title");if(gb.clientName===gb.enums.MobileClients.APP&&d.redirectBackLink&&d.redirectBackTitle&&e)d.redirectBackLink=gb.utils.setUrlParam(d.redirectBackLink,"app-title",encodeURIComponent(d.redirectBackTitle))}this.schedulingParams[c]=d},updatePage:function(c,b){gb.watcher.lowestDealIDWatchedIndex[c]&&delete gb.watcher.lowestDealIDWatchedIndex[c];gb.watcher.changePage(c);b&&(gb.garbageCollector.clearViewPort(c),gb.widgets[c].renderWireFrame());if(!f.isEmpty(gb.controller.schedulingParams[c].adSlots))gb.widgets[c].nextAdSlotToRenderIndex=0;gb.widgets[c].renderContent();gb.service.fetchDeals(gb.watcher.viewPort[c],c)},getDealDAO:function(c){this.dealDAOs[c]=this.dealDAOs[c]||new GBDealDAO(c);return this.dealDAOs[c]},scrollPage:function(c){var b=gb.widgets[c],a=this.widgetCurrentPage[c]+1;this.isPaginatedMetadataCall(c)&&!gb.metadata.isCurrentWindowFull(c,a,this.schedulingParams[c].pageSize)?this.fetchPage({page:a,dealsPerPage:gb.configManager.getWidgetViewConfig(c).preFetchGDMDeals,getDealsSize:gb.controller.schedulingParams[c].pageSize},c,!0):(gb.watcher.changePage(c),b.nextPositionToRender<gb.watcher.lowestDealIDWatchedIndex[c]+1&&b.renderContent(),gb.service.fetchDeals(gb.watcher.viewPort[c],c))},changeCategory:function(c,b){this.widgetCurrentPage[c]=1;this.widgetCurrentCategory[c]=b;gb.controller.trigger("WidgetPageUpdate",c,!0);this.updateAppliedFilters(c)},changeStatus:function(c,b){this.widgetCurrentPage[c]=1;this.widgetCurrentStatus[c]=b;this.widgetCurrentCategory[c]=gb.enums.CategoryFilters.ALL;gb.controller.trigger("WidgetPageUpdate",c,!0);this.updateAppliedFilters(c)},refreshDealView:function(c,b){gb.controller.buyingDeals[c]||f.each(gb.watcher.dealsInView[c],function(a,d){var e=gb.widgets[d].dealViews[c];e&&f.each(e,function(a){a.render()});gb.controller.refreshMiniDetailPageView(c,b)})},refreshMiniDetailPageView:function(c,b){gb.controller.buyingDeals[c]||f.each(gb.watcher.dealsInView[c],function(a,d){var e=gb.widgets[d].dealViews[c];n.when("A","a-modal").execute(function(a,d){f.each(e,function(a){var e=d.get(gb.enums.WidgetViewIDs.MINI_DP_MODAL+c);a&&e&&e.isActive()&&a.renderMiniDetailPage(b)})})})},fetchPage:function(c,b,a){c={page:c.page,dealsPerPage:c.dealsPerPage,getDealsSize:c.getDealsSize,metaParams:{isPageChange:!0}};a?gb.service.fetchDealWithData(b,c,function(a){gb.widgets[a].viewPortManager?gb.controller.trigger("WidgetPageUpdate",a):gb.controller.trigger("WidgetPageUpdate",a,!0)}):gb.service.fetchDealWithData(b,c)},getLoginURL:function(c,b){if(gb.clientName===gb.enums.MobileClients.APP)if(gb.resources.deviceInfo.isPhone){var a=encodeURIComponent(k.location.href.replace(/^http:/,"https:"));return gb.utils.setUrlParam(gb.resources.urls.app_login_url,"openid.return_to",a)}else return a=gb.utils.getWindowLocationOrigin(),gb.utils.setUrlParam(a,"app-action","login");else return gb.clientName===gb.enums.MobileClients.AW?m:(a=gb.resources.urls.login_url,a=a.replace(/%257BdealID%257D/,c),a=a.replace(/%257Basin%257D/,b),a=a.replace(/%257BmarketplaceID%257D/,gb.resources.customerData.marketplaceId))},_updateNavCartQty:function(c){k.navbar&&typeof k.navbar.setCartCount==="function"&&k.navbar.setCartCount(c);n.when("mash").execute(function(b){b.cart.didUpdate({newCartQuantity:parseInt(c,10)})})},_showErrorOnAjaxFail:function(c){var b=this.dealDAOs[c];delete this.buyingDeals[c];b.checkingDealStatus=!1;this.refreshDealView(c);n.when("mash").execute(function(a){a.showAlert({message:gb.resources.getString("gb_problem_adding_item_to_cart"),buttonTitles:[gb.resources.getString("gb_ok")],successCallback:i.$.noop})})},processActionableClick:function(c){var b=this,a=c.dealID,d=b.dealDAOs[a],e=d.legacyDealID,g=c.dealType,h=gb.utils.getWindowLocationOrigin(),l=c.asin,p=gb.metrics.generateRef(c.widgetID,c.action||gb.metrics.refTags.addToCart,[a]),v=gb.widgets[c.widgetID].widgetGroupID,r=gb.widgets[c.widgetID];typeof r.removeErrorMessage==="function"&&r.removeErrorMessage();if(!b.buyingDeals[a])if(g===gb.enums.DealTypes.LD&&!gb.service.customerID)gb.resources.getFeature("deal-redemption-service")&&(e=a),h=b.getLoginURL(e,l),k.location.href=h,d.checkingDealStatus=!1,b.refreshDealView(a);else if(b.buyingDeals[a]=!0,g===gb.enums.DealTypes.EVENT)l=gb.metrics.addMetricsParams(gb.enums.AJAXLinks.ADD_TO_CART,c.widgetID,gb.metrics.refTags.addToCart,[a,v]),i.A.post(l,{params:{offerID:c.offerID,quantity:c.quantity,asin:c.asin},success:function(c){delete b.buyingDeals[a];d.checkingDealStatus=!1;if(c.success)d.isAddedToCart=!0,d.addActionMessage=gb.resources.getString("gb_item_added_to_cart"),b._updateNavCartQty(c.itemsInCart);b.refreshDealView(a)},error:function(){delete b.buyingDeals[a];d.checkingDealStatus=!1;b.refreshDealView(a)}});else if(g===gb.enums.DealTypes.LD)gb.resources.getFeature("deal-redemption-service")?gb.service.claimDeal(c,function(e){delete b.buyingDeals[a];if(e){var g=gb.translator.translateClaimDealStatus(d,c.asin,e);d.inCartAsin=c.asin;gb.translator.trigger("PopulateStatus",d,g,b._registerDealWithNotifier);b.redemptionResponseHandler(d,c.asin,e.currentCartQuantity)}else d.checkingDealStatus=!1,b.refreshDealView(a)},function(){delete b.buyingDeals[a];d.checkingDealStatus=!1;b.refreshDealView(a)},p):gb.service.redeemDeal(c,function(e){delete b.buyingDeals[a];if(e&&e.redeemed){var g=gb.translator.translateRedeemDealStatus(e);d.inCartAsin=c.asin;gb.translator.trigger("PopulateStatus",d,g,b._registerDealWithNotifier);b.redemptionResponseHandler(d,c.asin,e.currentCartQuantity)}else d.checkingDealStatus=!1,b.refreshDealView(a)},function(){delete b.buyingDeals[a];d.checkingDealStatus=!1;b.refreshDealView(a)},p);else if(gb.resources.deviceInfo.doesAppHaveURLInterception){var l=gb.enums.AJAXLinks.ADD_TO_CART,o=gb.enums.MiscLinks.CART_URL;i.A.post(l,{params:{offerID:c.offerID,quantity:c.quantity,asin:c.asin},success:function(c){delete b.buyingDeals[a];d.checkingDealStatus=!1;if(c.success){d.isAddedToCart=!0;d.addActionMessage=gb.resources.getString("gb_item_added_to_cart");amazon.mash.cart.didUpdate({newCartQuantity:parseInt(c.itemsInCart,10)});if(gb.resources.deviceInfo.isIPad)k.location.href=decodeURIComponent(o);b.refreshDealView(a);gb.resources.deviceInfo.isAndroid&&amazon.mash.showAlert({message:gb.resources.getString("gb_item_added_to_cart"),buttonTitles:[gb.resources.getString("gb_continue_shopping"),gb.resources.getString("gb_go_to_cart")],successCallback:function(a){if(a===1)k.location.href=decodeURIComponent(o)}})}else b._showErrorOnAjaxFail(a)},error:function(){b._showErrorOnAjaxFail(a)}})}else gb.resources.deviceInfo.isApp?(h=gb.utils.setUrlParam(h,"app-action","add-to-cart"),h=gb.utils.setUrlParam(h,"ref",p),h=gb.utils.setUrlParam(h,"asin",c.asin),h=gb.utils.setUrlParam(h,"offer-id",c.offerID),h=gb.utils.setUrlParam(h,"clickstream-tag","Deal"),k.location.href=decodeURIComponent(h),delete b.buyingDeals[a],d.checkingDealStatus=!1,b.refreshDealView(a)):(l=gb.metrics.addMetricsParams(gb.enums.AJAXLinks.ADD_TO_CART,c.widgetID,gb.metrics.refTags.addToCart,[a,v]),i.A.post(l,{params:{offerID:c.offerID,quantity:c.quantity,asin:c.asin},success:function(e){if(e){delete b.buyingDeals[a];d.checkingDealStatus=!1;if(e.success)d.postActionMessage=gb.resources.getString("gb-added-to-cart"),b._updateNavCartQty(e.itemsInCart);else{d.cartError=!0;var g=gb.widgets[c.widgetID],h;if(e.cartItem&&e.cartItem.statusList)h=e.cartItem.statusList;!f.isEmpty(h)&&gb.utils.isOfferingRestrictionViolated(h)?(d.postActionMessage=gb.resources.getString("gb-quantity-restriction-violated",{quantityLimit:e.cartItem.quantityRestriction}),d.isOfferingRestrictionViolated=!0):typeof g.renderErrorMessage==="function"&&g.renderErrorMessage()}b.refreshDealView(a)}},error:function(){delete b.buyingDeals[a];d.checkingDealStatus=!1;d.cartError=!0;var e=gb.widgets[c.widgetID];typeof e.renderErrorMessage==="function"&&e.renderErrorMessage();b.refreshDealView(a)}}))},redemptionResponseHandler:function(c,b,a){var d=c.customerState;if(c.detail.itemType===gb.enums.ItemTypes.VARIATION&&(b=c.getAsinDAO(b)))d=b.status.customerState;d===gb.enums.CustomerStates.INCART?(this._updateNavCartQty(a),n.when("jQuery").execute(function(a){a("#"+gb.enums.ChangeoverID.AddedToCart+c.dealID).show()})):d===gb.enums.CustomerStates.INWAITLIST&&(n.when("jQuery").execute(function(a){a("#"+gb.enums.ChangeoverID.Waitlisted+c.dealID).show()}),typeof gb.controller.pushNotificationInfo==="object"&&!f.isEmpty(gb.controller.pushNotificationInfo)&&gb.notifications.subscribeNotifications())},_registerDealWithNotifier:function(c){if(k.dealNotifier)c.legacyDeal=new GBDealNotifier.Model.Deal(c.dealID),c.legacyDeal._loadStatusFromDealDAO(c),dealNotifier.registerDeal(c.inCartAsin,c.legacyDeal)},watchDeal:function(c,b){var a=this;gb.utils.getWindowLocationOrigin();var d=gb.widgets[c].dealViews[b],e=a.dealDAOs[b],g=i.$("#"+gb.enums.ChangeoverID.Subnav),h;if(e.processWatchAction!==!0)if(gb.service.customerID){e.processWatchAction=!0;f.each(d,function(a){a.render()});var l=gb.enums.WatchDealActions.ADD,p=gb.metrics.refTags.watchDeal;if(a.dealDAOs[b].isDealWatched)l=gb.enums.WatchDealActions.REMOVE,p=gb.metrics.refTags.unWatchDeal;p=gb.metrics.generateRef(c,p,[b]);gb.service.watchDeal(b,l,function(i){e.processWatchAction=!1;a.closeBottomSheet();if(i.status===1)if(l===gb.enums.WatchDealActions.ADD?(e.isDealWatched=!0,h=gb.resources.getString("gb_watching_deal")):(e.isDealWatched=!1,h=gb.resources.getString("gb_stopped_watching")),f.each(d,function(a){a.render()}),gb.metadata.updateWatchedDeals(b),g.length>0&&(g.find("strong").text(h),g.show()),gb.resources.deviceInfo.isAppVersionHigher)e.isDealWatched&&gb.resources.deviceInfo.isPhone&&(gb.notifications.subscribeNotifications(),a.renderWatchDealFirstrun(c));else{if(l===gb.enums.WatchDealActions.ADD){var p=gb.utils.getAppStoreURL();p&&n.when("mash").execute(function(a){a.showAlert({message:gb.resources.getString("gb-reminders-msg-old-app"),buttonTitles:[gb.resources.getString("gb-go-to-app-store"),gb.resources.getString("gb_continue_shopping")],successCallback:function(d){d===0&&a.canLaunchIntentURL({url:p,successCallback:function(d){d&&a.launchIntentURL({url:p})}})}})})}}else throw f.each(d,function(a){a.render()}),Error("Deal Bookmark call to Deal Redemption Service Ajax end point failed");a.refreshDealView(b)},p)}else gb.watchDealService.addWatchedDealOnLoginRedirect(b),e.processWatchAction=!1,f.each(d,function(a){a.render()})},addItemToWishList:function(c){var b=this,a=c.dealID,d=c.asin;gb.resources.customerData.customerId?i.A.post("/gp/mobile/deals/ajax/addToWishList.html?asin="+d,{success:function(c){if(c.isAddedToWishList)b.dealDAOs[a].addActionMessage=gb.resources.getString("gb_added_to_wishlist"),b.dealDAOs[a].isAddedToWishList=!0;else if(c.isDuplicateAdd)b.dealDAOs[a].addActionMessage=gb.resources.getString("gb_already_in_wishlist"),b.dealDAOs[a].isAddedToWishList=!0;else if(c.isAuthError){b.addToWishListOnLoginRedirect(d);return}b.dealDAOs[a].addingToWishList=!1;b.dealDAOs[a].defaultRegistryID=c.defaultRegistryID;b.refreshDealView(a)},error:function(){k.location.href="/gp/registry/wishlist"}}):b.addToWishListOnLoginRedirect(d)},addToWishListOnLoginRedirect:function(c){var b=gb.resources.getUrl("wishlist_login_redirect");k.location.href=b.replace(/%257BdealID%257D/,c)},updateAppliedFilters:function(c){this.schedulingParams[c].enablePagination&&(gb.utils.updateFiltersInAddressBar(c,this.widgetCurrentPage[c],this.widgetCurrentCategory[c],this.widgetCurrentStatus[c]),gb.widgets[c].scrollToWidgetTop())},setPreviouslyAppliedFilters:function(c,b){var a=gb.utils.getHashOfAppliedFilters(b);this.widgetCurrentPage[c]=parseInt(a[gb.enums.CustomerAppliedFilters.PAGE],10);this.widgetCurrentCategory[c]=a[gb.enums.CustomerAppliedFilters.CATEGORY];this.widgetCurrentStatus[c]=a[gb.enums.CustomerAppliedFilters.STATUS]},isPaginatedMetadataCall:function(c){if(gb.configManager.getWidgetViewConfig(c).dcsMetadataVersion===gb.enums.Constants.PAGINATED_METADATA_VERSION||gb.controller.schedulingParams[c].eventID)return!0},setInitialFilters:function(c){this.widgetCurrentPage[c]=this.schedulingParams[c].page;this.widgetCurrentCategory[c]=gb.enums.CategoryFilters.ALL;this.widgetCurrentStatus[c]=gb.enums.StatusFilters.AVAILABLE;if(this.schedulingParams[c].enablePagination){var b=gb.utils.getParamValueFromUrl(k.location.href,gb.enums.BrowserHistory.STATE_KEY+c);b&&this.setPreviouslyAppliedFilters(c,b)}},getShareManager:function(){if(!gb.shareManager)gb.shareManager=new GBShareManager;return gb.shareManager},getBottomSheet:function(){if(this.bottomSheet===null)this.bottomSheet=new BottomSheetView;this.removeWatchDealFirstrun();return this.bottomSheet},closeBottomSheet:function(){this.bottomSheet&&this.bottomSheet.close()},getWatchDealView:function(){if(!this.watchDealView)this.watchDealView=new GBWatchDealView;return this.watchDealView},getWatchDealService:function(){if(!gb.watchDealService)gb.watchDealService=new GBWatchDealService;return gb.watchDealService},renderWatchDealFirstrun:function(c){var b=i.$;if(gb.resources.customerData.isWatchedDealFirstRun&&gb.subnavController.subnavContainer.length){gb.resources.customerData.isWatchedDealFirstRun=!1;var a=function(){var a=gb.templateManager.getWidgetHTML({widgetID:c,templateGroup:gb.templateManager.TemplateGroups.WIDGET_VIEW,templateName:"bottomPopover",data:{message:gb.resources.getString("gb_m_watch_deal_firstrun")}}),e=b(a);gb.subnavController.subnavContainer.after(e);e.slideDown(gb.enums.WatchDealConstants.ANIMATE_DURATION);a=function(){e.slideUp(gb.enums.WatchDealConstants.ANIMATE_DURATION,function(){i.$(this).remove()})};i.A.declarative("gbdeal-close-infobox","click",a);e.bind("gbdeal-close-infobox",a)};gb.resources.deviceInfo.isApp&&gb.resources.deviceInfo.isIPhone&&gb.resources.deviceInfo.isIOSInterstitialSupported?gb.notifications.invokePushNotificationInterstitial(a):a()}},removeWatchDealFirstrun:function(){var c=i.$(".bottomPopover-infobox");c.length>0&&c.trigger("gbdeal-close-infobox")},_handleActions:f.once(function(){var c=this;i.A.declarative("gb-bottomSheet-close","click",function(){c.closeBottomSheet()})}),updatePrimeSignUpURL:function(){var c=i.$(location),b=c.attr("href"),c=c.attr("origin"),b=k.btoa(k.escape(b.replace(c,""))),c=gb.resources.getUrl("prime_signup_redirect"),c=c.replace(c.match(gb.enums.Constants.REDIRECT_URL_REGEX)[1],b),a=gb.resources.getUrl("exclusive_access_prime_signup_redirect"),a=a.replace(a.match(gb.enums.Constants.REDIRECT_URL_REGEX)[1],b),d=gb.resources.getUrl("exclusive_dotd_prime_signup_redirect"),d=d.replace(d.match(gb.enums.Constants.REDIRECT_URL_REGEX)[1],b);gb.resources.registerUrls({prime_signup_redirect:c,exclusive_access_prime_signup_redirect:a,exclusive_dotd_prime_signup_redirect:d})}})});gb.execute(function(i,f){k.GBSubnavController=i.Collection.extend({currentPageNumber:0,isStopPanSwipeDecided:!1,isSubnavPresent:!0,lastScrollTop:{},stopPanSwipe:!1,subnavHiddenHeight:0,subnavPosition:0,subnavUnderlineLeftValue:0,subnavWidth:0,totalPages:0,totalWidth:0,scrollLeftPosition:0,SubnavIDs:{ScrollerPages:"#subnavScrollerPages",SubnavPage:"#gbSubnavPage",ScreenPage:"#subnavAllPages",SubnavWidgetHolder:"#gbSubnavWidgetHeaderHolder",SubnavContainer:"#subnavContainer",SubnavHeading:"#subnavHeading",SubnavHeightDiv:"#subnavContainerHeightDiv",SubnavLink:"#gbSubnavLink",SubnavRefresher:"#subnavPageRefresher",SubnavScroller:"#subnavScroller",SubnavUnderline:"#subnavLinkUnderline",SubnavContainer_NoHash:"subnavContainer",SubnavHeightDiv_NoHash:"subnavContainerHeightDiv",SubnavLink_NoHash:"gbSubnavLink",SubnavPages:".gbSubnavPages"},SubnavClasses:{LinkActive:"subnavLinkActive"},RefTags:{subnavTab:"s",tab:"tab"},Constants:{LEFT:"left",RIGHT:"right",SUBNAV_SELECT:"subnavSelectedPage",SWIPE_ANIMATION_TIME:300,MIN_REDIRECT_DATA:15,SMALL_SPACING:9,REFRESH_DISTANCE:150},initialize:function(c){var b=this;b.initializeFramework();f.each(c,function(a,d){b[d]=a});this.registerPage();this.subnavContainer=i.$(this.SubnavIDs.SubnavContainer);this.subnavHeading=i.$(this.SubnavIDs.SubnavHeading);this.subnavRefresher=i.$(this.SubnavIDs.SubnavRefresher);this.subnavScroller=i.$(this.SubnavIDs.SubnavScroller);this.subnavScrollerPages=i.$(this.SubnavIDs.ScrollerPages);this.screenPage=i.$(this.SubnavIDs.ScreenPage);this.subnavPages=i.$(this.SubnavIDs.SubnavPages);this.subnavUnderline=i.$(this.SubnavIDs.SubnavUnderline);c={domElementID:this.domElementID,widgetName:this.widgetName};this.metrics=new GBSubnavMetrics(c);i.$(k).resize(f.bind(b.resetSubnavWidth,b));i.A.declarative("gbsubnav-linkclick","click",function(a){a=parseInt(a.data.newPageNumber,10);gb.subnavController.subnavLinkClick(a)})},initializeFramework:function(){gb.utils=k.GBUtilities.getInstance();gb.enums=k.GBEnums.getInstance();gb.metrics=gb.metrics||new GBMetrics},registerPage:function(){var c="gbSubnavPage"+this.currentPageNumber;n.now(c).execute(function(b){b===m&&n.register(c,function(){return!0})})},resetSubnavWidth:function(){this.subnavWidth=i.$(k).width();this.subnavScroller.scrollLeft(0);for(var c=0;c<this.totalPages;c++)this.linkLeft[c]=document.getElementById(this.SubnavIDs.SubnavLink_NoHash+c).getBoundingClientRect().left,this.linkRight[c]=document.getElementById(this.SubnavIDs.SubnavLink_NoHash+c).getBoundingClientRect().right;this.scrollLeftPosition=this.currentPageNumber*this.subnavWidth;this.moveSubnavPages(-this.scrollLeftPosition,0);this.animateSubnav(this.currentPageNumber,0);this.subnavUnderline.css(gb.utils.getCSStransitionTime(0));this.subnavUnderline.css(gb.utils.getCSStransformDistance(this.linkLeft[this.currentPageNumber],gb.enums.Constants.X_DIRECTION));this.subnavUnderline.width(this.linkRight[this.currentPageNumber]-this.linkLeft[this.currentPageNumber])},handlePageScroll:function(){var c=i.$(k).scrollTop(),b=this.lastScrollTop[this.currentPageNumber]||0;this.lastScrollTop[this.currentPageNumber]=c;c<b&&!this.isSubnavPresent?this.subnavSlideDown():c>b&&this.isSubnavPresent&&this.subnavSlideUp()},subnavSlideUp:function(){gb.utils.isElementInViewPort(this.SubnavIDs.SubnavHeightDiv_NoHash+this.currentPageNumber)===gb.enums.ViewPortPresence.ABSENT&&this.subnavSlideCompletelyUp()},subnavSlideDown:function(){gb.utils.isElementInViewPort(this.SubnavIDs.SubnavHeightDiv_NoHash+this.currentPageNumber)!==gb.enums.ViewPortPresence.ABSENT&&this.subnavSlideCompletelyDown()},subnavSlideCompletelyDown:function(){this.subnavContainer.css(gb.utils.getCSStransformDistance(0,gb.enums.Constants.Y_DIRECTION));this.subnavHiddenHeight=0;this.isSubnavPresent=!0},subnavSlideCompletelyUp:function(){this.isSubnavPresent=!1;this.subnavHiddenHeight=-this.subnavHeading.height()-this.Constants.SMALL_SPACING;this.subnavContainer.css(gb.utils.getCSStransformDistance(this.subnavHiddenHeight,gb.enums.Constants.Y_DIRECTION))},swipeStart:function(c){this.subnavPages.removeClass("pageScroll");this.touchDeltaY=this.touchDeltaX=0;this.touchStartX=c.originalEvent.touches[0].pageX;this.touchStartY=c.originalEvent.touches[0].pageY},swipePage:function(c){if(!this.stopPanSwipe)this.subnavPages.addClass("pageScroll"),this.touchDeltaX=c.originalEvent.touches[0].pageX-this.touchStartX,this.touchDeltaY=c.originalEvent.touches[0].pageY-this.touchStartY,!this.isStopPanSwipeDecided&&Math.abs(this.touchDeltaX)<=Math.abs(this.touchDeltaY)?this.stopPanSwipe=!0:(this.isStopPanSwipeDecided=!0,this.touchStartX>this.Constants.MIN_REDIRECT_DATA?(c.preventDefault(),c=this.touchDeltaX<0?this.currentPageNumber+1:this.currentPageNumber-1,c<0||c===this.totalPages||(this.moveSubnavPages(this.touchDeltaX-this.scrollLeftPosition,0),c=this.linkLeft[this.currentPageNumber]-(this.linkRight[this.currentPageNumber]-this.linkLeft[this.currentPageNumber])*this.touchDeltaX/this.subnavWidth,this.subnavUnderline.css(gb.utils.getCSStransitionTime(0)),this.subnavUnderline.css(gb.utils.getCSStransformDistance(c,gb.enums.Constants.X_DIRECTION)))):this.stopPanSwipe=!0)},swipeEnd:function(){this.subnavPages.removeClass("pageScroll");this.isStopPanSwipeDecided=!1;if(this.stopPanSwipe)this.stopPanSwipe=!1;else{this.stopPanSwipe=!1;var c=this.touchDeltaX<0?this.currentPageNumber+1:this.currentPageNumber-1;if(!(c<0||c===this.totalPages))this.subnavUnderlineLeftValue-=this.touchDeltaX/this.subnavWidth,Math.abs(this.touchDeltaX)>=this.subnavWidth/4?(this.changeSelectedLink(c),this.animatePages(c,this.currentPageNumber),this.currentPageNumber=c,this.addSubnavPageToURL(c,this.metrics.refTags.swipe)):this.animatePages(this.currentPageNumber,c)}},moveSubnavPages:function(c,b){this.screenPage.css(gb.utils.getCSStransitionTime(b));this.screenPage.css(gb.utils.getCSStransformDistance(c,gb.enums.Constants.X_DIRECTION))},animateSubnav:function(c,b){this.subnavScroller.animate({scrollLeft:(this.linkRight[c]+this.linkLeft[c]-this.subnavWidth)/2},b,"linear")},getSubnavPage:function(c){return i.$(gb.subnavController.SubnavIDs.SubnavPage+c)},pageChangeCallback:function(){this.registerPage();for(var c=0;c<this.totalPages;c++){var b=this.getSubnavPage(c);c!==gb.subnavController.currentPageNumber?b.css({height:gb.subnavController.minPageHeight+"px","overflow-y":"hidden"}):b.css({height:"auto","overflow-y":"auto"})}c=this.lastScrollTop[this.currentPageNumber]||0;i.$(k).scrollTop(c);this.subnavUnderline.width(this.linkRight[this.currentPageNumber]-this.linkLeft[this.currentPageNumber]);gb.utils.isElementInViewPort(this.SubnavIDs.SubnavHeightDiv_NoHash+this.currentPageNumber)===gb.enums.ViewPortPresence.ABSENT?this.subnavSlideCompletelyUp():this.subnavSlideCompletelyDown();gb.controller&&gb.controller.removeWatchDealFirstrun&&gb.controller.removeWatchDealFirstrun()},subnavLinkClick:function(c){if(c!==this.currentPageNumber)this.changeSelectedLink(c),this.animatePages(c,this.currentPageNumber),this.currentPageNumber=c,this.addSubnavPageToURL(c,this.metrics.refTags.tab)},animatePages:function(c){var b=this,a=Math.abs(c-this.subnavUnderlineLeftValue)*b.Constants.SWIPE_ANIMATION_TIME,d=this.linkLeft[c];this.subnavUnderline.css(gb.utils.getCSStransitionTime(a));this.subnavUnderline.css(gb.utils.getCSStransformDistance(d,gb.enums.Constants.X_DIRECTION));i.$(gb.subnavController.SubnavIDs.SubnavWidgetHolder+b.currentPageNumber).hide();i.$(gb.subnavController.SubnavIDs.SubnavWidgetHolder+c).show();this.subnavUnderlineLeftValue=c;this.scrollLeftPosition=c*i.$(k).width();this.moveSubnavPages(-this.scrollLeftPosition,a);gb.utils.setSafeTimeout(function(){b.pageChangeCallback()},a);this.totalPages>3&&this.animateSubnav(c,a)},changeSelectedLink:function(c){i.$(this.SubnavIDs.SubnavLink+this.currentPageNumber).removeClass(gb.subnavController.SubnavClasses.LinkActive);i.$(this.SubnavIDs.SubnavLink+c).addClass(gb.subnavController.SubnavClasses.LinkActive)},addSubnavPageToURL:function(c,b){var a=k.location.href,a=gb.utils.setUrlParam(a,this.Constants.SUBNAV_SELECT,c),a=this.metrics.addMetricsParams(a,this.widgetName,b,[this.RefTags.tab,c]);gb.utils.updateAddressBarUrl(a)},_isSwipeSupported:function(){var c=!0,b=gb.resources.getDeviceInfo(),a;switch(b.operatingSystem){case "Android":try{a=/[^.]*/.exec(b.operatingSystemVersion)[0]}catch(d){break}parseInt(a,10)<5&&(c=!1);break;case "iOS":if(/iPod/.exec(b.userAgent)){c=!1;break}i.$(k).height()<500&&(c=!1)}return c},refreshPage:function(){var c=this.getSubnavPage(this.currentPageNumber);this.subnavRefresher.css({top:"0px"});c.bind("touchmove",this.touchmove);c.bind("touchend",this.touchend);c.bind("touchcancel",this.touchend)},moveRefresher:function(c){gb.subnavController.RefresherY=c.originalEvent.touches[0].pageY-this.touchStartY;gb.subnavController.RefresherY<=0||!this.showRefresher&&Math.abs(c.originalEvent.touches[0].pageX-this.touchStartX)>gb.subnavController.RefresherY?this.unbindTouchEvents():(this.showRefresher=!0,c.preventDefault(),this.subnavRefresher.css({display:"block",top:(gb.subnavController.RefresherY<this.Constants.REFRESH_DISTANCE?gb.subnavController.RefresherY:this.Constants.REFRESH_DISTANCE)+"px"}))},unbindTouchEvents:function(){this.subnavRefresher.css("display","none");gb.subnavController.RefresherY=0;this.showRefresher=!1;var c=this.getSubnavPage(this.currentPageNumber);c.unbind("touchmove",this.touchmove);c.unbind("touchend",this.touchend);c.unbind("touchcancel",this.touchend)},hideRefresher:function(c){if(gb.subnavController.RefresherY>=this.Constants.REFRESH_DISTANCE)c.preventDefault(),c=k.location.href,c=this.metrics.addMetricsParams(c,this.widgetName,this.metrics.refTags.subnavTabRefresh,[this.RefTags.tab,this.currentPageNumber]),gb.utils.updateAddressBarUrl(c),gb.subnavController.widgetsToRefresh&&gb.subnavController.widgetsToRefresh[this.currentPageNumber]&&f.each(gb.subnavController.widgetsToRefresh[this.currentPageNumber],function(b){b.refreshWidget()});this.unbindTouchEvents()},touchmove:function(c){gb.subnavController.moveRefresher(c)},touchend:function(c){gb.subnavController.hideRefresher(c)}})});gb.execute(function(i,f){k.GBFilterController=i.View.extend({filterMetrics:null,filterModelFactory:null,models:{},widgetGroups:{},initialize:function(){this.filterMetrics=new GBFilterMetrics;this.filterModelFactory=new GBFilterModelFactory;this.on("gbfilter:change",this.onFilterChange);this.on("gbfilter:mergeFilters",this.onFilterMerge)},registerFilters:function(c,b,a){a&&(this.models[a]||(this.models[a]=this.filterModelFactory.getFilterModel(b,a)),this.models[a].mergeFilters({schedulingParams:c.schedulingParams,dcsServerResponse:c.dcsServerResponse}),this.widgetGroups[a]=this.widgetGroups[a]||[],this.widgetGroups[a].push(gb.widgets[b]))},getWidgetGroupID:function(c){var b=null,a=c.schedulingParams,d=c.widgetName,c=c.widgetID;a.eventID?b=a.eventID:gb.controller.isPaginatedMetadataCall(c)&&!f.isEmpty(a.filterConfig)&&!a.enforceLimitedDeals&&(b=a.widgetGroupID?a.widgetGroupID:d);return b},onFilterChange:function(c,b){var a=b.widgetID,d=gb.widgets[a],e=d.isEventsWidget(),g=c.getSelectedFilters(e),h=f.clone(g),l=b.data[1]===gb.enums.BinningParams.PAGE.key,i=gb.controller.schedulingParams[a];if(l&&g[gb.enums.BinningParams.PAGE.key]>1)h.dealsPerPage=i.pageSize;var h=this._toURL(h),v=c.get("widgetGroupID"),r=c.redirectURL||k.location.href,r=gb.utils.setUrlParam(r,"gb_f_"+v,h),r=this.filterMetrics.appendFilterMetricParams(r,a,b.context,b.data);if(c.doPageRefresh)d.widgetName===gb.enums.WidgetNames.HERO&&(d.renderWireFrame(),d.renderContent(!0)),this.models[v].doPageRefresh=!1,r=gb.utils.setUrlHash(r,c.widgetGroupAnchor),k.location.href=r;else{gb.utils.updateAddressBarUrl(r,gb.configManager.getWidgetViewConfig(d.widgetID).pushFilteredURL,g);if(!gb.configManager.getWidgetViewConfig(d.widgetID).disableNavigationToTop)h=d.skinDomElement.position().top,k.scrollTo(0,h);gb.configManager.getWidgetViewConfig(d.widgetID).showBottomSheetFilter&&gb.controller.closeBottomSheet();d.showLoading();if(l)this._handlePageChange(a,v);else{i.fetchSinglePage=!1;if(gb.widgetHelper&&gb.widgetHelper.callDataArray[a])i.pageSize=gb.widgetHelper.callDataArray[a][0].dealsPerPage;this._overrideSchedulingParamsFromFilters(g,a,e);delete gb.metadata.sortedDealIDs[a];d={dealsPerPage:gb.configManager.getWidgetViewConfig(a).preFetchGDMDeals,getDealsSize:gb.controller.schedulingParams[a].pageSize};gb.service.fetchDealWithData(a,d,function(a){gb.filterController._updateWidgetGroup(gb.widgets[a].widgetGroupID)})}}gb.controller.updatePrimeSignUpURL()},_handlePageChange:function(c,b){var a=gb.controller.widgetCurrentPage[c],d=gb.controller.schedulingParams[c],e=gb.widgets[c];if(gb.metadata.isCurrentWindowFull(c,a,d.pageSize))gb.filterController._updateWidgetGroup(b);else if(d.fetchSinglePage)gb.controller.fetchPage({page:a},c,!0);else{var g={page:a,dealsPerPage:gb.configManager.getWidgetViewConfig(c).preFetchGDMDeals,getDealsSize:d.pageSize};gb.controller.fetchPage(g,c,!0)}e=a<e.totalPages&&!gb.metadata.isCurrentWindowFull(c,a+1,d.pageSize);g=a>1&&!gb.metadata.isCurrentWindowFull(c,a-1,d.pageSize);d.fetchSinglePage?(e&&gb.controller.fetchPage({page:a+1},c),g&&gb.controller.fetchPage({page:a-1},c)):g||(a=(a-2)*d.pageSize,d=gb.metadata.sortedDealIDs[c].slice(a,a+d.pageSize),d.length&&gb.service.fetchDeals(d,c))},onFilterMerge:function(c){c=c.get("widgetGroupID");f.each(this.widgetGroups[c],function(b){b.renderContent(!0)})},_updateWidgetGroup:function(c){f.each(this.widgetGroups[c],function(b){gb.controller.trigger("WidgetPageUpdate",b.widgetID,!0)})},_overrideSchedulingParamsFromFilters:function(c,b,a){var d=this.models[gb.widgets[b].widgetGroupID],e=gb.controller.schedulingParams[b];f.each(d.attributesList,function(b){var h=null,l=gb.enums.BinningKeyToDCSQueryParamMap[b];if(a)l&&!f.contains(gb.enums.excludeBinningParamsForEvents,b)?e[l]=c[l]:e.extendedFilters[b]=c[b];else{d.filterConfigValuesHash[b]&&!f.contains(d.attributesWithDisabledValues,b)&&(h=d.filterConfigValuesHash[b]);if(b===gb.enums.BinningParams.DISCOUNT.key)l=gb.enums.DCSQueryParams.DISCOUNT_RANGE;else if(b===gb.enums.BinningParams.PRICE.key)l=gb.enums.DCSQueryParams.PRICE_RANGE;l&&(e[l]=c[l]||h)}})},_isDefaultValue:function(c,b){return c===gb.enums.DCSQueryParams.PAGE&&b===1||c===gb.enums.DCSQueryParams.SORT_ORDER&&b===gb.enums.SortOrders.BY_RELEVANCE||!b&&(c===gb.enums.DCSQueryParams.GLOBAL_ELIGIBLE_ONLY||c===gb.enums.DCSQueryParams.PRIME_ELIGIBLE_ONLY)},_toURL:function(c){var b=this,c=f.map(c,function(a,d){var c;a&&d===gb.enums.BinningParams.NEW_RELEASES.key&&(a="Y");if(b._isDefaultValue(d,a))return null;else if(f.isArray(a))if(f.isEmpty(a))return null;else c=f.map(a,encodeURIComponent).join(",");else c=a;return d+":"+encodeURIComponent(encodeURIComponent(c))});return f.compact(c).join(",")}})});n.when("A","jQuery","load").execute(function(i,f){f(k).resize(function(){function c(b){if(f(b).length){var a=f(k).width(),d=f(".gbox-short-ad").width(),c=Math.floor(a/d),a=f(b+" .scheduled-ad").length,g=a*d;a>c&&(g=c*d);f(b).css("width",g);var h=!1;f(b+" .scheduled-ad").each(function(a){a>=c?f(this).hide():(f(this).show(),h=!0)});b=f(b).parent();h?b.children().length===1&&b.append("<hr style='border-top:1px solid #DDDDDD;margin-top:10px;width:95%'>"):b.children().length>1&&b.children().last().remove()}}c("#gbox-ad-row-1\\.0");c("#gbox-ad-row-2\\.0")});f(k).resize()});k.P&&k.P.AUI_BUILD_DATE&&n.when("GoldboxMobile3PAssets").execute(function(){n.register("GoldboxMobileAssets")})})})(function(){var n=window.AmazonUIPageJS||window.P,k=n._namespace||n.attributeErrors;return k?k("GoldboxMobileAssets"):n}(),window);